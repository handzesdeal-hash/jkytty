
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>HANDZES.BET</title>
<meta name="theme-color" content="#07040f"/>
<style>
:root{
  --bg:#050508; --bg2:#070614;
  --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.62);
  --stroke:rgba(255,255,255,.10);
  --purple:#7c3aed; --purple2:#a78bfa; --red:#ef4444; --green:#22c55e; --amber:#f59e0b;
  --shadow:0 18px 60px rgba(0,0,0,.62);
  --shadow2:0 10px 40px rgba(0,0,0,.55);
  --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
  --sans:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;color:var(--text);font-family:var(--sans);
  background:
    radial-gradient(1200px 900px at 18% 12%, rgba(124,58,237,.22), transparent 60%),
    radial-gradient(1200px 900px at 82% 12%, rgba(239,68,68,.14), transparent 60%),
    linear-gradient(180deg, var(--bg), var(--bg2));
  overflow-x:hidden;
}
.glow{filter: drop-shadow(0 0 10px rgba(167,139,250,.35)) drop-shadow(0 0 22px rgba(124,58,237,.18));}
.iconSvg{width:26px;height:26px;vertical-align:-3px;margin-left:0}
.iconPoop{width:22px;height:22px;vertical-align:-5px;margin-left:6px;filter: drop-shadow(0 0 10px rgba(0,0,0,.6));}

@keyframes shake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-4px)} 40%{transform:translateX(4px)} 60%{transform:translateX(-3px)} 80%{transform:translateX(3px)} }
@keyframes pop { 0%{transform:scale(.92)} 60%{transform:scale(1.08)} 100%{transform:scale(1)} }
@keyframes sparkle { 0%{filter:brightness(1)} 50%{filter:brightness(1.6)} 100%{filter:brightness(1)} }
.bombHit{animation: shake .35s ease-in-out}
.gemHit{animation: pop .18s ease-out, sparkle .55s ease-in-out}

.authWrap{min-height:100vh;display:none;align-items:center;justify-content:center;padding:22px;}
.authWrap.show{display:flex;}
.authCard{
  width:min(520px,100%);border-radius:22px;border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.32);box-shadow: var(--shadow);backdrop-filter: blur(14px);overflow:hidden;
}
.authTop{padding:16px;border-bottom:1px solid rgba(255,255,255,.10);display:flex;align-items:center;gap:12px;}
.mark{width:44px;height:44px;border-radius:16px;background:linear-gradient(135deg, rgba(124,58,237,.95), rgba(239,68,68,.88));border:1px solid rgba(255,255,255,.18);box-shadow:0 10px 28px rgba(0,0,0,.55);}
.authTop b{letter-spacing:.22em;font-size:15px;}
.authBody{padding:16px;}
.tabs{display:flex;gap:10px;margin-bottom:12px;}
.tab{flex:1;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:rgba(255,255,255,.86);font-weight:950;cursor:pointer}
.tab.active{background:rgba(124,58,237,.20);border-color:rgba(167,139,250,.22)}
label{font-size:12px;color:var(--muted);font-weight:900;}
input,select{
  width:100%;margin-top:6px;padding:11px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.22);color: rgba(255,255,255,.92);outline:none;font-size:13px;
}
input:focus,select:focus{border-color: rgba(167,139,250,.38);box-shadow:0 0 0 4px rgba(124,58,237,.16)}
.row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
.btn{
  border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.06);color: rgba(255,255,255,.92);
  padding:11px 12px;border-radius:14px;font-weight:950;font-size:13px;cursor:pointer;user-select:none;
}
.btn:hover{background: rgba(255,255,255,.09)}
.btn:active{transform: translateY(1px)}
.btn.purple{background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(167,139,250,.72));border-color:rgba(255,255,255,.16)}
.btn.red{background: linear-gradient(135deg, rgba(239,68,68,.95), rgba(251,113,133,.82));border-color:rgba(255,255,255,.16)}
.btn.green{background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(134,239,172,.78));border-color:rgba(255,255,255,.16)}
.btn:disabled{opacity:.55;cursor:not-allowed}
.small{font-size:12px;color:var(--muted);line-height:1.35;margin-top:10px}

/* =======================
   MINES UPGRADE (right ladder)
   ======================= */

.minesWrap{
  margin-top:14px;
  display:grid;
  grid-template-columns: 520px 1fr;
  gap:14px;
  align-items:start;
}
@media(max-width:980px){
  .minesWrap{ grid-template-columns: 1fr; }
}

#minesGrid{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  #bjDealerCards{ flex-wrap:nowrap; overflow-x:auto; padding-bottom:4px; }
  #bjDealerCards .bjCard{ flex:0 0 auto; }
  gap:10px;
  max-width:520px;
}

.minesRight{
  position:relative;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.28);
  border-radius:18px;
  padding:12px;
  overflow:hidden;
  min-height: 380px;
  box-shadow:0 16px 50px rgba(0,0,0,.45);
}
.minesRight::before{
  content:"";
  position:absolute;
  inset:-40%;
  background:
    radial-gradient(closest-side at 30% 30%, rgba(124,58,237,.22), transparent 60%),
    radial-gradient(closest-side at 70% 20%, rgba(239,68,68,.14), transparent 60%),
    conic-gradient(from 180deg, rgba(167,139,250,.12), transparent, rgba(239,68,68,.10), transparent);
  filter: blur(2px);
  pointer-events:none;
}

.minesRightHd{ position:relative; display:flex; justify-content:space-between; align-items:flex-end; gap:10px; }
.minesRightTitle{
  font-weight:1000;
  letter-spacing:.18em;
  font-size:12px;
  color: rgba(255,255,255,.92);
  text-transform:uppercase;
}
.minesRightSub{
  font-size:12px;
  color: rgba(255,255,255,.60);
  font-weight:900;
}

.minesLadder{
  position:relative;
  margin-top:10px;
  display:flex;
  flex-direction:column-reverse;
  gap:8px;
  max-height: 300px;
  overflow:auto;
  padding-right:6px;
}
.minesLadder::-webkit-scrollbar{ width:8px; }
.minesLadder::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.12); border-radius:999px; }

.minesStep{
  position:relative;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.32);
  backdrop-filter: blur(10px);
}
.minesStep .left{
  display:flex; align-items:center; gap:10px;
  min-width:0;
}
.minesStep .pickNo{
  width:30px; height:30px; border-radius:12px;
  display:flex; align-items:center; justify-content:center;
  font-weight:1000;
  font-size:12px;
  color: rgba(255,255,255,.72);
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
}
.minesStep .mx{
  font-family: var(--sans);
  font-weight:1000;
  letter-spacing:.02em;
  font-size:15px;
  color: rgba(255,255,255,.96);
  white-space:nowrap;
}
.minesStep .sub{
  font-size:11px;
  color: rgba(255,255,255,.55);
  font-weight:900;
  white-space:nowrap;
}

.minesStep.active{
  border-color: rgba(255,255,255,.22);
  background: rgba(255,255,255,.06);
  box-shadow: 0 0 0 4px rgba(255,255,255,.06), 0 18px 55px rgba(0,0,0,.55);
}
.minesStep.active .pickNo{
  color: rgba(255,255,255,.92);
  border-color: rgba(255,255,255,.18);
  background: rgba(255,255,255,.08);
}

@keyframes xJump{
  0%{ transform: translateY(8px) scale(.96); opacity:.0; }
  40%{ opacity:1; }
  100%{ transform: translateY(0) scale(1); opacity:1; }
}
.minesXFloat{
  position:absolute;
  right:14px;
  top:14px;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.55);
  backdrop-filter: blur(12px);
  font-weight:1000;
  font-size:14px;
  color: rgba(255,255,255,.96);
  animation: xJump .22s ease-out;
  box-shadow:0 18px 55px rgba(0,0,0,.55);
  z-index:2;
}
.minesXFloat.bump{ animation: xJump .22s ease-out; }

/* =======================
   MINES CENTER POPUP ‚Äî CLEAN & BALANCED
   ======================= */

.minesCenterPop{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%) scale(.92);
  width:min(280px, 80%);
  padding:14px;
  border-radius:22px;

  /* cleaner glass, less tint */
  background:
    radial-gradient(120% 120% at 30% 20%, rgba(255,255,255,.14), transparent 55%),
    rgba(12,12,18,.78);

  /* ‚úÖ black outline + inner edge */
  border:1px solid rgba(0,0,0,.85);
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,.10),
    0 26px 90px rgba(0,0,0,.75),
    0 0 28px rgba(34,197,94,.18);

  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);

  display:none;
  z-index:50;
  text-align:center;
  pointer-events:none;
}

/* softer glow ring */
.minesCenterPop::before{
  content:"";
  position:absolute;
  inset:-2px;
  border-radius:24px;
  background:
    linear-gradient(135deg,
      rgba(34,197,94,.0),
      rgba(34,197,94,.55),
      rgba(34,197,94,.0)
    );
  filter: blur(10px);
  opacity:.45;
  z-index:0;
}

/* inner panel */
.minesCenterPop .inner{
  position:relative;
  z-index:1;
  border-radius:16px;
  background: rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.14);
  padding:14px 14px 12px;
}

/* label */
.minesCenterPop .label{
  font-size:11px;
  font-weight:900;
  letter-spacing:.18em;
  text-transform:uppercase;
  color: rgba(255,255,255,.70);
  margin-bottom:8px;
}

/* ‚úÖ payout still dominant but smaller */
.minesCenterPop .amt{
  font-family: var(--mono);
  font-weight:1000;
  font-size:34px;
  line-height:1.05;
  color: rgba(255,255,255,.96);
  text-shadow: 0 0 16px rgba(34,197,94,.22);
}

/* multiplier secondary */
.minesCenterPop .mx{
  margin-top:8px;
  font-family: var(--mono);
  font-weight:900;
  font-size:16px;
  color: rgba(34,197,94,.95);
}

/* footer */
.minesCenterPop .sub{
  margin-top:10px;
  font-size:12px;
  font-weight:800;
  color: rgba(255,255,255,.65);
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
}

.minesCenterPop .dot{
  width:8px;
  height:8px;
  border-radius:999px;
  background: rgba(34,197,94,.95);
  box-shadow: 0 0 10px rgba(34,197,94,.45);
}

/* pop animation (calmer) */
@keyframes minesPopIn {
  0%   { opacity:0; transform:translate(-50%,-50%) scale(.86); }
  60%  { opacity:1; transform:translate(-50%,-50%) scale(1.03); }
  100% { opacity:1; transform:translate(-50%,-50%) scale(1); }
}
@keyframes minesPopOut {
  to { opacity:0; transform:translate(-50%,-50%) scale(.96); }
}

.minesCenterPop.show{
  display:block;
  animation: minesPopIn .22s ease-out;
}
.minesCenterPop.hide{
  animation: minesPopOut .18s ease-in forwards;
}

/* lose variant */
.minesCenterPop.lose{
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,.08),
    0 26px 90px rgba(0,0,0,.75),
    0 0 28px rgba(239,68,68,.18);
}
.minesCenterPop.lose::before{
  background:
    linear-gradient(135deg,
      rgba(239,68,68,.0),
      rgba(239,68,68,.55),
      rgba(239,68,68,.0)
    );
}
.minesCenterPop.lose .mx{
  color: rgba(239,68,68,.95);
}
.minesCenterPop.lose .dot{
  background: rgba(239,68,68,.95);
  box-shadow: 0 0 10px rgba(239,68,68,.45);
}

/* =======================
   MINES TILE ICON SIZES
   ======================= */
.minesGemSvg{
  width:34px;
  height:34px;
  filter: drop-shadow(0 0 10px rgba(253,230,138,.35)) drop-shadow(0 0 20px rgba(34,197,94,.12));
}

.minesBombSvg{
  width:34px;
  height:34px;
  filter: drop-shadow(0 0 10px rgba(239,68,68,.45)) drop-shadow(0 0 26px rgba(239,68,68,.20));
}

/* Bomb tile look */
.minesBombTile{
  background: rgba(239,68,68,.14) !important;
  border-color: rgba(239,68,68,.28) !important;
  box-shadow:
    inset 0 0 0 1px rgba(0,0,0,.55),
    0 0 0 4px rgba(239,68,68,.06),
    0 0 24px rgba(239,68,68,.18) !important;
}

/* =======================
   BOMB ICON + EXPLOSION (anchored to tile)
   ======================= */
.bombIcon{
  font-size:30px;line-height:1;display:inline-flex;align-items:center;justify-content:center;
  filter: drop-shadow(0 0 10px rgba(239,68,68,.65)) drop-shadow(0 0 22px rgba(239,68,68,.35));
  animation: bombPulse 0.85s ease-in-out infinite;
}

@keyframes bombPulse{
  0%,100%{ transform: scale(1); filter: drop-shadow(0 0 10px rgba(239,68,68,.55)) drop-shadow(0 0 22px rgba(239,68,68,.30)); }
  50%{ transform: scale(1.06); filter: drop-shadow(0 0 14px rgba(239,68,68,.75)) drop-shadow(0 0 28px rgba(239,68,68,.45)); }
}

/* explosion container anchored to tile */
.boom{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  width:10px;
  height:10px;
  pointer-events:none;
  z-index:10;
}

/* big shockwave ring */
.boom::before{
  content:"";
  position:absolute;
  inset:-52px;
  border-radius:999px;
  background:
    radial-gradient(circle,
      rgba(255,255,255,.30) 0%,
      rgba(239,68,68,.42) 18%,
      rgba(239,68,68,.18) 38%,
      rgba(239,68,68,0) 72%);
  filter: blur(1px);
  animation: boomRing .34s ease-out forwards;
}

@keyframes boomRing{
  0%{ transform:scale(.18); opacity:0; }
  18%{ opacity:1; }
  100%{ transform:scale(1.25); opacity:0; }
}

/* hot core flash */
.boom::after{
  content:"";
  position:absolute;
  inset:-20px;
  border-radius:999px;
  background: radial-gradient(circle, rgba(255,255,255,.55), rgba(239,68,68,.22), rgba(239,68,68,0) 70%);
  animation: boomFlash .22s ease-out forwards;
}
@keyframes boomFlash{
  0%{ transform:scale(.55); opacity:0; }
  30%{ opacity:1; }
  100%{ transform:scale(1.2); opacity:0; }
}

/* sparks */
.spark{
  position:absolute;
  left:50%;
  top:50%;
  width:4px;
  height:16px;
  border-radius:999px;
  transform-origin:50% 100%;
  background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,180,180,.92), rgba(239,68,68,.95), rgba(239,68,68,0));
  filter: drop-shadow(0 0 12px rgba(239,68,68,.55)) drop-shadow(0 0 22px rgba(239,68,68,.25));
  animation: sparkFly .52s ease-out forwards;
}

@keyframes sparkFly{
  0%{ transform: translate(-50%,-50%) rotate(var(--a)) translateY(0) scale(1); opacity:1; }
  100%{ transform: translate(-50%,-50%) rotate(var(--a)) translateY(-74px) scale(.55); opacity:0; }
}

@keyframes sparkDot {
  0%   { transform: translate(0,0) scale(.8); opacity: 0; }
  15%  { opacity: 1; }
  100% { transform: translate(var(--dx), var(--dy)) scale(.1); opacity: 0; }
}
.sparkDot{
  position:absolute;
  left:50%;
  top:50%;
  width:5px;
  height:5px;
  border-radius:999px;
  transform: translate(-50%,-50%);
  background: radial-gradient(circle, rgba(255,255,255,.95) 0%, rgba(239,68,68,.9) 55%, rgba(239,68,68,0) 80%);
  filter: blur(.2px);
  pointer-events:none;
  z-index:6;
  animation: sparkDot .6s ease-out forwards;
}

/* ===== Mines win popup state management ===== */
.minesWinOverlay{
  position:absolute;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:30;
  pointer-events:none;
}
.minesWinOverlay.show{
  display:flex;
  pointer-events:auto;
}

.app{display:none;grid-template-columns:280px 1fr;min-height:100vh;}
.app.show{display:grid;}
@media(max-width:980px){.app{grid-template-columns:1fr}.sidebar{position:sticky;top:0;z-index:50;height:auto}.main{padding-top:10px}}
.mobileNav{display:none;position:sticky;top:10px;z-index:60;margin-bottom:12px;}
.mobileNavInner{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.32);border-radius:16px;padding:12px;box-shadow:0 12px 38px rgba(0,0,0,.35);}
.mobileNav .navBtn{padding:12px 14px;font-size:14px;background:rgba(255,255,255,.05);border:1px solid transparent;}
.mobileNav .navBtn.active{background:rgba(124,58,237,.18);border-color:rgba(167,139,250,.22)}
@media(max-width:900px){
  .sidebar{display:none;}
  .app{grid-template-columns:1fr;}
  .mobileNav{display:block;}
  .bjHandCards{ flex-wrap:nowrap; overflow-x:auto; padding-bottom:4px; }
  .bjHandCards .bjCard{ flex:0 0 auto; }
  .main{padding-top:12px;}
}
.sidebar{
  height:100vh;overflow:auto;padding:14px 12px 16px;border-right:1px solid rgba(255,255,255,.08);
  background: rgba(0,0,0,.30);backdrop-filter: blur(14px);
}
.brand{display:flex;align-items:center;gap:10px;padding:10px 10px 12px;border-radius:16px;border:1px solid rgba(255,255,255,.10);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));box-shadow: var(--shadow2)}
.logo{width:40px;height:40px;border-radius:14px;background:linear-gradient(135deg, rgba(124,58,237,.95), rgba(239,68,68,.88));
  border:1px solid rgba(255,255,255,.18);box-shadow:0 10px 28px rgba(0,0,0,.55)}
.brand b{letter-spacing:.22em;font-weight:1000;}
.brand small{display:block;color:var(--muted);margin-top:2px;font-size:12px;}
.sideTitle{margin-top:12px;padding:10px 10px 6px;color: rgba(255,255,255,.50);font-size:11px;font-weight:950;letter-spacing:.18em;text-transform:uppercase;}
.navBtn{
  width:100%;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:11px 12px;border-radius:16px;border:1px solid transparent;
  background:transparent;color: rgba(255,255,255,.86);cursor:pointer;font-weight:950;font-size:13px;user-select:none;
}
.navBtn:hover{background: rgba(255,255,255,.06)}
.navBtn.active{background: rgba(124,58,237,.18);border-color: rgba(167,139,250,.22)}
.chip{font-family:var(--mono);font-size:11px;padding:4px 9px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.18);color: rgba(255,255,255,.78);white-space:nowrap;}
.chip.ok{border-color: rgba(34,197,94,.22);background: rgba(34,197,94,.10);}
.sideCard{margin-top:10px;border:1px solid rgba(255,255,255,.10);background: rgba(0,0,0,.22);border-radius:18px;padding:12px;box-shadow:0 16px 50px rgba(0,0,0,.45);}
.pill{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:9px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.18);color: rgba(255,255,255,.72);font-size:12px;margin-top:8px;}
.pill:first-child{margin-top:0}
.mono{font-family:var(--mono)}
.muted{color:var(--muted)}
.main{padding:14px 16px 42px;overflow:auto;}
.topbar{
  display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
  border:1px solid rgba(255,255,255,.10);background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
  border-radius:18px;padding:12px;box-shadow: var(--shadow);position:sticky;top:10px;z-index:40;
  /* remove heavy blur (causes moving seam/artifact). keep a subtle solid bg */
  backdrop-filter: none;
  -webkit-backdrop-filter: none;
  background: rgba(0,0,0,.45);
}
.centerBrand{display:flex;align-items:center;gap:12px;margin:0 auto;opacity:.98;}
.mark2{width:26px;height:26px;border-radius:10px;background:linear-gradient(135deg, rgba(124,58,237,.95), rgba(239,68,68,.85));border:1px solid rgba(255,255,255,.18);}
.title{font-weight:1000;letter-spacing:.30em;font-size:18px;}
.walletMid{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background: rgba(0,0,0,.22);font-weight:950;font-size:12.5px;}
.dot{width:8px;height:8px;border-radius:999px;background:var(--purple2);box-shadow:0 0 0 4px rgba(167,139,250,.14);}
.profileBtn{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.20);cursor:pointer;user-select:none;}
.avatar{width:26px;height:26px;border-radius:10px;background:radial-gradient(16px 16px at 30% 30%, rgba(167,139,250,.95), rgba(124,58,237,.55));border:1px solid rgba(255,255,255,.16);}
.levelWrap{margin-top:6px;width:170px}
.levelBar{height:8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.28);overflow:hidden}
.levelFill{height:100%;width:0%;background:linear-gradient(90deg, rgba(124,58,237,.9), rgba(167,139,250,.75));box-shadow:0 0 18px rgba(124,58,237,.25);}
.levelText{font-size:11px;color:var(--muted);margin-top:4px;display:flex;justify-content:space-between}

.section{margin-top:12px;border:1px solid rgba(255,255,255,.10);background: rgba(0,0,0,.16);border-radius:18px;overflow:hidden;box-shadow:0 14px 55px rgba(0,0,0,.45);}
.sectionHd{padding:14px;border-bottom:1px solid rgba(255,255,255,.07);display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap;}
.sectionHd h3{margin:0;font-size:14px;}
.sub{color:var(--muted);font-size:12px;margin-top:4px;line-height:1.35;}
.sectionBd{padding:14px;}
.grid{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;}
@media(max-width:1300px){.grid{grid-template-columns:repeat(4,1fr);}}
@media(max-width:980px){.grid{grid-template-columns:repeat(2,1fr);}}
@media(max-width:520px){.grid{grid-template-columns:1fr;}}
.row{gap:12px;}
@media(max-width:640px){
  .main{padding:12px;}
  .topbar{position:static;border-radius:14px;padding:10px;gap:8px;}
  .centerBrand{flex-direction:column;gap:6px;}
  .centerBrand .title{font-size:16px;letter-spacing:.22em;}
  .walletMid{padding:9px 10px;font-size:12px;}
  .section{margin-top:14px;border-radius:16px;}
  .sectionHd{padding:12px;gap:8px;}
  .sectionHd h3{font-size:14px;}
  .sectionBd{padding:12px;}
  .grid{grid-template-columns:1fr;gap:14px;}
  input, select, button.btn{font-size:14px;}
  .miniPill{font-size:12.5px;}
  .row > [style*="width:220px"], .row > [style*="width:180px"]{width:100%!important;}
}
.tile{border:1px solid rgba(255,255,255,.10);background: rgba(0,0,0,.35);border-radius:18px;overflow:hidden;cursor:pointer;user-select:none;
  transition: transform .08s ease, border-color .15s ease, background .15s ease;box-shadow:0 18px 55px rgba(0,0,0,.50);}
.tile:hover{transform: translateY(-1px);border-color: rgba(255,255,255,.18);background: rgba(0,0,0,.44);}
.tileArt{height:120px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.tileArt::before{content:"";position:absolute;inset:-40%;
  background:
    radial-gradient(closest-side at 30% 30%, rgba(124,58,237,.55), transparent 60%),
    radial-gradient(closest-side at 70% 30%, rgba(239,68,68,.28), transparent 60%),
    conic-gradient(from 180deg, rgba(167,139,250,.24), transparent, rgba(239,68,68,.20), transparent);
  filter: blur(2px);
}
.tileArt span{position:relative;font-size:34px}
.tileBody{padding:12px;}
.tileTitle{font-weight:950;font-size:13px;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.tileDesc{color:var(--muted);font-size:11.5px;margin-top:6px;line-height:1.35;height:32px;overflow:hidden;}
.tileMeta{margin-top:10px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
.tag{display:inline-flex;align-items:center;padding:5px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.05);font-size:11.5px;font-weight:950;white-space:nowrap;}
.tag.open{background: rgba(34,197,94,.10);border-color: rgba(34,197,94,.18);}
.tag.closed{background: rgba(245,158,11,.10);border-color: rgba(245,158,11,.18);}
.tag.settled{background: rgba(239,68,68,.10);border-color: rgba(239,68,68,.18);}
.tag.pending{background: rgba(124,58,237,.12);border-color: rgba(167,139,250,.22);}
.oddsMini{font-family:var(--mono);font-size:11px;color: rgba(255,255,255,.72);}

table{width:100%;border-collapse:collapse;border-radius:16px;border:1px solid rgba(255,255,255,.10);background: rgba(0,0,0,.24);overflow:hidden;}
th,td{padding:9px;border-bottom:1px solid rgba(255,255,255,.08);font-size:12.5px;}
th{color:var(--muted);font-weight:950;letter-spacing:.2px;}
tr:last-child td{border-bottom:none;}

.overlay{position:fixed;inset:0;background: rgba(0,0,0,.62);backdrop-filter: blur(10px);display:none;z-index:999;align-items:center;justify-content:center;padding:18px;}
.overlay.show{display:flex;}
.modal{width:min(920px,100%);border-radius:20px;border:1px solid rgba(255,255,255,.12);background: rgba(5,5,8,.92);box-shadow:0 26px 90px rgba(0,0,0,.75);overflow:hidden;}
.modalHd{padding:14px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;}
.modalHd h4{margin:0;font-size:16px;}
.modalHd p{margin:6px 0 0;color:var(--muted);font-size:12px;line-height:1.35;max-width:70ch;}
.closeBtn{border:1px solid rgba(255,255,255,.14);background: rgba(255,255,255,.06);color:rgba(255,255,255,.90);width:40px;height:40px;border-radius:14px;cursor:pointer;font-weight:950;}
.closeBtn:hover{background: rgba(255,255,255,.10);}
.modalBd{padding:14px;}
.oddsGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px;}
@media(max-width:760px){.oddsGrid{grid-template-columns:1fr;}}
.oddBtn{border:1px solid rgba(255,255,255,.12);background: rgba(0,0,0,.50);border-radius:18px;padding:14px;cursor:pointer;display:flex;flex-direction:column;justify-content:space-between;min-height:86px;user-select:none;
  transition: transform .08s ease, background .15s ease, border-color .15s ease;}
.oddBtn:hover{background: rgba(0,0,0,.62);border-color: rgba(255,255,255,.18);}
.oddBtn:active{transform: translateY(1px);}
.oddBtn.selected{outline:2px solid rgba(167,139,250,.55);box-shadow:0 0 0 4px rgba(124,58,237,.18);}
.oddName{font-weight:950;font-size:15px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.oddCoef{font-family:var(--mono);font-size:20px;font-weight:950;color: var(--purple2);}
.oddBtn.g .oddCoef{color: rgba(34,197,94,.95);}
.oddBtn.r .oddCoef{color: rgba(239,68,68,.95);}
.modalRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,.08);}
.miniPill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background: rgba(0,0,0,.20);color: rgba(255,255,255,.74);font-size:12px;white-space:nowrap;}
.miniPill input{width:130px;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background: rgba(0,0,0,.26);color:rgba(255,255,255,.92);outline:none;font-size:12px;margin:0;}
.miniPill input:focus{border-color: rgba(167,139,250,.38);box-shadow:0 0 0 4px rgba(124,58,237,.16);}

/* case */
.caseBox{border:1px solid rgba(255,255,255,.10);background: rgba(0,0,0,.28);border-radius:18px;padding:12px;}
.caseStage{position:relative;height:140px;border-radius:16px;border:1px solid rgba(255,255,255,.10);background:
  radial-gradient(650px 260px at 20% 30%, rgba(124,58,237,.32), transparent 60%),
  radial-gradient(650px 260px at 80% 30%, rgba(239,68,68,.18), transparent 60%),
  rgba(0,0,0,.38);overflow:hidden;}
.caseLine{position:absolute;top:0;bottom:0;left:50%;width:2px;transform:translateX(-1px);
  background:linear-gradient(180deg, transparent, rgba(255,255,255,.7), transparent);filter:drop-shadow(0 0 14px rgba(255,255,255,.18));pointer-events:none;}
.caseTrack{position:absolute;top:50%;left:0;transform:translateY(-50%);display:flex;gap:14px;align-items:center;will-change:transform;padding:0 20px;}
.caseItem{width:120px;height:80px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background: rgba(0,0,0,.55);
  display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 18px 55px rgba(0,0,0,.55);user-select:none;}
.caseItem .amt{font-family:var(--mono);font-weight:950;}
.caseItem .lbl{font-size:11px;color:var(--muted);margin-top:2px;}
.probList{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;}
@media(max-width:760px){.probList{grid-template-columns:1fr;}}
.prob{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background: rgba(0,0,0,.22);font-size:12px;}

.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;padding:10px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.62);box-shadow: var(--shadow);backdrop-filter: blur(12px);display:none;max-width:calc(100% - 24px);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:12.5px;z-index:1000;}
.toast.show{display:block;}

/* =======================
   BLACKJACK (Shuffle-style)
   ======================= */

.bjWrap{
  display:grid;
  grid-template-columns: 300px 1fr;
  gap:18px;
  align-items:stretch;
}
@media(max-width:980px){
  .bjWrap{ grid-template-columns:1fr; }
}

.bjLeft{
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.22);
  border-radius:18px;
  padding:12px;
  box-shadow:0 16px 50px rgba(0,0,0,.45);
  position:relative;
  overflow:hidden;
}
.bjLeft::before{
  content:"";
  position:absolute; inset:-40%;
  background:
    radial-gradient(closest-side at 25% 20%, rgba(124,58,237,.22), transparent 60%),
    radial-gradient(closest-side at 75% 30%, rgba(239,68,68,.12), transparent 60%),
    conic-gradient(from 180deg, rgba(167,139,250,.12), transparent, rgba(239,68,68,.08), transparent);
  filter: blur(2px);
  pointer-events:none;
}

.bjBlock{
  position:relative;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.28);
  border-radius:16px;
  padding:12px;
  margin-top:10px;
  overflow:hidden;
}
.bjBlock:first-child{ margin-top:0; }

.bjTitle{
  font-weight:1000;
  letter-spacing:.18em;
  font-size:11px;
  text-transform:uppercase;
  color: rgba(255,255,255,.78);
  margin-bottom:10px;
}
.bjRow{
  display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;
}
.bjRow .miniPill{ margin-top:0; }

.bjSeg{
  display:flex; gap:10px;
}
.bjSeg .tab{ padding:10px 12px; border-radius:14px; }
.bjSeg .tab.active{ background:rgba(124,58,237,.22); border-color:rgba(167,139,250,.25); }

.bjBtnGrid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
  margin-top:10px;
}
.bjBtn{
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.92);
  padding:12px 12px;
  border-radius:16px;
  font-weight:1000;
  cursor:pointer;
  user-select:none;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  box-shadow:0 16px 50px rgba(0,0,0,.30);
}
.bjBtn:hover{ background: rgba(255,255,255,.09); }
.bjBtn:active{ transform: translateY(1px); }
.bjBtn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }
/* availability pulses (outline only) */
.bjBtn.bjPulseDouble{
  border-color: rgba(234,179,8,.75);
  background: linear-gradient(145deg, rgba(234,179,8,.20), rgba(124,58,237,.22));
  box-shadow:
    0 0 0 3px rgba(234,179,8,.18),
    0 12px 40px rgba(0,0,0,.32),
    inset 0 1px 0 rgba(255,255,255,.14);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  animation: bjPulseDouble 1.5s ease-in-out infinite;
}
.bjBtn.bjPulseSplit{
  border-color: rgba(59,130,246,.75);
  background: linear-gradient(145deg, rgba(59,130,246,.20), rgba(124,58,237,.22));
  box-shadow:
    0 0 0 3px rgba(59,130,246,.18),
    0 12px 40px rgba(0,0,0,.32),
    inset 0 1px 0 rgba(255,255,255,.14);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  animation: bjPulseSplit 1.5s ease-in-out infinite;
}

@keyframes bjPulseDouble{
  0%,100%{
    box-shadow:
      0 0 0 3px rgba(234,179,8,.18),
      0 12px 40px rgba(0,0,0,.32),
      inset 0 1px 0 rgba(255,255,255,.14);
  }
  50%{
    box-shadow:
      0 0 0 6px rgba(234,179,8,.26),
      0 14px 46px rgba(0,0,0,.36),
      inset 0 1px 0 rgba(255,255,255,.16);
  }
}
@keyframes bjPulseSplit{
  0%,100%{
    box-shadow:
      0 0 0 3px rgba(59,130,246,.18),
      0 12px 40px rgba(0,0,0,.32),
      inset 0 1px 0 rgba(255,255,255,.14);
  }
  50%{
    box-shadow:
      0 0 0 6px rgba(59,130,246,.26),
      0 14px 46px rgba(0,0,0,.36),
      inset 0 1px 0 rgba(255,255,255,.16);
  }
}

.bjBtn.red{
  background: linear-gradient(135deg, rgba(239,68,68,.95), rgba(251,113,133,.82));
  border-color: rgba(255,255,255,.16);
}
.bjBtn.purple{
  background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(167,139,250,.72));
  border-color: rgba(255,255,255,.16);
}
.bjBtn.green{
  background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(134,239,172,.78));
  border-color: rgba(255,255,255,.16);
}

.bjActionMobile{display:none;gap:10px;margin-top:12px;}
.bjActionMobile .bjBtn{width:100%;justify-content:center;font-size:14px;padding:12px 12px;}
.bjActionMobile .full{grid-column: span 2;}
.bjActionMobile .barLabel{grid-column: span 2;font-size:11px;color:rgba(255,255,255,.65);letter-spacing:.16em;font-weight:900;text-transform:uppercase;}
.bjActionMobile .bjBetRow{grid-column: span 2;display:grid;grid-template-columns:1.2fr 1fr 1fr auto;gap:8px;align-items:end;}
.bjActionMobile .bjBetRow label{font-size:11px;color:var(--muted);font-weight:900;letter-spacing:.04em;display:block;margin-bottom:4px;}
.bjActionMobile .bjBetRow input{width:100%;padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.26);color:rgba(255,255,255,.92);font-size:13px;}
.bjActionMobile .bjBetRow .bjBtn{padding:11px 12px;min-width:92px;}
@media(max-width:700px){
  #bjHomeBtnM{display:inline-flex;align-items:center;gap:6px;padding:9px 12px;border-radius:12px;font-size:12px;}
}
@media(max-width:700px){
  .bjActionMobile{display:grid;grid-template-columns:repeat(2,1fr);}
  .bjActionMobile .bjBtn{border-radius:14px;}
  .bjLeft .bjBlock:nth-child(1),
  .bjLeft .bjBlock:nth-child(2){display:none;}
  body.bjMobileFocus .topbar{display:none;}
  body.bjMobileFocus .mobileNav{display:none;}
  body.bjMobileFocus .main{padding:8px;}
  body.bjMobileFocus #view-blackjack{margin-top:0;}
}

.bjStage{
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.16);
  border-radius:18px;
  box-shadow:0 14px 55px rgba(0,0,0,.45);
  overflow:hidden;
  position:relative;
  min-height: 560px;
}
.bjStage::before{
  content:"";
  position:absolute;
  inset:-40%;
  background:
    radial-gradient(closest-side at 25% 25%, rgba(124,58,237,.18), transparent 60%),
    radial-gradient(closest-side at 75% 25%, rgba(239,68,68,.10), transparent 60%),
    conic-gradient(from 180deg, rgba(167,139,250,.08), transparent, rgba(239,68,68,.06), transparent);
  filter: blur(2px);
  pointer-events:none;
}

.bjTopInfo{
  position:relative;
  display:flex;
  justify-content:center;
  gap:10px;
  padding:12px;
  border-bottom:1px solid rgba(255,255,255,.08);
}
.bjChip{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.32);
  color: rgba(255,255,255,.88);
  font-weight:1000;
  box-shadow:0 18px 55px rgba(0,0,0,.55);
}
.bjChip .mono{ font-weight:1000; }

.bjArea{
  position:relative;
  padding:20px;
}
.bjLane{
  position:relative;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  gap:18px;
  min-height: 220px; /* keep dealer/player zones equal height */
}
.bjLaneTitle{
  position:absolute;
  left:14px;
  top:14px;
  font-weight:1000;
  letter-spacing:.16em;
  text-transform:uppercase;
  font-size:11px;
  color: rgba(255,255,255,.58);
}
.bjLaneInner{
  margin-top:52px; /* drop cards lower so score pills stay visible */
  display:flex;
  justify-content:center;
  flex-wrap:wrap;
  gap:14px;
  align-items:flex-start;
  min-height: 160px; /* consistent card bed for both lanes */
}

/* Hide legacy player pill number (per-hand meta now shows totals) */
#bjPlayerPill{ display:none; }

#bjPlayerCards{
  display:flex;
  flex-direction:row;
  flex-wrap:wrap;
  align-items:flex-start;
  justify-content:center;
  gap:14px 28px; /* spread hands horizontally before stacking */
}

/* auto-scale player cards when many split hands */
#bjPlayerCards[data-hands="3"] .bjHandCards .bjCard{ transform: scale(.92); transform-origin: top center; }
#bjPlayerCards[data-hands="4"] .bjHandCards .bjCard{ transform: scale(.86); transform-origin: top center; }
#bjPlayerCards[data-hands="5"],
#bjPlayerCards[data-hands="6"],
#bjPlayerCards[data-hands="7"] .bjHandCards .bjCard{ transform: scale(.80); transform-origin: top center; }

.bjHandRow{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
  min-width: 300px;
  flex: 1 1 46%;
  max-width: 48%;
  position:relative;
  transition: transform 220ms ease, opacity 180ms ease;
  background: rgba(255,255,255,.02);
  border-radius:14px;
  padding:6px 6px 8px;
}
.bjHandRow::before{
  content: attr(data-hand);
  position:absolute;
  left:-22px;
  top:50%;
  transform:translateY(-50%);
  font-size:11px;
  font-weight:1000;
  color:rgba(255,255,255,.50);
}
.bjHandRow.active{
  transform: translateY(2px) scale(1.02);
  opacity:1;
  box-shadow: 0 0 0 2px rgba(124,58,237,.28), 0 10px 28px rgba(0,0,0,.35);
}
.bjHandRow:not(.active){
  opacity:.75;
}

.bjHandRow.active .bjCard{ opacity:1; filter:none; }
.bjHandRow:not(.active) .bjCard{ opacity:.6; filter:saturate(.65); }
.bjHandRow.active .bjHandMeta{ border-color: rgba(124,58,237,.35); background: rgba(124,58,237,.08); }
.bjHandRow:not(.active) .bjHandMeta{ opacity:.8; }

.bjHandCards{
  display:flex;
  justify-content:center;
  gap:14px;
  flex-wrap:nowrap;
}

@media(max-width:1100px){
  #bjPlayerCards{ justify-content:center; }
  .bjHandRow{ flex: 1 1 100%; max-width:100%; }
}

@media(max-width:640px){
  .bjArea{ padding:12px; }
  .bjStage{ min-height: 500px; }
  .bjLane{ gap:10px; min-height: 170px; }
  .bjLaneInner{ margin-top:36px; gap:8px; min-height:120px; }
  #bjPlayerCards{ gap:10px; }
  .bjHandRow{ min-width:210px; flex: 1 1 100%; max-width:100%; padding:6px 6px 10px; }
  .bjHandRow::before{ left:-16px; font-size:10px; }
  .bjHandMeta{ font-size:11px; padding:6px 9px; text-align:center; }
  .bjHandCards{ gap:8px; flex-wrap:wrap; }
  .bjDeck{ width:68px; height:96px; top:6px; right:6px; }
  .bjLaneTitle{ left:10px; top:10px; font-size:10px; }
  .bjScorePill{ top:10px; padding:6px 10px; font-size:13px; }
  .bjBtnGrid{ grid-template-columns:1fr; gap:8px; }
  .bjBtn{ padding:14px 14px; font-size:15px; }
  .bjRow{ gap:8px; }
}

@media(max-width:700px){
  /* extra shrink when multiple hands on mobile to avoid scrolling */
  #bjPlayerCards[data-hands="2"] .bjHandCards .bjCard{ transform: scale(.86); transform-origin: top center; }
  #bjPlayerCards[data-hands="3"] .bjHandCards .bjCard{ transform: scale(.78); transform-origin: top center; }
  #bjPlayerCards[data-hands="4"] .bjHandCards .bjCard{ transform: scale(.72); transform-origin: top center; }
}

.bjHandMeta{
  display:flex;
  align-items:center;
  gap:10px;
  padding:6px 10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.28);
  font-weight:900;
  font-size:12px;
  color: rgba(255,255,255,.82);
}
.bjHandMeta .pill{
  margin:0;
}
.bjScorePill{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  top:12px;
  padding:7px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.35);
  font-weight:1000;
  color: rgba(255,255,255,.92);
  box-shadow:0 18px 55px rgba(0,0,0,.55);
}
.bjDivider{
  height:1px;
  background: rgba(255,255,255,.08);
  margin:10px 0;
}

.bjDeck{
  position:absolute;
  top:14px;
  right:14px;
  width:110px;
  height:150px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  background:
    linear-gradient(135deg, #4b2d7a 0%, #31224f 55%, #1a142f 100%);
  box-shadow:0 20px 45px rgba(0,0,0,.55);
  overflow:hidden;
  z-index:5;

  /* stacked cards illusion */
  box-shadow:
    0 18px 55px rgba(0,0,0,.55),
    6px 6px 0 rgba(255,255,255,.06),
    12px 12px 0 rgba(255,255,255,.035),
    18px 18px 0 rgba(255,255,255,.02),
    0 0 22px rgba(124,58,237,.16);
}

.bjDeck::before{
  content:"";
  position:absolute;
  inset:14px 12px 14px 12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.16);
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.45);
  pointer-events:none;
  background:
    url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='70' height='16'><text x='0' y='12' fill='rgba(255,255,255,0.55)' font-family='Arial' font-size='7' letter-spacing='2'>BET BET BET BET</text></svg>") 0 0 repeat,
    url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='70' height='16'><text x='0' y='12' fill='rgba(255,255,255,0.55)' font-family='Arial' font-size='7' letter-spacing='2'>BET BET BET BET</text></svg>") 35px 8px repeat;
  background-size: 70px 16px, 70px 16px;
}

.bjDeck::after{
  content:"ùëØùíÅ";
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:1000;
  font-size:50px;
  color:rgba(245,240,255,.95);
  text-shadow:0 2px 16px rgba(0,0,0,.35);
  opacity:1;
  font-family: "Cambria Math", "Noto Sans Math", "DejaVu Sans", "Arial Black", sans-serif;
}
.bjDeck.bump{ animation: bjDeckBump .16s ease-out; }
@keyframes bjDeckBump{
  0%{ transform: translateY(0) scale(1); }
  50%{ transform: translateY(-2px) scale(1.03); }
  100%{ transform: translateY(0) scale(1); }
}

/* CARD 3D flip */
.bjCard{
  width:92px; height:132px;
  perspective: 1000px;
  position:relative;
}
.bjCardInner{
  width:100%; height:100%;
  position:relative;
  transform-style:preserve-3d;
  transition: transform .55s cubic-bezier(.2,.8,.2,1);
  will-change: transform;

  /* DEFAULT = BACK SIDE visible */
  transform: rotateY(180deg);
}

/* flipped = FACE visible */
.bjCard.flipped .bjCardInner{ transform: rotateY(0deg); }

.bjFace, .bjBack{
  position:absolute; inset:0;
  border-radius:14px;
  backface-visibility:hidden;
  border:1px solid rgba(0,0,0,.70);
  box-shadow:0 18px 55px rgba(0,0,0,.45);
  overflow:hidden;
}
.bjFace{
  background: rgba(255,255,255,.96);
  display:flex;
  flex-direction:column;
  padding:10px 10px 8px;
  color:#111;
}
.bjRank{
  font-weight:1000;
  font-size:26px;
  line-height:1;
}
.bjSuit{
  font-size:20px;
  margin-top:4px;
}
.bjPip{
  margin-top:auto;
  display:flex;
  justify-content:flex-end;
  font-weight:1000;
  opacity:.85;
}
.bjRed{ color:#b91c1c; }
.bjBlack{ color:#111827; }

.bjBack{
  transform: rotateY(180deg);
  border-color: rgba(255,255,255,.12);
  background:
    linear-gradient(135deg, #4b2d7a 0%, #31224f 55%, #1a142f 100%);
}
.bjBack::before{
  content:"";
  position:absolute; inset:14px 12px 14px 12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.16);
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.45);
  pointer-events:none;
  background:
    url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='70' height='16'><text x='0' y='12' fill='rgba(255,255,255,0.55)' font-family='Arial' font-size='7' letter-spacing='2'>BET BET BET BET</text></svg>") 0 0 repeat,
    url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='70' height='16'><text x='0' y='12' fill='rgba(255,255,255,0.55)' font-family='Arial' font-size='7' letter-spacing='2'>BET BET BET BET</text></svg>") 35px 8px repeat;
  background-size: 70px 16px, 70px 16px;
}
.bjBack::after{
  content:"ùëØùíÅ";
  position:absolute; inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:1000;
  font-size:42px;
  color:rgba(245,240,255,.95);
  text-shadow:0 2px 16px rgba(0,0,0,.35);
  font-family: "Cambria Math", "Noto Sans Math", "DejaVu Sans", "Arial Black", sans-serif;
}

/* Wind trail effect while dealing */
.bjTrail{
  position:absolute;
  inset:-10px;
  border-radius:18px;
  pointer-events:none;
  opacity:0;
  background:
    radial-gradient(closest-side at 30% 40%, rgba(255,255,255,.18), transparent 70%),
    radial-gradient(closest-side at 60% 60%, rgba(167,139,250,.18), transparent 70%);
  filter: blur(6px);
}
.bjCard.dealing .bjTrail{
  opacity:1;
  animation: bjTrailFade .28s ease-out forwards;
}
@keyframes bjTrailFade{
  from{ opacity:.9; transform: scale(1); }
  to{ opacity:0; transform: scale(1.08); }
}

/* Winner/Loser outlines */
.bjWin .bjFace, .bjWin .bjBack{
  box-shadow:0 0 0 6px rgba(34,255,94,.85), 0 0 16px 6px rgba(34,255,94,.35), 0 18px 55px rgba(0,0,0,.45);
}
.bjLose .bjFace, .bjLose .bjBack{
  box-shadow:0 0 0 6px rgba(255,68,68,.85), 0 0 16px 6px rgba(255,68,68,.35), 0 18px 55px rgba(0,0,0,.45);
}
.bjPush .bjFace, .bjPush .bjBack{
  box-shadow:0 0 0 6px rgba(245,158,11,.85), 0 0 16px 6px rgba(245,158,11,.35), 0 18px 55px rgba(0,0,0,.45);
}

/* Mines-style popup reused for BJ */
.bjCenterPop{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%) scale(.92);
  width:min(320px, 86%);
  padding:14px;
  border-radius:22px;
  background:
    radial-gradient(120% 120% at 30% 20%, rgba(255,255,255,.14), transparent 55%),
    rgba(12,12,18,.78);
  border:1px solid rgba(0,0,0,.85);
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,.10),
    0 26px 90px rgba(0,0,0,.75),
    0 0 28px rgba(34,197,94,.18);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  display:none;
  z-index:60;
  text-align:center;
  pointer-events:none;
}
.bjCenterPop::before{
  content:"";
  position:absolute;
  inset:-2px;
  border-radius:24px;
  background:
    linear-gradient(135deg,
      rgba(34,197,94,.0),
      rgba(34,197,94,.55),
      rgba(34,197,94,.0)
    );
  filter: blur(10px);
  opacity:.45;
  z-index:0;
}
.bjCenterPop .inner{
  position:relative;
  z-index:1;
  border-radius:16px;
  background: rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.14);
  padding:14px 14px 12px;
}
.bjCenterPop .label{
  font-size:11px;
  font-weight:900;
  letter-spacing:.18em;
  text-transform:uppercase;
  color: rgba(255,255,255,.70);
  margin-bottom:8px;
}
.bjCenterPop .amt{
  font-family: var(--mono);
  font-weight:1000;
  font-size:34px;
  line-height:1.05;
  color: rgba(255,255,255,.96);
}
.bjCenterPop .sub{
  margin-top:10px;
  font-size:12px;
  font-weight:800;
  color: rgba(255,255,255,.65);
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
}
.bjCenterPop .dot{
  width:8px;
  height:8px;
  border-radius:999px;
  background: rgba(34,197,94,.95);
  box-shadow: 0 0 10px rgba(34,197,94,.45);
}
.bjCenterPop.lose{
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,.08),
    0 26px 90px rgba(0,0,0,.75),
    0 0 28px rgba(239,68,68,.18);
}
.bjCenterPop.push{
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,.08),
    0 26px 90px rgba(0,0,0,.75),
    0 0 28px rgba(245,158,11,.22);
}
.bjCenterPop.lose::before{
  background:
    linear-gradient(135deg,
      rgba(239,68,68,.0),
      rgba(239,68,68,.55),
      rgba(239,68,68,.0)
    );
}
.bjCenterPop.push::before{
  background:
    linear-gradient(135deg,
      rgba(245,158,11,.0),
      rgba(245,158,11,.55),
      rgba(245,158,11,.0)
    );
}
.bjCenterPop.lose .dot{
  background: rgba(239,68,68,.95);
  box-shadow: 0 0 10px rgba(239,68,68,.45);
}
.bjCenterPop.push .dot{
  background: rgba(245,158,11,.95);
  box-shadow: 0 0 10px rgba(245,158,11,.45);
}
@keyframes bjPopIn{
  0%   { opacity:0; transform:translate(-50%,-50%) scale(.86); }
  60%  { opacity:1; transform:translate(-50%,-50%) scale(1.03); }
  100% { opacity:1; transform:translate(-50%,-50%) scale(1); }
}
@keyframes bjPopOut{
  to { opacity:0; transform:translate(-50%,-50%) scale(.96); }
}
.bjCenterPop.show{ display:block; animation: bjPopIn .22s ease-out; }
.bjCenterPop.hide{ animation: bjPopOut .18s ease-in forwards; }

/* Make BJ area like Mines (not full stretched) */
#view-blackjack .sectionBd{
  max-width: 1180px;
  margin: 0 auto;
}
.bjWrap{
  max-width: 1180px;
  margin: 0 auto;
}
.bjStage{
  min-height: 560px;
}
</style>
</head>
<body>

<!-- SVG ICONS -->
<svg width="0" height="0" style="position:absolute">
  <defs>
    <linearGradient id="gYellow" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#fde68a"/><stop offset="1" stop-color="#f59e0b"/>
    </linearGradient>
    <linearGradient id="gBlue" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#93c5fd"/><stop offset="1" stop-color="#2563eb"/>
    </linearGradient>
    <filter id="fGlow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur stdDeviation="2.6" result="b"/>
      <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
  </defs>
</svg>

<section class="authWrap" id="authWrap">
  <div class="authCard">
    <div class="authTop">
      <div class="mark"></div>
      <div><b>HANDZES.BET</b></div>
    </div>
    <div class="authBody">
      <div class="tabs">
        <button class="tab active" id="tabSignIn">Sign in</button>
        <button class="tab" id="tabSignUp">Sign up</button>
      </div>

      <div id="signInBox">
        <label>Email</label>
        <input id="inEmail" type="email" placeholder="Email" />
        <div style="height:10px"></div>
        <label>Password</label>
        <input id="inPass" type="password" placeholder="Password" />
        <div class="row">
          <button class="btn purple" id="btnSignIn" style="flex:1;">Sign in</button>
          <button class="btn" id="btnForgot" style="flex:1;">Reset password</button>
        </div>
      </div>

      <div id="signUpBox" style="display:none;">
        <label>Username</label>
        <input id="upName" placeholder="Username" />
        <div style="height:10px"></div>
        <label>Email</label>
        <input id="upEmail" type="email" placeholder="Email" />
        <div style="height:10px"></div>
        <label>Password</label>
        <input id="upPass" type="password" placeholder="Password" />
        <div class="row">
          <button class="btn purple" id="btnSignUp" style="flex:1;">Create account</button>
        </div>
      </div>

      <div class="small" id="setupHint" style="display:none;">
        Paste your Supabase URL + anon key in the code first.
      </div>
    </div>
  </div>
</section>

<div class="app" id="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <b>HANDZES.BET</b>
        <small>games ‚Ä¢ sports ‚Ä¢ leaderboard</small>
      </div>
    </div>

    <div class="sideTitle">Menu</div>
    <button class="navBtn active" data-view="home"><span>Home</span><span class="chip" id="chipEvents">0</span></button>
    <button class="navBtn" data-view="games"><span>Games</span><span class="chip" id="chipGames">8</span></button>
    <button class="navBtn" data-view="sports"><span>Sports</span><span class="chip" id="chipSports">0</span></button>
    <button class="navBtn" data-view="leaderboard"><span>Leaderboard</span><span class="chip" id="chipLb">0</span></button>
    <button class="navBtn" data-view="bets"><span>My Bets</span><span class="chip" id="chipMyBets">0</span></button>
    <button class="navBtn" data-view="case"><span>Daily Case</span><span class="chip">üéÅ</span></button>

    <div id="adminNavWrap" style="display:none;">
      <div class="sideTitle">Admin</div>
      <button class="navBtn" data-view="admin"><span>Admin Panel</span><span class="chip ok">ADMIN</span></button>
    </div>

    <div class="sideTitle">Account</div>
    <div class="sideCard">
      <div class="pill"><span class="muted">User</span><span class="mono" id="meName">‚Äî</span></div>
      <div class="pill"><span class="muted">Balance</span><span><span class="mono" id="mePts">0.00</span> <span id="gemSmall"></span></span></div>
      <div class="pill"><span class="muted">Default stake</span>
        <span>
          <input id="defaultStake" type="number" min="0.01" step="0.01" value="0.10"
            style="width:110px;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.26);color:rgba(255,255,255,.92);" />
        </span>
      </div>
    </div>

    <div class="sideTitle">Actions</div>
    <button class="navBtn" id="signOutBtn"><span>Sign out</span><span class="chip">‚Ü©</span></button>
    <button class="navBtn" id="refreshBtn"><span>Refresh</span><span class="chip">R</span></button>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="walletMid"><span class="dot" id="adminDot"></span><span id="adminText">User</span></div>

      <div class="centerBrand">
        <div class="mark2"></div>
        <div class="title">HANDZES.BET</div>
        <div class="walletMid" title="Your balance">
          <span class="mono" id="topPts">0.00</span><span id="gemTop"></span>
        </div>
      </div>

      <div>
        <button class="profileBtn" id="profileBtn">
          <div class="avatar"></div>
          <div style="display:flex;flex-direction:column;line-height:1.1;align-items:flex-start;">
            <span style="font-weight:950;font-size:12.5px;" id="topUser">‚Äî</span>
            <span class="muted" style="font-size:11px;" id="topLevel">Level 1</span>
            <div class="levelWrap">
              <div class="levelBar"><div class="levelFill" id="lvlFill"></div></div>
              <div class="levelText"><span id="lvlProg">0.0/10.0 wager</span><span id="lvlPct">0%</span></div>
            </div>
          </div>
        </button>
      </div>
    </div>

    <div class="mobileNav" aria-label="Mobile navigation">
      <div class="mobileNavInner">
        <button class="navBtn active" data-view="home"><span>Home</span></button>
        <button class="navBtn" data-view="games"><span>Games</span></button>
        <button class="navBtn" data-view="blackjack"><span>Blackjack</span></button>
        <button class="navBtn" data-view="dice"><span>Dice</span></button>
        <button class="navBtn" data-view="roulette"><span>Roulette</span></button>
        <button class="navBtn" data-view="mines"><span>Mines</span></button>
        <button class="navBtn" data-view="sports"><span>Sports</span></button>
        <button class="navBtn" data-view="leaderboard"><span>Leaderboard</span></button>
        <button class="navBtn" data-view="bets"><span>My Bets</span></button>
        <button class="navBtn" data-view="case"><span>Daily Case</span></button>
        <button class="navBtn" data-view="admin" id="mobileAdminNav" style="display:none;"><span>Admin</span></button>
      </div>
    </div>

    <section id="view-home">
      <div class="section">
        <div class="sectionHd">
          <div><h3>HANDZES.BET GAMES</h3><div class="sub">Glowing demo tiles (no stock images).</div></div>
          <div class="chip">Games</div>
        </div>
        <div class="sectionBd"><div class="grid" id="gamesGridHome"></div></div>
      </div>

      <div class="section">
        <div class="sectionHd">
          <div><h3>Sports (your events)</h3><div class="sub">Click an event to bet.</div></div>
          <div class="chip"><span class="mono" id="sportsCountHome">0</span></div>
        </div>
        <div class="sectionBd"><div class="grid" id="sportsGridHome"></div></div>
      </div>
    </section>

    <section id="view-games" style="display:none;">
      <div class="section">
        <div class="sectionHd"><div><h3>Games</h3><div class="sub">Demo gallery.</div></div><div class="chip">8</div></div>
        <div class="sectionBd"><div class="grid" id="gamesGrid"></div></div>
      </div>
    </section>

    <section id="view-dice" style="display:none;">
      <div class="section">
        <div class="sectionHd"><div><h3>Dice</h3><div class="sub">50/50 roll. Win pays 1.95√ó (house edge).</div></div><div class="chip">LIVE</div></div>
        <div class="sectionBd">
          <div class="row" style="align-items:flex-end;">
            <div style="width:220px;">
              <label>Stake</label>
              <input id="diceStake" type="number" min="0.01" step="0.01" value="0.10"/>
            </div>
            <div style="width:220px;">
              <label>Pick</label>
              <select id="dicePick">
                <option value="low">LOW (1-49)</option>
                <option value="high">HIGH (50-100)</option>
              </select>
            </div>
            <button class="btn purple" id="diceRollBtn">Roll</button>
            <div class="miniPill"><span class="muted">Roll</span><span class="mono" id="diceRollOut">‚Äî</span></div>
            <div class="miniPill"><span class="muted">Result</span><span class="mono" id="diceResOut">‚Äî</span></div>
          </div>
        </div>
      </div>
    </section>

    <section id="view-roulette" style="display:none;">
      <div class="section">
        <div class="sectionHd"><div><h3>Roulette</h3><div class="sub">Red/Black pays 1.95√ó. Green pays 14√ó.</div></div><div class="chip">LIVE</div></div>
        <div class="sectionBd">
          <div class="row" style="align-items:flex-end;">
            <div style="width:220px;">
              <label>Stake</label>
              <input id="rouStake" type="number" min="0.01" step="0.01" value="0.10"/>
            </div>
            <div style="width:220px;">
              <label>Bet</label>
              <select id="rouPick">
                <option value="red">RED (1.95√ó)</option>
                <option value="black">BLACK (1.95√ó)</option>
                <option value="green">GREEN (14√ó)</option>
              </select>
            </div>
            <button class="btn purple" id="rouSpinBtn">Spin</button>
            <div class="miniPill"><span class="muted">Spin</span><span class="mono" id="rouOut">‚Äî</span></div>
            <div class="miniPill"><span class="muted">Result</span><span class="mono" id="rouRes">‚Äî</span></div>
          </div>
          <div class="sub" style="margin-top:10px;">Wheel: 0 = green, 1-18 = red, 19-36 = black (simple).</div>
        </div>
      </div>
    </section>

    <section id="view-mines" style="display:none;">
      <div class="section">
        <div class="sectionHd">
          <div><h3>Mines</h3><div class="sub">Pick gems, avoid bombs. Cashout anytime.</div></div>
          <div class="chip">LIVE</div>
        </div>

        <div class="sectionBd">
          <div class="row" style="align-items:flex-end;">
            <div style="width:220px;">
              <label>Stake</label>
              <input id="minesStake" type="number" min="0.01" step="0.01" value="0.10"/>
            </div>

            <div style="width:220px;">
              <label>Bombs</label>
              <select id="minesBombs">
              </select>
            </div>

            <button class="btn purple" id="minesStartBtn">Start</button>
            <button class="btn" id="minesCashBtn" disabled>Cashout</button>

            <div class="miniPill">
              <span class="muted">Current payout</span>
              <span class="mono" id="minesPayoutTop">‚Äî</span>
            </div>

            <div class="miniPill"><span class="muted">Status</span><span class="mono" id="minesStatus">‚Äî</span></div>
          </div>

          <div class="minesWrap">
            <div style="position:relative; max-width:520px;">
              <div id="minesGrid"></div>
              <div class="minesCenterPop" id="minesCenterPop">
                <span class="p" style="left:22px; top:22px;"></span>
                <span class="p" style="right:26px; top:28px;"></span>
                <span class="p" style="left:28px; bottom:22px;"></span>
                <span class="p" style="right:30px; bottom:18px;"></span>

                <div class="inner">
                  <div class="label" id="minesPopLabel">CASHED OUT</div>

                  <!-- ‚úÖ payout biggest -->
                  <div class="amt" id="minesPopAmt">0.00</div>

                  <!-- ‚úÖ multiplier smaller (if you want it) -->
                  <div class="mx" id="minesPopMx">x1.00</div>

                  <div class="sub"><span class="dot"></span><span id="minesPopSub">added to balance</span></div>
                </div>
              </div>
            </div>

            <div class="minesRight">
              <div class="minesRightHd">
                <div class="minesRightTitle">MULTIPLIER</div>
                <div class="minesRightSub"><span id="minesRightBombs">‚Äî</span> bombs ‚Ä¢ <span id="minesRightPicks">0</span> picks</div>
              </div>

              <div class="minesLadder" id="minesLadder"></div>

              <div class="minesXFloat" id="minesXFloat">x1.00</div>
            </div>
          </div>

          <div class="sub" style="margin-top:10px;">25 tiles. Multipliers update every correct pick. Auto cashout when all safe tiles are found.</div>
        </div>
      </div>
    </section>

    <section id="view-sports" style="display:none;">
      <div class="section">
        <div class="sectionHd"><div><h3>Sports</h3><div class="sub">Your created events with coefficients.</div></div><div class="chip"><span class="mono" id="chipSports2">0</span></div></div>
        <div class="sectionBd"><div class="grid" id="eventsGrid"></div></div>
      </div>
    </section>

    <section id="view-leaderboard" style="display:none;">
      <div class="section">
        <div class="sectionHd"><div><h3>Leaderboard</h3><div class="sub">Monthly wager. Top #1 gets +3 when month changes.</div></div><div class="chip"><span class="mono" id="lbMonth">‚Äî</span></div></div>
        <div class="sectionBd">
          <table>
            <thead><tr><th>#</th><th>User</th><th>Wager (this month)</th><th>Level</th></tr></thead>
            <tbody id="lbBody"><tr><td colspan="4" class="muted">Loading‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="view-bets" style="display:none;">
      <div class="section">
        <div class="sectionHd"><div><h3>My Bets</h3><div class="sub">Bets for your account.</div></div><div class="chip"><span class="mono" id="myBetsCount">0</span></div></div>
        <div class="sectionBd">
          <table>
            <thead><tr><th>Time</th><th>Event</th><th>Pick</th><th>Stake</th><th>Coef</th><th>Status</th><th>Payout</th></tr></thead>
            <tbody id="myBetsBody"><tr><td colspan="7" class="muted">No bets yet.</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="view-case" style="display:none;">
      <div class="section">
        <div class="sectionHd">
          <div><h3>Daily Case</h3><div class="sub">Open after you wager 10 (this month). Admin can test anytime.</div></div>
          <div class="chip" id="caseStatus">‚Äî</div>
        </div>
        <div class="sectionBd">
          <div class="caseBox">
            <div class="row" style="justify-content:space-between;align-items:center;margin-top:0;">
              <div class="miniPill"><span class="muted">Next case in</span><span class="mono" id="caseCountdown">‚Äî</span></div>
              <div class="miniPill"><span class="muted">Requirement</span><span class="mono" id="caseReq">0.00 / 10.00</span><span id="gemReq"></span></div>
            </div>
            <div style="height:10px"></div>
            <div class="caseStage">
              <div class="caseLine"></div>
              <div class="caseTrack" id="caseTrack"></div>
            </div>
            <div class="row" style="margin-top:12px;justify-content:space-between;">
              <button class="btn purple" id="openCaseBtn">Open case</button>
            </div>

            <div class="probList">
              <div class="prob"><span>70% ‚Üí win 0.01</span><span class="mono">0.01</span></div>
              <div class="prob"><span>10% ‚Üí win 0.03</span><span class="mono">0.03</span></div>
              <div class="prob"><span>7.5% ‚Üí win 0.05</span><span class="mono">0.05</span></div>
              <div class="prob"><span>2.5% ‚Üí win 0.10</span><span class="mono">0.10</span></div>
              <div class="prob"><span>9% ‚Üí win nothing</span><span class="mono">0.00</span></div>
              <div class="prob"><span>1% ‚Üí win 1.00</span><span class="mono">1.00</span></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="view-admin" style="display:none;">
      <div class="section">
        <div class="sectionHd"><div><h3>Admin Panel</h3><div class="sub">Only the Handzes account can see this.</div></div><div class="chip ok">ADMIN</div></div>
        <div class="sectionBd">
          <div class="section" style="margin-top:0;">
            <div class="sectionHd"><div><h3>Give points</h3><div class="sub">Select a user and set/add points (decimals supported).</div></div></div>
            <div class="sectionBd">
              <label>Registered users</label>
              <select id="userSelect"></select>
              <div class="row">
                <div style="width:180px;">
                  <label>Set points</label>
                  <input id="ptsSet" type="number" step="0.01" value="10.00"/>
                </div>
                <button class="btn purple" id="setPtsBtn">Set</button>
                <div style="width:180px;">
                  <label>Add amount</label>
                  <input id="ptsAdd" type="number" step="0.01" value="0.10"/>
                </div>
                <button class="btn" id="addBtn">Add</button>
              </div>
              <div class="small" id="adminUserHint"></div>
            </div>
          </div>

          <div class="section">
            <div class="sectionHd"><div><h3>Create sports event</h3><div class="sub">2+ options with coefficients.</div></div></div>
            <div class="sectionBd">
              <div class="row">
                <div style="flex:1;min-width:260px;">
                  <label>Event name</label>
                  <input id="evName" placeholder="Race / Match / Player A vs Player B"/>
                </div>
                <div style="width:180px;">
                  <label>Status</label>
                  <select id="evStatus">
                    <option value="open">open</option>
                    <option value="closed">closed</option>
                  </select>
                </div>
              </div>
              <div style="margin-top:10px;">
                <label>Description</label>
                <input id="evDesc" placeholder="Rules, best-of-3‚Ä¶"/>
              </div>
              <div class="row" style="margin-top:10px;align-items:center;">
                <div style="flex:1;">
                  <label>Options</label>
                  <div class="muted" style="font-size:12px;margin-top:4px;">Add 2+ options</div>
                </div>
                <button class="btn" id="addOptBtn">Add option</button>
              </div>
              <div id="optsBox" style="margin-top:10px;"></div>
              <div class="row" style="margin-top:12px;">
                <button class="btn purple" id="createEventBtn">Create</button>
              </div>
              <div id="adminEventsBox" class="small"></div>
            </div>
          </div>

          <div class="section">
            <div class="sectionHd">
              <div><h3>Manage events</h3><div class="sub">Open/Close/Finish, select winner, delete.</div></div>
              <button class="btn" id="reloadAdminEventsBtn">Reload</button>
            </div>
            <div class="sectionBd">
              <div id="adminEventsList" class="small muted">Loading‚Ä¶</div>
            </div>
          </div>

          <div class="section" style="margin-top:14px;">
            <div class="sectionHd">
              <div>
                <h3>SQL (run once)</h3>
                <div class="sub">Run this once in Supabase ‚Üí SQL Editor if you get DB/RLS errors.</div>
              </div>
            </div>
            <div class="sectionBd">
<pre style="margin:0;white-space:pre-wrap;font-family:var(--mono);font-size:12px;color:rgba(255,255,255,.82);">
create extension if not exists pgcrypto;

create table if not exists public.profiles (
  id uuid primary key references auth.users(id) on delete cascade,
  email text unique,
  display_name text,
  avatar_seed text default 'p1',
  pts numeric(14,2) default 10.00,
  lifetime_wager numeric(14,2) default 0,
  month_wager numeric(14,2) default 0,
  month_key text default to_char(now(),'YYYY-MM'),
  level int default 1,
  last_case_open date,
  created_at timestamptz default now()
);

create table if not exists public.events (
  id bigint generated by default as identity primary key,
  name text not null,
  description text default ''::text,
  status text default 'open'::text,
  created_at timestamptz default now(),
  created_by uuid references auth.users(id),
  winner_option_id bigint null
);

create table if not exists public.event_options (
  id bigint generated by default as identity primary key,
  event_id bigint not null references public.events(id) on delete cascade,
  label text not null,
  coef numeric(10,2) not null default 2.00
);

do $$
begin
  alter table public.events
    add constraint events_winner_fk foreign key (winner_option_id)
    references public.event_options(id) on delete set null;
exception when duplicate_object then null;
end $$;

create table if not exists public.bets (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users(id) on delete cascade,
  event_id bigint references public.events(id) on delete cascade,
  option_id bigint references public.event_options(id) on delete cascade,
  event_name text,
  opt_name text,
  stake numeric(14,2),
  coef numeric(10,2),
  status text default 'pending',
  payout numeric(14,2) default 0,
  created_at timestamptz default now()
);

create table if not exists public.app_state (
  id int primary key,
  current_month text,
  last_awarded_month text,
  updated_at timestamptz default now()
);
insert into public.app_state (id, current_month, last_awarded_month)
values (1, to_char(now(),'YYYY-MM'), null)
on conflict (id) do nothing;

alter table public.profiles disable row level security;
alter table public.events disable row level security;
alter table public.event_options disable row level security;
alter table public.bets disable row level security;
alter table public.app_state disable row level security;
</pre>
            </div>
          </div>

        </div>
      </div>
    </section>

    <section id="view-blackjack" style="display:none;">
      <div class="section">
        <div class="sectionHd">
          <div>
            <h3>Blackjack</h3>
            <div class="sub">Shuffle-style UI ‚Ä¢ Flip animation ‚Ä¢ Wind deal ‚Ä¢ Side bets</div>
          </div>
          <div class="chip">LIVE</div>
          <button class="bjBtn" id="bjHomeBtnM" style="display:none;">Home</button>
        </div>

        <div class="sectionBd">
          <div class="bjWrap">

            <!-- LEFT PANEL -->
            <div class="bjLeft">

              <div class="bjBlock">
                <div class="bjTitle">Bet</div>

                <div class="bjRow" style="justify-content:space-between;">
                  <div class="miniPill"><span class="muted">Balance</span><span class="mono" id="bjBal">0.00</span><span id="bjGem"></span></div>
                  <div class="miniPill"><span class="muted">Shoe</span><span class="mono" id="bjShoe">‚Äî</span></div>
                </div>

                <div style="height:10px"></div>

                <label>Standard bet</label>
                <input id="bjStake" type="number" min="0.01" step="0.01" value="0.10"/>

                <div style="height:10px"></div>

                <label>Side bets</label>
                <div class="bjRow" style="align-items:center;">
                  <div style="flex:1; min-width:220px;">
                    <div class="pill" style="margin-top:6px;">
                      <span class="muted">Perfect Pairs</span>
                      <input id="bjSidePairs" type="number" min="0" step="0.01" value="0.00"
                             style="width:120px; margin:0; padding:8px 10px; border-radius:999px;" />
                    </div>
                    <div class="pill">
                      <span class="muted">Bust Out</span>
                      <input id="bjSideBust" type="number" min="0" step="0.01" value="0.00"
                             style="width:120px; margin:0; padding:8px 10px; border-radius:999px;" />
                    </div>
                  </div>
                </div>

                <div class="sub" style="margin-top:10px;">
                  Perfect Pairs pays <b>10√ó</b> if first 2 player cards match rank. Bust Out pays <b>2√ó</b> if dealer busts.
                </div>

                <div class="bjRow" style="margin-top:10px; justify-content:space-between;">
                  <button class="bjBtn purple" id="bjBetBtn" style="flex:1; justify-content:center;">Bet</button>
                </div>
              </div>

              <div class="bjBlock">
                <div class="bjTitle">Actions</div>

                <div class="bjBtnGrid">
                  <button class="bjBtn green" id="bjHitBtn" disabled>
                    <span>Hit</span><span class="chip">üÇ†</span>
                  </button>

                  <button class="bjBtn red" id="bjStandBtn" disabled>
                    <span>Stand</span><span class="chip">‚úã</span>
                  </button>

                  <button class="bjBtn" id="bjSplitBtn" disabled>
                    <span>Split</span><span class="chip">‚áÑ</span>
                  </button>

                  <button class="bjBtn" id="bjDoubleBtn" disabled>
                    <span>Double</span><span class="chip">‚ßâ</span>
                  </button>
                </div>

                <div class="sub" style="margin-top:10px;">
                  Split only available when first two player cards have same rank.
                </div>
              </div>

              <div class="bjBlock">
                <div class="bjTitle">Rules</div>
                <div class="sub">
                  Dealer stands on 17. Blackjack pays 3:2. (Demo logic)
                </div>
              </div>

            </div>

            <!-- RIGHT STAGE -->
            <div class="bjStage" id="bjStage">
              <div class="bjDeck" id="bjDeck" title="Shoe"></div>

              <div class="bjTopInfo">
                <div class="bjChip"><span class="muted">Dealer</span><span class="mono" id="bjDealerScore">‚Äî</span></div>
                <div class="bjChip"><span class="muted">Player</span><span class="mono" id="bjPlayerScore">‚Äî</span></div>
                <div class="bjChip"><span class="muted">Hand</span><span class="mono" id="bjHandNo">1</span></div>
              </div>

              <div class="bjArea">
                <div class="bjLane">
                  <div class="bjLaneTitle">Dealer</div>
                  <div class="bjScorePill" id="bjDealerPill">‚Äî</div>
                  <div class="bjLaneInner" id="bjDealerCards"></div>
                </div>

                <div class="bjDivider"></div>

                <div class="bjLane">
                  <div class="bjLaneTitle">Player</div>
                  <div class="bjScorePill" id="bjPlayerPill">‚Äî</div>
                  <div class="bjLaneInner" id="bjPlayerCards"></div>
                </div>

                <div class="bjCenterPop" id="bjCenterPop">
                  <div class="inner">
                    <div class="label" id="bjPopLabel">WIN</div>
                    <div class="amt" id="bjPopAmt">0.00</div>
                    <div class="sub"><span class="dot" id="bjPopDot"></span><span id="bjPopSub">added to balance</span></div>
                  </div>
                </div>

              </div>

              <div class="bjActionMobile">
                <div class="barLabel">Bet & Side Bets</div>
                <div class="bjBetRow">
                  <div>
                    <label for="bjStakeM">Bet</label>
                    <input id="bjStakeM" type="number" min="0.01" step="0.01" value="0.10" />
                  </div>
                  <div>
                    <label for="bjSidePairsM">Pairs</label>
                    <input id="bjSidePairsM" type="number" min="0" step="0.01" value="0.00" />
                  </div>
                  <div>
                    <label for="bjSideBustM">Bust</label>
                    <input id="bjSideBustM" type="number" min="0" step="0.01" value="0.00" />
                  </div>
                  <button class="bjBtn purple" id="bjBetBtnM">Bet</button>
                </div>
                <button class="bjBtn green" id="bjHitBtnM" disabled><span>Hit</span><span class="chip">üÇ†</span></button>
                <button class="bjBtn red" id="bjStandBtnM" disabled><span>Stand</span><span class="chip">‚úã</span></button>
                <button class="bjBtn" id="bjSplitBtnM" disabled><span>Split</span><span class="chip">‚áÑ</span></button>
                <button class="bjBtn" id="bjDoubleBtnM" disabled><span>Double</span><span class="chip">‚ßâ</span></button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- Event modal -->
<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modalHd">
      <div style="min-width:0;">
        <h4 id="mTitle">Event</h4>
        <p id="mDesc" class="muted"></p>
      </div>
      <button class="closeBtn" id="closeModal">‚úï</button>
    </div>
    <div class="modalBd">
      <div class="row" style="justify-content:space-between;gap:10px;flex-wrap:wrap;">
        <span class="tag" id="mStatus">OPEN</span>
        <span class="miniPill"><span class="muted">Your balance</span><span class="mono" id="mBal">0.00</span><span id="gemBal"></span></span>
      </div>
      <div class="oddsGrid" id="mOdds"></div>
      <div class="modalRow">
        <div class="row" style="gap:10px;">
          <div class="miniPill"><span class="muted">Stake</span><input id="mStake" type="number" min="0.01" step="0.01" value="0.10"/></div>
          <div class="miniPill"><span class="muted">Potential payout</span><span class="mono" id="mPayout">‚Äî</span></div>
        </div>
        <div class="row" style="gap:10px;justify-content:flex-end;">
          <button class="btn" id="mCancel">Cancel</button>
          <button class="btn green" id="mConfirm" disabled>Confirm bet</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Profile modal -->
<div class="overlay" id="profileOverlay">
  <div class="modal" style="width:min(760px,100%);">
    <div class="modalHd">
      <div><h4>Profile</h4><p class="muted">Edit username + picture</p></div>
      <button class="closeBtn" id="closeProfile">‚úï</button>
    </div>
    <div class="modalBd">
      <div class="row" style="gap:10px;align-items:flex-end;">
        <div style="display:flex;align-items:center;gap:12px;">
          <div class="avatar" id="pAvatar" style="width:44px;height:44px;border-radius:16px;"></div>
          <div style="display:flex;flex-direction:column;gap:6px;">
            <label>Username</label>
            <input id="pUserEdit" placeholder="Username" style="width:220px"/>
          </div>
        </div>

        <div class="miniPill"><span class="muted">Balance</span><span class="mono" id="pBal">0.00</span><span id="gemProf"></span></div>
        <div class="miniPill"><span class="muted">Level</span><span class="mono" id="pLevel">1</span></div>
      </div>

      <div style="margin-top:12px;">
        <label>Profile picture</label>
        <div class="row" style="gap:10px;margin-top:6px;">
          <button class="btn" data-ava="p1">Purple</button>
          <button class="btn" data-ava="p2">Red</button>
          <button class="btn" data-ava="p3">Blue</button>
          <button class="btn" data-ava="p4">Green</button>
          <button class="btn" data-ava="p5">Gold</button>
        </div>
        <div class="row" style="justify-content:flex-end;margin-top:10px;">
          <button class="btn purple" id="pSaveBtn">Save profile</button>
        </div>
      </div>

      <div class="section" style="margin-top:12px;">
        <div class="sectionHd"><div><h3>Stats</h3><div class="sub">Calculated from your wagers.</div></div></div>
        <div class="sectionBd">
          <div class="row" style="gap:10px;">
            <div class="miniPill"><span class="muted">Wager (this month)</span><span class="mono" id="pMonthW">0.00</span><span id="gemMW"></span></div>
            <div class="miniPill"><span class="muted">Wager (lifetime)</span><span class="mono" id="pLifeW">0.00</span><span id="gemLW"></span></div>
            <div class="miniPill"><span class="muted">Bets</span><span class="mono" id="pBets">0</span></div>
          </div>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:12px;">
        <button class="btn" id="pCloseBtn">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://jolpzszotsaglwghbyaq.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_H5RpNuvRJu3-HyTiB24RJQ_LzJRe4WA";

const ADMIN_EMAIL = "handzes.deal@gmail.com";
const ADMIN_DISPLAY_NAME = "Handzes";

const $ = (id)=>document.getElementById(id);
const esc = (s)=>String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const to2 = (n)=> (Math.round((Number(n)+Number.EPSILON)*100)/100).toFixed(2);
const clamp2 = (n)=> Math.max(0, Math.round(Number(n)*100)/100);

const toastEl = $("toast");
const toast = (msg)=>{ toastEl.textContent=msg; toastEl.classList.add("show"); clearTimeout(toastEl._t); toastEl._t=setTimeout(()=>toastEl.classList.remove("show"), 2600); };

const gemYellow = () => `<svg class="iconSvg glow" viewBox="0 0 24 24" style="filter:url(#fGlow)"><path fill="url(#gYellow)" d="M12 2 4.2 9.2 12 22l7.8-12.8z"/><path fill="rgba(255,255,255,.35)" d="M12 2 9 9.2h6z"/></svg>`;

// Bigger gem specifically for MINES grid
const gemYellowMines = () => `<svg class="minesGemSvg glow" viewBox="0 0 24 24" style="filter:url(#fGlow)"><path fill="url(#gYellow)" d="M12 2 4.2 9.2 12 22l7.8-12.8z"/><path fill="rgba(255,255,255,.35)" d="M12 2 9 9.2h6z"/></svg>`;

// Custom red glowing bomb (no emoji)
const bombRed = () => `<svg class="minesBombSvg bombPulseSvg" viewBox="0 0 64 64"><defs><radialGradient id="bombCore" cx="35%" cy="30%" r="70%"><stop offset="0" stop-color="rgba(255,255,255,.55)"/><stop offset="0.25" stop-color="rgba(251,113,133,.95)"/><stop offset="1" stop-color="rgba(239,68,68,.95)"/></radialGradient><radialGradient id="bombShadow" cx="35%" cy="35%" r="75%"><stop offset="0" stop-color="rgba(0,0,0,.0)"/><stop offset="1" stop-color="rgba(0,0,0,.65)"/></radialGradient></defs><path d="M44 14c7-6 12-4 14-2" fill="none" stroke="rgba(255,255,255,.75)" stroke-width="4" stroke-linecap="round"/><circle cx="60" cy="11" r="3.5" fill="rgba(255,255,255,.9)"/><circle cx="58.5" cy="9.5" r="2.2" fill="rgba(239,68,68,.95)"/><path d="M32 12c8 0 14 4 14 9v4H18v-4c0-5 6-9 14-9z" fill="rgba(0,0,0,.55)" stroke="rgba(255,255,255,.18)" stroke-width="2" /><circle cx="32" cy="38" r="20" fill="url(#bombCore)" stroke="rgba(0,0,0,.65)" stroke-width="2"/><circle cx="32" cy="38" r="20" fill="url(#bombShadow)" opacity=".55"/><path d="M22 28c3-5 8-8 14-8" fill="none" stroke="rgba(255,255,255,.55)" stroke-width="4" stroke-linecap="round" opacity=".55"/></svg>`;
const gemBlue = () => `<svg class="iconSvg glow" viewBox="0 0 24 24" style="filter:url(#fGlow)"><path fill="url(#gBlue)" d="M12 2 4.2 9.2 12 22l7.8-12.8z"/><path fill="rgba(255,255,255,.35)" d="M12 2 9 9.2h6z"/></svg>`;
const poop = () => `<svg class="iconPoop" viewBox="0 0 24 24"><path fill="#8b5e34" d="M10 3c0 1-1 2-2 2 0 0 1 1 1 2 0 0-2 1-2 3 0 0 2 0 2 2H7c-2 0-3 2-3 4s2 5 8 5 8-2 8-5-1-4-3-4h-2c0-2 2-2 2-2 0-2-2-3-2-3 0-1 1-2 1-2-1 0-2-1-2-2-1 1-1 2-2 2s-1-1-2-2z"/></svg>`;

const AVA = {
  p1: "radial-gradient(16px 16px at 30% 30%, rgba(167,139,250,.98), rgba(124,58,237,.55))",
  p2: "radial-gradient(16px 16px at 30% 30%, rgba(251,113,133,.95), rgba(239,68,68,.55))",
  p3: "radial-gradient(16px 16px at 30% 30%, rgba(147,197,253,.95), rgba(37,99,235,.55))",
  p4: "radial-gradient(16px 16px at 30% 30%, rgba(134,239,172,.95), rgba(34,197,94,.50))",
  p5: "radial-gradient(16px 16px at 30% 30%, rgba(253,230,138,.95), rgba(245,158,11,.55))",
};
function applyAvatar(el, seed){
  const bg = AVA[seed] || AVA.p1;
  el.style.background = bg;
  el.style.boxShadow = "0 10px 28px rgba(0,0,0,.55)";
  el.style.border = "1px solid rgba(255,255,255,.16)";
}

$("gemSmall").innerHTML = gemBlue();
$("gemTop").innerHTML = gemBlue();
$("gemReq").innerHTML = gemBlue();
$("gemBal").innerHTML = gemBlue();
$("gemProf").innerHTML = gemBlue();
$("gemMW").innerHTML = gemBlue();
$("gemLW").innerHTML = gemBlue();

const keysOk = !SUPABASE_URL.includes("PASTE_") && !SUPABASE_ANON_KEY.includes("PASTE_");
$("setupHint").style.display = keysOk ? "none" : "";

const supabase = keysOk ? createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
if(!keysOk){ $("authWrap").classList.add("show"); toast("Paste Supabase keys in index.html"); }

function setAuthTab(which){
  const isIn = which==="in";
  $("tabSignIn").classList.toggle("active", isIn);
  $("tabSignUp").classList.toggle("active", !isIn);
  $("signInBox").style.display = isIn ? "" : "none";
  $("signUpBox").style.display = isIn ? "none" : "";
}
$("tabSignIn").onclick=()=>setAuthTab("in");
$("tabSignUp").onclick=()=>setAuthTab("up");

let session=null, meProfile=null, isAdmin=false, events=[], myBets=[], usersList=[];
// ‚úÖ MP3 cashout sound
const cashoutSound = new Audio("./sounds/cashout.mp3");
cashoutSound.preload = "auto";
cashoutSound.volume = 0.85;

// Browsers require "user gesture" before sound can play.
// This unlocks audio on the first click/tap anywhere.
let __audioUnlocked = false;
function unlockAudioOnce(){
  if(__audioUnlocked) return;
  __audioUnlocked = true;
  try{
    // unlock WebAudio too (for your sfx beeps)
    const ctx = window.__sfxCtx || (window.__sfxCtx = new (window.AudioContext||window.webkitAudioContext)());
    if(ctx && ctx.state === "suspended") ctx.resume();

    // unlock HTMLAudio
    cashoutSound.muted = true;
    cashoutSound.play().then(()=>{
      cashoutSound.pause();
      cashoutSound.currentTime = 0;
      cashoutSound.muted = false;
    }).catch(()=>{
      cashoutSound.muted = false;
    });
  }catch(_){}
}
window.addEventListener("pointerdown", unlockAudioOnce, { once:true });
window.addEventListener("keydown", unlockAudioOnce, { once:true });


function sfx(freq=520, dur=0.06, type="sine", gain=0.04){
  try{
    const ctx = window.__sfxCtx || (window.__sfxCtx = new (window.AudioContext||window.webkitAudioContext)());
    const o=ctx.createOscillator(); const g=ctx.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=gain;
    o.connect(g); g.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime+dur);
  }catch(_){}
}
function sfxBomb(){
  try{
    const ctx = window.__sfxCtx || (window.__sfxCtx = new (window.AudioContext||window.webkitAudioContext)());
    const o=ctx.createOscillator(); const g=ctx.createGain();
    o.type="sawtooth";
    o.frequency.setValueAtTime(220, ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(60, ctx.currentTime+0.18);
    g.gain.setValueAtTime(0.08, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.22);
    o.connect(g); g.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime+0.23);
  }catch(_){}
}
function sfxGem(){
  sfx(880,0.06,"triangle",0.03);
  setTimeout(()=>sfx(1180,0.05,"triangle",0.025), 40);
}

/* ‚úÖ MONEY/CASHOUT SOUND (MP3) */
function sfxCashout(){
  try{
    unlockAudioOnce();            // make sure audio is unlocked
    cashoutSound.currentTime = 0; // replay instantly
    cashoutSound.play();
  }catch(_){}
}


function monthKey(d=new Date()){
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"); return `${y}-${m}`;
}
function todayISO(){
  const d=new Date(); const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), day=String(d.getDate()).padStart(2,"0"); return `${y}-${m}-${day}`;
}
function computeLevel(lifeW){ return 1 + Math.floor(Number(lifeW||0)/10); }

function updateLevelUI(){
  const life = Number(meProfile?.lifetime_wager||0);
  const lvl = computeLevel(life);
  const prog = life % 10;
  const pct = Math.max(0, Math.min(100, (prog/10)*100));
  $("topLevel").textContent = `Level ${lvl}`;
  $("lvlFill").style.width = pct.toFixed(1)+"%";
  $("lvlProg").textContent = `${prog.toFixed(1)}/10.0 wager`;
  $("lvlPct").textContent = `${pct.toFixed(0)}%`;
}

function updateMeUI(){
  $("meName").textContent = meProfile?.display_name || "‚Äî";
  $("topUser").textContent = meProfile?.display_name || "‚Äî";
  $("mePts").textContent = to2(meProfile?.pts||0);
  $("topPts").textContent = to2(meProfile?.pts||0);
  updateLevelUI();
  applyAvatar(document.querySelector(".avatar"), meProfile?.avatar_seed||"p1");
  $("adminDot").style.background = isAdmin ? "var(--green)" : "var(--purple2)";
  $("adminDot").style.boxShadow = isAdmin ? "0 0 0 4px rgba(34,197,94,.14)" : "0 0 0 4px rgba(167,139,250,.14)";
  $("adminText").textContent = isAdmin ? "Admin" : "User";
  $("adminNavWrap").style.display = isAdmin ? "" : "none";
  const mobileAdmin=$("mobileAdminNav");
  if(mobileAdmin) mobileAdmin.style.display = isAdmin ? "" : "none";
}

function setView(v){
  document.querySelectorAll(".navBtn[data-view]").forEach(b=>b.classList.toggle("active", b.dataset.view===v));
  ["home","games","dice","roulette","mines","blackjack","sports","leaderboard","bets","case","admin"].forEach(id=>{
    const el=$("view-"+id); if(el) el.style.display=(id===v)?"":"none";
  });
  const mobile = window.innerWidth<=900;
  if(mobile){
    window.scrollTo({ top: 0, behavior: "smooth" });
  }
  document.body.classList.toggle("bjMobileFocus", mobile && v==="blackjack");
  if(v==="leaderboard") refreshLeaderboard();
  if(v==="admin") { loadUsersList(); loadAdminEvents(); }
  if(v==="case") refreshCaseUI();
  if(v==="blackjack") bjOnViewEnter();
}
document.querySelectorAll(".navBtn[data-view]").forEach(b=>b.onclick=()=>setView(b.dataset.view));

async function ensureProfile(){
  const user=session?.user; if(!user) return;
  const email=(user.email||"").toLowerCase();
  const { data, error } = await supabase.from("profiles").select("*").eq("id", user.id).maybeSingle();
  if(error){ toast("Profile not loaded. Run SQL then Refresh."); console.error(error); return; }
  if(data){ meProfile=data; return; }
  const name = (email===ADMIN_EMAIL.toLowerCase()) ? ADMIN_DISPLAY_NAME : ((user.user_metadata?.display_name) || (email.split("@")[0]||"Player"));
  const curM=monthKey();
  const { data: ins, error: e2 } = await supabase.from("profiles").insert({
    id:user.id, email:user.email, display_name:name, pts:10.00, lifetime_wager:0, month_wager:0, month_key:curM, level:1
  }).select("*").single();
  if(e2){ toast("Profile create failed (DB/RLS)."); console.error(e2); return; }
  meProfile=ins;
}

async function normalizeMonthForMe(){
  if(!meProfile) return;
  const cur=monthKey();
  if((meProfile.month_key||cur)!==cur){
    await supabase.from("profiles").update({ month_key:cur, month_wager:0 }).eq("id", meProfile.id);
    meProfile.month_key=cur; meProfile.month_wager=0;
  }
}

async function maybeRollMonth(){
  const cur = monthKey();
  const { data: st, error } = await supabase.from("app_state").select("*").eq("id", 1).maybeSingle();
  if(error || !st) return;

  const stored = st.current_month || cur;
  if(stored === cur) return;

  const prev = stored;

  const { data: leaders, error: e2 } = await supabase
    .from("profiles")
    .select("id,pts,month_wager")
    .eq("month_key", prev)
    .order("month_wager",{ascending:false})
    .limit(1);

  if(!e2 && leaders && leaders.length){
    const w = leaders[0];
    await supabase.from("profiles").update({ pts: clamp2(Number(w.pts||0)+3) }).eq("id", w.id);
  }

  await supabase.from("profiles").update({ month_wager: 0, month_key: cur });

  await supabase.from("app_state").update({
    current_month: cur,
    last_awarded_month: prev,
    updated_at: new Date().toISOString()
  }).eq("id", 1);
}

async function loadMyBets(){
  const uid=session?.user?.id; if(!uid) return;
  const r = await supabase.from("bets")
    .select("id,created_at,event_name,opt_name,stake,coef,status,payout,event_id,option_id")
    .eq("user_id", uid)
    .order("created_at",{ascending:false})
    .limit(120);

  if(r.error){
    console.error(r.error);
    $("myBetsBody").innerHTML = `<tr><td colspan="7" class="muted">Cannot load bets (DB/RLS).</td></tr>`;
    return;
  }

  myBets = r.data || [];
  $("chipMyBets").textContent=String(myBets.length);
  $("myBetsCount").textContent=String(myBets.length);

  $("myBetsBody").innerHTML = myBets.length ? myBets.map(b=>`
    <tr>
      <td class="mono">${new Date(b.created_at).toLocaleString([], {month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit"})}</td>
      <td>${esc(b.event_name||"")}</td>
      <td>${esc(b.opt_name||"")}</td>
      <td class="mono">${to2(b.stake||0)}</td>
      <td class="mono">${to2(b.coef||0)}</td>
      <td><span class="tag ${String(b.status||"pending")==="pending"?"pending":(String(b.status)==="won"?"open":"settled")}">${String(b.status||"pending").toUpperCase()}</span></td>
      <td class="mono">${Number(b.payout||0)>0 ? to2(b.payout) : "‚Äî"}</td>
    </tr>`).join("") : `<tr><td colspan="7" class="muted">No bets yet.</td></tr>`;
}

async function loadEventOptionsFor(ids){
  if(!ids.length) return new Map();
  const { data, error } = await supabase
    .from("event_options")
    .select("id,event_id,label,coef")
    .in("event_id", ids)
    .order("id", { ascending: true });

  if(error) throw error;
  const map = new Map();
  for(const row of (data||[])){
    if(!map.has(row.event_id)) map.set(row.event_id, []);
    map.get(row.event_id).push({
      id: row.id,
      name: row.label,
      coef: Number(row.coef)
    });
  }
  return map;
}

async function loadEvents(){
  const { data, error } = await supabase
    .from("events")
    .select("id,name,description,status,created_at,created_by,winner_option_id")
    .order("created_at",{ascending:false});

  if(error){ toast("Events load failed (DB/RLS)."); console.error(error); return; }

  const base = data || [];
  const ids = base.map(e=>e.id);

  try{
    const optMap = await loadEventOptionsFor(ids);
    events = base.map(ev => ({ ...ev, options: optMap.get(ev.id) || [] }));
  }catch(e){
    console.error(e);
    events = base.map(ev => ({ ...ev, options: [] }));
  }

  $("chipEvents").textContent=String(events.length);
  $("chipSports").textContent=String(events.length);
  $("chipSports2").textContent=String(events.length);
  $("sportsCountHome").textContent=String(Math.min(6, events.length));
  renderSports();
}

async function addWagerAndPayout(stake, payout){
  if(!meProfile) throw new Error("profile");
  await normalizeMonthForMe();
  stake = Number(stake);
  payout = Number(payout);
  if(!(stake>0)) throw new Error("stake");
  if(Number(meProfile.pts) < stake) throw new Error("balance");
  const newPts = clamp2(Number(meProfile.pts) - stake + payout);
  const newLife = clamp2(Number(meProfile.lifetime_wager||0) + stake);
  const newMonth = clamp2(Number(meProfile.month_wager||0) + stake);
  const newLvl = computeLevel(newLife);
  const { error } = await supabase.from("profiles").update({
    pts:newPts, lifetime_wager:newLife, month_wager:newMonth, month_key:monthKey(), level:newLvl
  }).eq("id", session.user.id);
  if(error) throw error;
  meProfile.pts=newPts; meProfile.lifetime_wager=newLife; meProfile.month_wager=newMonth; meProfile.level=newLvl;
  updateMeUI();
  refreshCaseUI();
  return { newPts, newLvl };
}

function renderSports(){
  const mkTile = (icon, title, desc, tagCls, tagTxt, meta)=>`
    <div class="tileArt"><span>${icon}</span></div>
    <div class="tileBody">
      <p class="tileTitle">${esc(title)}</p>
      <div class="tileDesc">${desc?esc(desc):'<span class="muted">No description</span>'}</div>
      <div class="tileMeta"><span class="tag ${tagCls}">${tagTxt}</span><span class="oddsMini">${esc(meta||"")}</span></div>
    </div>`;

  const grid=$("eventsGrid"); grid.innerHTML="";
  const gridH=$("sportsGridHome"); gridH.innerHTML="";

  if(!events.length){
    grid.innerHTML='<div class="muted">No events yet (Admin creates them).</div>';
    gridH.innerHTML='<div class="muted">No events yet.</div>';
    return;
  }

  events.forEach((ev, idx)=>{
    const tagCls = ev.status==="open" ? "open" : (ev.status==="closed" ? "closed" : "settled");
    const opts = Array.isArray(ev.options)?ev.options:[];
    const mini = opts.length
      ? (opts.slice(0,2).map(o=>`${o.name} ${to2(o.coef)}`).join(" ‚Ä¢ ") + (opts.length>2?" ‚Ä¢ ‚Ä¶":""))
      : "Tap to bet";

    const el=document.createElement("div"); el.className="tile";
    el.innerHTML = mkTile("üèüÔ∏è", ev.name||"Event", ev.description||"", tagCls, String(ev.status||"open").toUpperCase(), mini);
    el.onclick=()=>openEventModal(ev);
    grid.appendChild(el);

    if(idx<6){
      const el2=document.createElement("div"); el2.className="tile";
      el2.innerHTML = mkTile("‚öîÔ∏è", ev.name||"Event", ev.description||"", tagCls, String(ev.status||"open").toUpperCase(), mini);
      el2.onclick=()=>openEventModal(ev);
      gridH.appendChild(el2);
    }
  });
}

function renderGames(){
  const G=[
    {icon:"üé≤",name:"Dice",desc:"Quick roll"},
    {icon:"üí£",name:"Mines",desc:"Pick safe tiles"},
    {icon:"ü™ô",name:"Plinko",desc:"Drop & win"},
    {icon:"üöÄ",name:"Crash",desc:"Cash out"},
    {icon:"üÉè",name:"Blackjack",desc:"Classic 21"},
    {icon:"üé∞",name:"Slots",desc:"Spin reels"},
    {icon:"üéØ",name:"Keno",desc:"Pick numbers"},
    {icon:"üé°",name:"Roulette",desc:"Red / black"},
  ];
  const mk=(g)=>{
    const el=document.createElement("div"); el.className="tile";
    el.innerHTML = `
      <div class="tileArt"><span>${g.icon}</span></div>
      <div class="tileBody">
        <p class="tileTitle">${esc(g.name)}</p>
        <div class="tileDesc">${esc(g.desc)}</div>
        <div class="tileMeta"><span class="tag">GAME</span><span class="oddsMini">Live/soon</span></div>
      </div>`;
    el.onclick=()=>{
      if(g.name==="Dice") setView("dice");
      else if(g.name==="Roulette") setView("roulette");
      else if(g.name==="Mines") setView("mines");
      else if(g.name==="Blackjack") setView("blackjack");
      else toast("Coming soon");
    };
    return el;
  };
  $("gamesGrid").innerHTML=""; $("gamesGridHome").innerHTML="";
  G.forEach(g=>{ $("gamesGrid").appendChild(mk(g)); $("gamesGridHome").appendChild(mk(g)); });
  $("chipGames").textContent=String(G.length);
}

/* EVENT MODAL + CONFIRM */
let currentEvent=null;
let selectedOpt=null;

function openEventModal(ev){
  if(!meProfile){ toast("Profile not loaded (Refresh)."); return; }
  currentEvent=ev; selectedOpt=null;
  $("mConfirm").disabled=true;
  $("mTitle").textContent=ev.name||"Event";
  $("mDesc").textContent=ev.description||"";
  const st=String(ev.status||"open");
  $("mStatus").textContent=st.toUpperCase();
  $("mStatus").className="tag " + (st==="open"?"open":(st==="closed"?"closed":"settled"));
  $("mBal").textContent=to2(meProfile.pts||0);
  $("mStake").value = to2(Number($("defaultStake").value)||0.10);
  renderOdds(ev);
  updatePotential();
  $("overlay").classList.add("show");
}
function closeEventModal(){ $("overlay").classList.remove("show"); currentEvent=null; selectedOpt=null; $("mConfirm").disabled=true; }
$("closeModal").onclick=closeEventModal;
$("mCancel").onclick=closeEventModal;
$("overlay").onclick=(e)=>{ if(e.target===$("overlay")) closeEventModal(); };

function updatePotential(){
  const stake=Number($("mStake").value);
  if(!(stake>0) || !selectedOpt){ $("mPayout").textContent="‚Äî"; $("mConfirm").disabled=true; return; }
  $("mPayout").textContent = to2(stake * Number(selectedOpt.coef));
  $("mConfirm").disabled = false;
}
$("mStake").addEventListener("input", updatePotential);

function renderOdds(ev){
  const box=$("mOdds"); box.innerHTML="";
  const opts=Array.isArray(ev.options)?ev.options:[];
  if(!opts.length){
    box.innerHTML = `<div class="muted">No options found for this event.</div>`;
    return;
  }
  const coefs = opts.map(o=>Number(o.coef));
  const minC = Math.min(...coefs);
  const maxC = Math.max(...coefs);

  opts.forEach((o)=>{
    let cls="";
    if(minC !== maxC){
      if(Number(o.coef) === maxC) cls="g";
      else if(Number(o.coef) === minC) cls="r";
    }
    const btn=document.createElement("div");
    btn.className="oddBtn "+cls;
    btn.innerHTML=`<div class="oddName">${esc(o.name)}</div><div class="oddCoef">${to2(o.coef)}</div>`;
    btn.onclick=()=>{
      selectedOpt=o;
      [...box.querySelectorAll(".oddBtn")].forEach(x=>x.classList.remove("selected"));
      btn.classList.add("selected");
      sfx(660,0.05,"triangle",0.03);
      updatePotential();
    };
    box.appendChild(btn);
  });
}

$("mConfirm").onclick = async ()=>{
  if(!currentEvent || !selectedOpt) return;
  const stake=Number($("mStake").value);
  toast(`Confirming ${to2(stake)} on ${selectedOpt.name}‚Ä¶`);
  await placeBet(currentEvent, selectedOpt);
};

async function placeBet(ev,opt){
  if(String(ev.status)!=="open") return toast("Event not open");
  if(!meProfile) return toast("Profile not loaded");
  await normalizeMonthForMe();

  const stake=Number($("mStake").value);
  if(!(stake>0)) return toast("Stake must be > 0");
  if(stake<0.01) return toast("Min 0.01");
  if(Number(meProfile.pts)<stake) return toast("Not enough points");

  const chk = await supabase.from("bets").select("id").eq("user_id", session.user.id).eq("event_id", ev.id).limit(1);
  if(!chk.error && chk.data && chk.data.length) return toast("Already bet this event");

  const newPts=clamp2(Number(meProfile.pts)-stake);
  const newLife=clamp2(Number(meProfile.lifetime_wager||0)+stake);
  const newMonth=clamp2(Number(meProfile.month_wager||0)+stake);
  const newLvl=computeLevel(newLife);

  const u1 = await supabase.from("profiles").update({
    pts:newPts, lifetime_wager:newLife, month_wager:newMonth, month_key:monthKey(), level:newLvl
  }).eq("id", session.user.id);
  if(u1.error){ toast("Bet failed (DB/RLS)."); console.error(u1.error); return; }

  const ins = await supabase.from("bets").insert({
    user_id: session.user.id,
    event_id: ev.id,
    option_id: opt.id,
    event_name: ev.name,
    opt_name: opt.name,
    stake: Number(to2(stake)),
    coef: Number(to2(opt.coef)),
    status: "pending",
    payout: 0
  });
  if(ins.error){ toast("Bet insert failed (DB/RLS)."); console.error(ins.error); return; }

  meProfile.pts=newPts; meProfile.lifetime_wager=newLife; meProfile.month_wager=newMonth; meProfile.level=newLvl;
  updateMeUI();
  await loadMyBets();
  toast("Bet placed");
  closeEventModal();
}

/* PROFILE MODAL */
function openProfile(){
  if(!meProfile) return toast("Profile not loaded");
  $("pUserEdit").value = meProfile.display_name||"";
  applyAvatar($("pAvatar"), meProfile.avatar_seed||"p1");
  window.__selectedAvatar = meProfile.avatar_seed||"p1";
  $("pBal").textContent = to2(meProfile.pts||0);
  $("pLevel").textContent = String(meProfile.level||1);
  $("pMonthW").textContent = to2(meProfile.month_wager||0);
  $("pLifeW").textContent = to2(meProfile.lifetime_wager||0);
  $("pBets").textContent = String(myBets.length);
  $("profileOverlay").classList.add("show");
}
function closeProfile(){ $("profileOverlay").classList.remove("show"); }
$("profileBtn").onclick=openProfile;
$("closeProfile").onclick=closeProfile;
$("pCloseBtn").onclick=closeProfile;

document.querySelectorAll('[data-ava]').forEach(btn=>{
  btn.onclick=()=>{
    window.__selectedAvatar = btn.getAttribute("data-ava");
    applyAvatar($("pAvatar"), window.__selectedAvatar);
    toast("Avatar selected");
  };
});
$("pSaveBtn").onclick=async ()=>{
  if(!meProfile) return toast("Profile not loaded");
  const newName = $("pUserEdit").value.trim();
  if(!newName) return toast("Username required");
  const seed = window.__selectedAvatar || (meProfile.avatar_seed||"p1");
  const { error } = await supabase.from("profiles").update({ display_name:newName, avatar_seed:seed }).eq("id", session.user.id);
  if(error){ toast("Save failed (DB/RLS)."); console.error(error); return; }
  meProfile.display_name=newName; meProfile.avatar_seed=seed;
  updateMeUI();
  toast("Profile updated");
};
$("profileOverlay").onclick=(e)=>{ if(e.target===$("profileOverlay")) closeProfile(); };

/* LEADERBOARD */
async function refreshLeaderboard(){
  const cur=monthKey();
  $("lbMonth").textContent=cur;
  const { data, error } = await supabase.from("profiles").select("display_name,month_wager,level,month_key").eq("month_key", cur).order("month_wager",{ascending:false}).limit(50);
  if(error){
    $("lbBody").innerHTML = `<tr><td colspan="4" class="muted">Leaderboard failed (DB/RLS).</td></tr>`;
    console.error(error);
    return;
  }
  const rows=data||[];
  $("chipLb").textContent=String(rows.length);
  $("lbBody").innerHTML = rows.length ? rows.map((r,i)=>`
    <tr>
      <td class="mono">${i+1}</td>
      <td>${esc(r.display_name||"Player")}</td>
      <td class="mono">${to2(r.month_wager||0)}</td>
      <td class="mono">Lv ${Number(r.level||1)}</td>
    </tr>`).join("") : `<tr><td colspan="4" class="muted">No data yet. Place some bets first.</td></tr>`;
}

/* DAILY CASE + COUNTDOWN */
const CASE_ITEMS=[
  {label:"0.01", amount:0.01, iconType:"yellow", p:70},
  {label:"0.03", amount:0.03, iconType:"yellow", p:10},
  {label:"0.05", amount:0.05, iconType:"yellow", p:7.5},
  {label:"0.10", amount:0.10, iconType:"yellow", p:2.5},
  {label:"0.00", amount:0.00, iconType:"poop", p:9},
  {label:"1.00", amount:1.00, iconType:"blue", p:1},
];
function iconFor(t){
  if(t==="yellow") return `<span class="glow">${gemYellow()}</span>`;
  if(t==="blue") return `<span class="glow">${gemBlue()}</span>`;
  return poop();
}
function weightedPick(){
  const r=Math.random()*100; let a=0;
  for(const it of CASE_ITEMS){ a+=it.p; if(r<=a) return it; }
  return CASE_ITEMS[0];
}
function caseEligible(){
  if(!meProfile) return {ok:false, reason:"Profile not loaded"};
  const cur=monthKey();
  const myMonth = ((meProfile.month_key||cur)===cur) ? Number(meProfile.month_wager||0) : 0;
  const hasReq = myMonth>=10;
  const already = String(meProfile.last_case_open||"")===todayISO();
  if(!hasReq && !isAdmin) return {ok:false, reason:"Need 10 wager", myMonth};
  if(already && !isAdmin) return {ok:false, reason:"Already opened today", myMonth};
  return {ok:true, myMonth};
}
function buildCaseStrip(target){
  const arr=[];
  const pre=120, post=50;
  for(let i=0;i<pre;i++) arr.push({ ...CASE_ITEMS[Math.floor(Math.random()*CASE_ITEMS.length)] });
  arr.push({ ...target, __win:true });
  for(let i=0;i<post;i++) arr.push({ ...CASE_ITEMS[Math.floor(Math.random()*CASE_ITEMS.length)] });
  return arr;
}

function renderCaseTrack(items){
  const track=$("caseTrack"); track.innerHTML="";
  items.forEach(it=>{
    const el=document.createElement("div"); el.className="caseItem";
    el.innerHTML = `${iconFor(it.iconType)}<div class="amt">${it.label}</div>`;
    track.appendChild(el);
  });
}

function refreshCaseUI(){
  if(!meProfile){ $("caseStatus").textContent="PROFILE NOT LOADED"; $("openCaseBtn").disabled=true; return; }
  const cur=monthKey();
  const myMonth = ((meProfile.month_key||cur)===cur) ? Number(meProfile.month_wager||0) : 0;
  $("caseReq").textContent = `${to2(myMonth)} / 10.00`;
  const e=caseEligible();
  $("caseStatus").textContent = e.ok ? "READY" : (isAdmin ? "ADMIN" : e.reason.toUpperCase());
  $("openCaseBtn").disabled = !e.ok && !isAdmin;
  $("openCaseBtn").style.opacity = (!e.ok && !isAdmin) ? "0.6" : "1";
}
function updateCaseCountdown(){
  const now = new Date();
  const next = new Date(now);
  next.setHours(24,0,0,0);
  const ms = Math.max(0, next - now);
  const h = Math.floor(ms/3600000);
  const m = Math.floor((ms%3600000)/60000);
  const s = Math.floor((ms%60000)/1000);
  $("caseCountdown").textContent = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}
setInterval(updateCaseCountdown, 1000);
updateCaseCountdown();

let caseSpinning=false;
$("openCaseBtn").onclick=async ()=>{
  if(caseSpinning) return;
  if(!meProfile) return toast("Profile not loaded");
  const elig=caseEligible();
  if(!elig.ok && !isAdmin) return toast("Daily case locked (wager 10)");
  caseSpinning=true;
  const reward=weightedPick();
  const strip=buildCaseStrip(reward);
  renderCaseTrack(strip);

  const track=$("caseTrack");
  track.style.transition="none";
  track.style.transform="translateX(0px)";
  const stage=track.parentElement;
  const itemW=120, gap=14;
  const stageW=stage.clientWidth;
  const lastCenter=20 + (strip.length-1)*(itemW+gap) + itemW/2;
  const targetX=(stageW/2)-lastCenter;

  requestAnimationFrame(()=>{
    track.style.transition="transform 3.4s cubic-bezier(.08,.75,.10,1)";
    track.style.transform=`translateX(${targetX}px)`;
  });

  let t=0; const tm=setInterval(()=>{ t++; sfx(900,0.015,"square",0.05); if(t>70) clearInterval(tm); }, 48);

  setTimeout(async ()=>{
    clearInterval(tm);
    const prize=Number(reward.amount);
    const today=todayISO();
    const newPts=clamp2(Number(meProfile.pts)+prize);
    const { error } = await supabase.from("profiles").update({ pts:newPts, last_case_open: today }).eq("id", session.user.id);
    if(error){ toast("Case payout failed (DB/RLS)."); console.error(error); caseSpinning=false; return; }
    meProfile.pts=newPts; meProfile.last_case_open=today;
    updateMeUI(); refreshCaseUI();
    toast(prize>0 ? `You won ${to2(prize)}` : "You won 0.00");
    caseSpinning=false;
  }, 3600);
};
renderCaseTrack(buildCaseStrip(CASE_ITEMS[0]));

/* ADMIN: USERS */
async function loadUsersList(){
  if(!isAdmin) return;
  const { data, error } = await supabase.from("profiles").select("id,display_name,email,pts").order("created_at",{ascending:true}).limit(200);
  if(error){
    $("adminUserHint").textContent="Cannot load users. Run SQL then Refresh. Users must sign in once to create a profile.";
    console.error(error);
    return;
  }
  usersList=data||[];
  const sel=$("userSelect");
  sel.innerHTML = usersList.length ? usersList.map(u=>`<option value="${u.id}">${esc(u.display_name||"User")} ‚Äî ${esc(u.email||"")}</option>`).join("") : `<option value="">No users</option>`;
  $("adminUserHint").textContent = usersList.length ? `${usersList.length} users loaded` : "No users yet.";
}
function getSelectedUser(){
  const id=$("userSelect").value;
  return usersList.find(u=>u.id===id) || null;
}
$("setPtsBtn").onclick=async ()=>{
  if(!isAdmin) return toast("Admin only");
  const u=getSelectedUser(); if(!u) return toast("Select user");
  const pts=Number($("ptsSet").value); if(!(pts>=0)) return toast("Invalid pts");
  const { error } = await supabase.from("profiles").update({ pts: clamp2(pts) }).eq("id", u.id);
  if(error){ toast("Set failed (DB/RLS)."); console.error(error); return; }
  toast("Points set");
  await loadUsersList();
};
$("addBtn").onclick=async ()=>{
  if(!isAdmin) return toast("Admin only");
  const u=getSelectedUser(); if(!u) return toast("Select user");
  const add=Number($("ptsAdd").value); if(!(add>0)) return toast("Invalid add");
  const newPts=clamp2(Number(u.pts||0)+add);
  const { error } = await supabase.from("profiles").update({ pts:newPts }).eq("id", u.id);
  if(error){ toast("Add failed (DB/RLS)."); console.error(error); return; }
  toast("Added");
  await loadUsersList();
};

/* ADMIN: CREATE EVENT */
let opts=[
  { tmpId: crypto.randomUUID(), name:"Player A", coef:1.80 },
  { tmpId: crypto.randomUUID(), name:"Player B", coef:2.10 }
];
function renderOptRows(){
  const box=$("optsBox"); box.innerHTML="";
  opts.forEach(o=>{
    const row=document.createElement("div"); row.className="row"; row.style.marginBottom="10px";
    row.innerHTML=`
      <div style="flex:1;min-width:220px;"><label>Option name</label><input data-on="${o.tmpId}" value="${esc(o.name)}"/></div>
      <div style="width:200px;"><label>Coef</label><input data-oc="${o.tmpId}" type="number" min="1.01" step="0.01" value="${to2(o.coef)}"/></div>
      <div style="width:160px;"><label>&nbsp;</label><button class="btn red" data-od="${o.tmpId}" style="width:100%;">Remove</button></div>
    `;
    box.appendChild(row);
  });
  box.querySelectorAll("input[data-on]").forEach(inp=>inp.oninput=(e)=>{ const id=e.target.dataset.on; opts=opts.map(o=>o.tmpId===id?({...o,name:e.target.value}):o); });
  box.querySelectorAll("input[data-oc]").forEach(inp=>inp.oninput=(e)=>{ const id=e.target.dataset.oc; const v=Number(e.target.value); if(!(v>=1.01)) return; opts=opts.map(o=>o.tmpId===id?({...o,coef:Number(to2(v))}):o); });
  box.querySelectorAll("button[data-od]").forEach(btn=>btn.onclick=(e)=>{ const id=e.target.dataset.od; opts=opts.filter(o=>o.tmpId!==id); renderOptRows(); });
}
$("addOptBtn").onclick=()=>{ if(!isAdmin) return toast("Admin only"); opts.push({ tmpId:crypto.randomUUID(), name:"", coef:2.00 }); renderOptRows(); };
renderOptRows();

$("createEventBtn").onclick = async () => {
  if (!isAdmin) return toast("Admin only");

  const name = $("evName").value.trim();
  const desc = $("evDesc").value.trim();
  const status = ($("evStatus").value.trim() || "open");

  if (!name) return toast("Event name required");
  if (opts.length < 2) return toast("Need 2+ options");
  for (const o of opts) {
    if (!String(o.name || "").trim()) return toast("Option needs name");
    if (!(Number(o.coef) >= 1.01)) return toast("Coef ‚â• 1.01");
  }

  const normalized = opts.map(o => ({ label: String(o.name).trim(), coef: Number(to2(o.coef)) }));

  try {
    const { data: ev, error: evErr } = await supabase
      .from("events")
      .insert({ name, description: desc, status, created_by: session.user.id })
      .select("id")
      .single();
    if (evErr) throw evErr;

    const rows = normalized.map(o => ({ event_id: ev.id, label: o.label, coef: o.coef }));
    const { error: optErr } = await supabase.from("event_options").insert(rows);
    if (optErr) throw optErr;

    $("evName").value = "";
    $("evDesc").value = "";
    $("evStatus").value = "open";
    opts = [
      { tmpId: crypto.randomUUID(), name: "Player A", coef: 1.80 },
      { tmpId: crypto.randomUUID(), name: "Player B", coef: 2.10 }
    ];
    renderOptRows();

    toast("Event created");
    await loadEvents();
    await loadAdminEvents();
    setView("sports");
  } catch (e) {
    toast("Create failed (DB/RLS).");
    console.error(e);
  }
};

/* ADMIN: MANAGE EVENTS (open/close/finish winner/delete + payout) */
$("reloadAdminEventsBtn").onclick = ()=>loadAdminEvents();

async function loadAdminEvents(){
  if(!isAdmin){ $("adminEventsList").textContent="Admin only."; return; }

  await loadEvents();

  const { data: allBets, error: eB } = await supabase
    .from("bets")
    .select("event_id,status")
    .limit(5000);
  const counts = new Map();
  if(!eB && allBets){
    for(const b of allBets){
      const k=b.event_id;
      if(!counts.has(k)) counts.set(k,{total:0,pending:0,won:0,lost:0});
      const c=counts.get(k);
      c.total++;
      const st=String(b.status||"pending");
      if(st==="pending") c.pending++;
      else if(st==="won") c.won++;
      else if(st==="lost") c.lost++;
    }
  }

  const list = $("adminEventsList");
  if(!events.length){
    list.innerHTML = `<div class="muted">No events.</div>`;
    return;
  }

  list.innerHTML = events.map(ev=>{
    const c = counts.get(ev.id) || {total:0,pending:0,won:0,lost:0};
    const opts = ev.options || [];
    const winnerSel = `
      <select data-win="${ev.id}" style="margin-top:6px;">
        <option value="">‚Äî select winner ‚Äî</option>
        ${opts.map(o=>`<option value="${o.id}" ${Number(ev.winner_option_id||0)===Number(o.id)?"selected":""}>${esc(o.name)} (${to2(o.coef)})</option>`).join("")}
      </select>
    `;
    return `
      <div style="border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);border-radius:16px;padding:12px;margin-bottom:10px;">
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start;">
          <div style="min-width:0;">
            <div style="font-weight:950;">${esc(ev.name)} <span class="chip">${esc(ev.status||"open")}</span></div>
            <div class="muted" style="font-size:12px;margin-top:4px;">${esc(ev.description||"")}</div>
            <div class="muted" style="font-size:12px;margin-top:6px;">
              Bets: <span class="mono">${c.total}</span> (pending <span class="mono">${c.pending}</span>, won <span class="mono">${c.won}</span>, lost <span class="mono">${c.lost}</span>)
            </div>
            <div style="margin-top:8px;">
              <label>Winner</label>
              ${winnerSel}
            </div>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;">
            <button class="btn" data-open="${ev.id}">Set OPEN</button>
            <button class="btn" data-close="${ev.id}">Set CLOSED</button>
            <button class="btn purple" data-finish="${ev.id}">Finish + Payout</button>
            <button class="btn red" data-del="${ev.id}">Delete</button>
          </div>
        </div>
      </div>
    `;
  }).join("");

  list.querySelectorAll("button[data-open]").forEach(b=>b.onclick=async ()=>{
    const id=Number(b.dataset.open);
    const r=await supabase.from("events").update({ status:"open" }).eq("id", id);
    if(r.error){ toast("Failed"); console.error(r.error); return; }
    toast("Event OPEN");
    await loadEvents(); await loadAdminEvents();
  });

  list.querySelectorAll("button[data-close]").forEach(b=>b.onclick=async ()=>{
    const id=Number(b.dataset.close);
    const r=await supabase.from("events").update({ status:"closed" }).eq("id", id);
    if(r.error){ toast("Failed"); console.error(r.error); return; }
    toast("Event CLOSED");
    await loadEvents(); await loadAdminEvents();
  });

  list.querySelectorAll("button[data-del]").forEach(b=>b.onclick=async ()=>{
    const id=Number(b.dataset.del);
    if(!confirm("Delete event? This will also delete its options and bets (because of FK).")) return;
    const r=await supabase.from("events").delete().eq("id", id);
    if(r.error){ toast("Delete failed"); console.error(r.error); return; }
    toast("Deleted");
    await loadEvents(); await loadAdminEvents();
  });

  list.querySelectorAll("button[data-finish]").forEach(b=>b.onclick=async ()=>{
    const evId=Number(b.dataset.finish);
    const winSel = list.querySelector(`select[data-win="${evId}"]`);
    const winnerId = Number(winSel?.value || 0);
    if(!winnerId) return toast("Select a winner first");

    const u = await supabase.from("events").update({ status:"settled", winner_option_id:winnerId }).eq("id", evId);
    if(u.error){ toast("Finish failed"); console.error(u.error); return; }

    const betsR = await supabase.from("bets")
      .select("id,user_id,stake,coef,option_id,status")
      .eq("event_id", evId)
      .eq("status", "pending")
      .limit(5000);
    if(betsR.error){ toast("Cannot load bets"); console.error(betsR.error); return; }
    const bets = betsR.data || [];

    const winners = bets.filter(x=>Number(x.option_id)===winnerId);
    const losers  = bets.filter(x=>Number(x.option_id)!==winnerId);

    if(winners.length){
      for(const w of winners){
        const payout = Number(to2(Number(w.stake)*Number(w.coef)));
        const ub = await supabase.from("bets").update({ status:"won", payout }).eq("id", w.id);
        if(ub.error){ console.error(ub.error); }
        const pr = await supabase.from("profiles").select("pts").eq("id", w.user_id).maybeSingle();
        if(!pr.error && pr.data){
          const newPts = clamp2(Number(pr.data.pts||0) + payout);
          const up = await supabase.from("profiles").update({ pts:newPts }).eq("id", w.user_id);
          if(up.error) console.error(up.error);
        }
      }
    }
    if(losers.length){
      for(const l of losers){
        const ub = await supabase.from("bets").update({ status:"lost", payout:0 }).eq("id", l.id);
        if(ub.error){ console.error(ub.error); }
      }
    }

    toast(`Finished. Paid ${winners.length} winners.`);
    await loadEvents();
    await loadAdminEvents();
    await ensureProfile();
    await loadMyBets();
    updateMeUI();
  });
}

// =======================
// BLACKJACK (Shuffle-style UI)
// - Deck top-right + bump
// - Deal animation + wind trail
// - Flip animation for hole card
// - Sounds (WebAudio)
// - Split / Double / Hit / Stand
// - Side bets: Perfect Pairs (10x), Bust Out (2x if dealer busts)
// - Win/Lose popup like mines (shows won or lost amount)
// - Outline winner green, loser red
// =======================

$("bjGem") && ($("bjGem").innerHTML = gemBlue());

function bjSfx(type="tap"){
  // Uses your existing WebAudio context (same as sfx)
  try{
    const ctx = window.__sfxCtx || (window.__sfxCtx = new (window.AudioContext||window.webkitAudioContext)());
    const now = ctx.currentTime;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);

    if(type==="deal"){
      o.type="triangle";
      o.frequency.setValueAtTime(520, now);
      o.frequency.exponentialRampToValueAtTime(240, now+0.06);
      g.gain.setValueAtTime(0.06, now);
      g.gain.exponentialRampToValueAtTime(0.001, now+0.08);
      o.start(now); o.stop(now+0.09);
      return;
    }
    if(type==="flip"){
      o.type="square";
      o.frequency.setValueAtTime(880, now);
      o.frequency.exponentialRampToValueAtTime(420, now+0.08);
      g.gain.setValueAtTime(0.05, now);
      g.gain.exponentialRampToValueAtTime(0.001, now+0.11);
      o.start(now); o.stop(now+0.12);
      return;
    }
    if(type==="win"){
      // small arpeggio
      const notes=[740, 880, 1046];
      notes.forEach((f,i)=>{
        const oo=ctx.createOscillator();
        const gg=ctx.createGain();
        oo.type="triangle";
        oo.frequency.value=f;
        gg.gain.setValueAtTime(0.0001, now+i*0.06);
        gg.gain.exponentialRampToValueAtTime(0.06, now+i*0.06+0.01);
        gg.gain.exponentialRampToValueAtTime(0.001, now+i*0.06+0.09);
        oo.connect(gg); gg.connect(ctx.destination);
        oo.start(now+i*0.06);
        oo.stop(now+i*0.06+0.10);
      });
      return;
    }
    if(type==="lose"){
      o.type="sawtooth";
      o.frequency.setValueAtTime(220, now);
      o.frequency.exponentialRampToValueAtTime(90, now+0.18);
      g.gain.setValueAtTime(0.08, now);
      g.gain.exponentialRampToValueAtTime(0.001, now+0.22);
      o.start(now); o.stop(now+0.23);
      return;
    }

    // tap
    o.type="sine";
    o.frequency.value=520;
    g.gain.value=0.03;
    o.start(); o.stop(now+0.05);
  }catch(_){}
}

const bj = {
  shoe: [],
  shoeDecks: 6,
  active: false,
  settled: false,
  stake: 0,
  sidePairs: 0,
  sideBust: 0,

  dealer: [],
  hands: [ [] ],        // player hands (hand0 + maybe hand1)
  handBets: [0],        // bet per hand (split duplicates)
  activeHand: 0,

  holeCardHidden: true,
  canDouble: false,
  canSplit: false,
};

function bjSuitChar(s){
  return s==="S"?"‚ô†":(s==="H"?"‚ô•":(s==="D"?"‚ô¶":"‚ô£"));
}
function bjIsRed(s){ return (s==="H"||s==="D"); }

function bjBuildShoe(){
  const suits=["S","H","D","C"];
  const ranks=["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
  const shoe=[];
  for(let d=0; d<bj.shoeDecks; d++){
    for(const s of suits){
      for(const r of ranks){
        shoe.push({ r, s });
      }
    }
  }
  // Fisher-Yates
  for(let i=shoe.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [shoe[i], shoe[j]] = [shoe[j], shoe[i]];
  }
  bj.shoe = shoe;
  bjUpdateShoeUI();
}
function bjEnsureShoe(){
  if(!bj.shoe.length || bj.shoe.length < 52){
    bjBuildShoe();
  }
}
function bjDraw(){
  bjEnsureShoe();
  return bj.shoe.pop();
}

function bjCardValue(r){
  if(r==="A") return 11;
  if(r==="K"||r==="Q"||r==="J") return 10;
  return Number(r);
}
function bjHandTotals(cards){
  let sum=0, aces=0;
  for(const c of cards){
    const v=bjCardValue(c.r);
    sum += v;
    if(c.r==="A") aces++;
  }
  // adjust aces 11->1
  while(sum>21 && aces>0){
    sum -= 10; aces--;
  }
  const soft = cards.some(c=>c.r==="A") && sum<=21; // rough
  return { sum, soft };
}
function bjIsBlackjack(cards){
  return cards.length===2 && bjHandTotals(cards).sum===21;
}

function bjUpdateShoeUI(){
  if($("bjShoe")) $("bjShoe").textContent = `${bj.shoe.length}`;
}

function bjSetBetBtn(canBet=true){
  const btns=["bjBetBtn","bjBetBtnM"].map($).filter(Boolean);
  btns.forEach(b=>{
    if(canBet){
      b.disabled = false;
      b.style.opacity = "1";
      b.style.cursor = "pointer";
      b.textContent = "Bet";
    }else{
      b.disabled = true;
      b.style.opacity = "0.55";
      b.style.cursor = "not-allowed";
      b.textContent = "Bet placed ‚úì";
    }
  });
}

function bjSetButtons(){
  const inPlay = bj.active && !bj.settled;
  const h = bj.hands[bj.activeHand] || [];
  const totals = bjHandTotals(h).sum;

  const canHit = inPlay && totals < 21;
  const canStand = inPlay;
  const canDouble = inPlay && bj.canDouble && h.length===2;
  const canSplit = inPlay && bj.canSplit && h.length===2;

  const hitBtns=["bjHitBtn","bjHitBtnM"].map($).filter(Boolean);
  const standBtns=["bjStandBtn","bjStandBtnM"].map($).filter(Boolean);
  const dblBtns=["bjDoubleBtn","bjDoubleBtnM"].map($).filter(Boolean);
  const splitBtns=["bjSplitBtn","bjSplitBtnM"].map($).filter(Boolean);

  hitBtns.forEach(btn=>btn.disabled = !canHit);
  standBtns.forEach(btn=>btn.disabled = !canStand);
  dblBtns.forEach(btn=>btn.disabled = !canDouble);
  splitBtns.forEach(btn=>btn.disabled = !canSplit);

  // glow states for double / split
  [...dblBtns].forEach(d=>d.classList.toggle("bjPulseDouble", canDouble));
  [...splitBtns].forEach(s=>s.classList.toggle("bjPulseSplit", canSplit));

  // update active hand highlight in UI rows
  const rows = document.querySelectorAll("#bjPlayerCards .bjHandRow");
  rows.forEach((row,i)=> row.classList.toggle("active", i===bj.activeHand));

  // refresh per-hand meta totals on button refresh
  rows.forEach((row,i)=>{
    const meta=row.querySelector(".bjHandMeta");
    if(!meta) return;
    const hand=bj.hands[i]||[];
    const bet=to2(bj.handBets[i]||bj.stake||0);
    const total = hand.length ? bjHandTotals(hand).sum : "‚Äî";
    meta.textContent = `Hand ${i+1} ¬∑ Bet ${bet} ¬∑ Total ${total}`;
  });

  $("bjHandNo").textContent = String(bj.activeHand + 1);
}

function bjCardEl(card, faceDown=false){
  const wrap=document.createElement("div");
  wrap.className="bjCard" + (faceDown ? "" : " flipped");
  wrap.innerHTML = `
    <div class="bjTrail"></div>
    <div class="bjCardInner">
      <div class="bjFace">
        <div class="bjRank ${bjIsRed(card.s)?"bjRed":"bjBlack"}">${card.r}</div>
        <div class="bjSuit ${bjIsRed(card.s)?"bjRed":"bjBlack"}">${bjSuitChar(card.s)}</div>
        <div class="bjPip ${bjIsRed(card.s)?"bjRed":"bjBlack"}">${bjSuitChar(card.s)}</div>
      </div>
      <div class="bjBack"></div>
    </div>
  `;
  return wrap;
}

function bjGetHandRow(idx, create=false){
  const pBox=$("bjPlayerCards");
  if(!pBox) return null;
  const rows = Array.from(pBox.querySelectorAll(".bjHandRow"));
  if(rows[idx]) return rows[idx];
  if(!create) return null;
  const row=document.createElement("div");
  row.className="bjHandRow" + (idx===bj.activeHand ? " active" : "");
  row.dataset.hand=String(idx+1);
  const meta=document.createElement("div");
  meta.className="bjHandMeta";
  const cards=document.createElement("div");
  cards.className="bjHandCards";
  row.appendChild(meta);
  row.appendChild(cards);
  pBox.appendChild(row);
  return row;
}

function bjGetHandCards(idx){
  const row = bjGetHandRow(idx, true);
  if(!row) return null;
  let cards = row.querySelector(".bjHandCards");
  if(!cards){ cards=document.createElement("div"); cards.className="bjHandCards"; row.appendChild(cards); }
  return cards;
}

function bjDeckBump(){
  const d=$("bjDeck"); if(!d) return;
  d.classList.remove("bump"); void d.offsetWidth; d.classList.add("bump");
}

async function bjDealAnim(cardEl, toContainer){
  // deal from deck position to target container (wind trail)
  const deck=$("bjDeck");
  if(!deck || !toContainer) { toContainer.appendChild(cardEl); return; }

  // Snapshot existing card positions for smooth lane shift (FLIP)
  const prevRects = new Map();
  Array.from(toContainer.children).forEach(ch=>{
    prevRects.set(ch, ch.getBoundingClientRect());
  });

  bjDeckBump();
  bjSfx("deal");

  // start at deck rect
  const dr = deck.getBoundingClientRect();
  
  // Pre-calc target slot by temporarily mounting the card hidden to let flex gap place it
  cardEl.style.visibility = "hidden";
  toContainer.appendChild(cardEl);
  const tr = cardEl.getBoundingClientRect();
  toContainer.removeChild(cardEl);
  cardEl.style.visibility = "";

  // create floating clone
  const float = cardEl.cloneNode(true);
  float.classList.add("dealing");
  float.style.position="fixed";
  float.style.left = "0px";
  float.style.top = "0px";
  float.style.zIndex="80";
  float.style.pointerEvents="none";
  document.body.appendChild(float);

  // after append, measure floating card size
  const fw = float.getBoundingClientRect().width;
  const fh = float.getBoundingClientRect().height;

  const startX = dr.left + dr.width/2 - fw/2;
  const startY = dr.top  + dr.height/2 - fh/2;
  float.style.left = startX + "px";
  float.style.top  = startY + "px";

  const xEnd = tr.left;
  const yEnd = tr.top;

  await float.animate([
    { transform:`translate(0px,0px) rotate(${Math.random()*6-3}deg) scale(.96)`, opacity:1 },
    { transform:`translate(${xEnd - startX}px, ${yEnd - startY}px) rotate(${Math.random()*6-3}deg) scale(1)` , opacity:1 }
  ], {
    duration: 380,
    easing: "cubic-bezier(.12,.8,.18,1)"
  }).finished.catch(()=>{});

  float.remove();
  toContainer.appendChild(cardEl);

  // Animate existing cards to their new slots (smooth spread)
  bjAnimateLaneShift(toContainer, prevRects);
}

function bjAnimateLaneShift(container, prevRects){
  const cards = Array.from(container.children);
  const isDealer = container.id === "bjDealerCards";
  cards.forEach(el=>{
    const prev = prevRects.get(el);
    if(!prev) return; // new card handled by deal anim
    const now = el.getBoundingClientRect();
    const dx = prev.left - now.left;
    const dy = prev.top - now.top;
    if(Math.abs(dx) < 0.5 && Math.abs(dy) < 0.5) return;

    el.style.transition = "none";
    el.style.transform = `translate(${dx}px, ${dy}px)`;
    requestAnimationFrame(()=>{
      requestAnimationFrame(()=>{
        const duration = (isDealer && cards.length<=2) ? 220 : 260;
        const easing = (isDealer && cards.length<=2) ? "cubic-bezier(.22,.9,.3,1)" : "cubic-bezier(.16,.84,.22,1)";
        el.style.transition = `transform ${duration}ms ${easing}`;
        el.style.transform = "translate(0,0)";
        setTimeout(()=>{
          el.style.transition = "";
          el.style.transform = "";
        }, duration + 60);
      });
    });
  });
}

function bjRender(){
  const dBox=$("bjDealerCards");
  const pBox=$("bjPlayerCards");
  if(!dBox || !pBox) return;

  dBox.innerHTML="";
  pBox.innerHTML="";

  // Dealer cards (2+)
  bj.dealer.forEach((c, idx)=>{
    const faceDown = (idx===1 && bj.holeCardHidden);
    const el = bjCardEl(c, faceDown);
    dBox.appendChild(el);
  });

  // Player: show all hands stacked with meta and cards
  bj.hands.forEach((hand, handIdx)=>{
    const row = bjGetHandRow(handIdx, true);
    if(!row) return;
    row.classList.toggle("active", handIdx===bj.activeHand);

    let meta=row.querySelector(".bjHandMeta");
    if(!meta){ meta=document.createElement("div"); meta.className="bjHandMeta"; row.prepend(meta); }
    const bet = to2(bj.handBets[handIdx]||bj.stake||0);
    const total = hand.length ? bjHandTotals(hand).sum : "‚Äî";
    meta.textContent = `Hand ${handIdx+1} ¬∑ Bet ${bet} ¬∑ Total ${total}`;

    const cards = bjGetHandCards(handIdx);
    if(cards){
      cards.innerHTML="";
      hand.forEach(c=>{
        const el = bjCardEl(c, false);
        cards.appendChild(el);
      });
    }
  });

  // set hand count for responsive scaling
  pBox.dataset.hands = String(bj.hands.length||1);

  bjUpdateScoresUI();
  bjSetButtons();
  bjUpdateBalanceUI();
  bjUpdateShoeUI();
}

function bjUpdateBalanceUI(){
  if(!$("bjBal")) return;
  $("bjBal").textContent = to2(meProfile?.pts||0);
}

function bjDealerScoreVisible(){
  if(!bj.dealer.length) return "‚Äî";
  if(bj.holeCardHidden && bj.dealer.length>=1){
    return String(bjHandTotals([bj.dealer[0]]).sum);
  }
  return String(bjHandTotals(bj.dealer).sum);
}

function bjUpdateScoresUI(){
  const dP=$("bjDealerPill"), pP=$("bjPlayerPill");
  const dS=$("bjDealerScore"), pS=$("bjPlayerScore");
  if(dP) dP.textContent = bjDealerScoreVisible();
  const pSum = bj.hands[bj.activeHand]?.length ? bjHandTotals(bj.hands[bj.activeHand]).sum : "‚Äî";
  if(pP) pP.textContent = String(pSum);
  if(dS) dS.textContent = bjDealerScoreVisible();
  if(pS) pS.textContent = String(pSum);
}

function bjShowPop({ win=true, amount=0, text="", status=null }){
  const el=$("bjCenterPop"); if(!el) return;
  const isPush = status === "push";
  el.classList.remove("hide","lose","push");
  el.classList.toggle("lose", !isPush && !win);
  if(isPush) el.classList.add("push");

  $("bjPopLabel").textContent = isPush ? "PUSH" : (win ? "YOU WON" : "YOU LOST");
  $("bjPopAmt").textContent = to2(amount);
  $("bjPopSub").textContent = text || (isPush ? "stake returned" : (win ? "added to balance" : "deducted from balance"));
  const dot=$("bjPopDot");
  if(dot){
    if(isPush){
      dot.style.background = "rgba(245,158,11,.95)";
      dot.style.boxShadow = "0 0 10px rgba(245,158,11,.45)";
    }else{
      dot.style.background = win ? "rgba(34,197,94,.95)" : "rgba(239,68,68,.95)";
      dot.style.boxShadow = win ? "0 0 10px rgba(34,197,94,.45)" : "0 0 10px rgba(239,68,68,.45)";
    }
  }
  el.classList.add("show");
  clearTimeout(el._t);
  el._t=setTimeout(()=>{
    el.classList.add("hide");
    setTimeout(()=>el.classList.remove("show","hide"), 220);
  }, 2200);
}

async function bjCredit(amount){
  amount = Number(amount||0);
  if(!(amount>0)) return;
  const newPts = clamp2(Number(meProfile.pts) + amount);
  const { error } = await supabase.from("profiles").update({ pts:newPts }).eq("id", session.user.id);
  if(error) throw error;
  meProfile.pts = newPts;
  updateMeUI();
}

function bjResetRound(){
  bj.active=false; bj.settled=false;
  bj.stake=0; bj.sidePairs=0; bj.sideBust=0;
  bj.dealer=[];
  bj.hands=[[]];
  bj.handBets=[0];
  bj.activeHand=0;
  bj.holeCardHidden=true;
  bj.canDouble=false;
  bj.canSplit=false;
  bjRender();
  bjSetButtons();
  // Hide BJ popup immediately
  const bjPop = $("bjCenterPop");
  if(bjPop){
    bjPop.classList.remove("show", "hide", "lose");
    clearTimeout(bjPop._t);
    bjPop.style.display = "none";
    setTimeout(()=>{ bjPop.style.display = ""; }, 250);
  }

  // Re-enable Bet button for next round
  bjSetBetBtn(true);

  // Re-enable Bet button for next round
  const betBtn = $("bjBetBtn");
  if(betBtn){
    betBtn.disabled = false;
    betBtn.style.opacity = "1";
    betBtn.style.cursor = "pointer";
    betBtn.textContent = "Bet";
  }
}

function bjComputeCanSplit(){
  const h=bj.hands[bj.activeHand]||[];
  if(h.length!==2) return false;
  const r1=h[0].r, r2=h[1].r;
  const v1=bjCardValue(r1), v2=bjCardValue(r2);
  // Allow classic pairs OR any two ten-valued cards (K,Q,J,10)
  if(r1===r2) return true;
  return v1===10 && v2===10;
}

async function bjStart(){
  if(!meProfile) return toast("Profile not loaded");
  if(bj.active) return;

  const stake = Number($("bjStake").value);
  const sidePairs = Number($("bjSidePairs").value);
  const sideBust  = Number($("bjSideBust").value);

  if(!(stake>0) || stake<0.01) return toast("Min bet 0.01");
  if(sidePairs<0 || sideBust<0) return toast("Side bets invalid");

  const totalWager = clamp2(stake + sidePairs + sideBust);
  if(Number(meProfile.pts) < totalWager) return toast("Not enough points");

  // take wager now (counts to wager/level)
  try{
    await addWagerAndPayout(totalWager, 0);
  }catch(e){
    if(String(e).includes("balance")) return toast("Not enough points");
    toast("Blackjack start error (DB/RLS/SQL)");
    console.error(e);
    return;
  }

  bjResetRound();
  bj.active=true;
  bj.stake=stake;
  bj.sidePairs=sidePairs;
  bj.sideBust=sideBust;
  bj.handBets=[stake];
  // Visually grey out Bet button until round ends
  bjSetBetBtn(false);

  // Initial deal
  const dBox=$("bjDealerCards"), pBox=$("bjPlayerCards");
  if(!dBox || !pBox) return;

  // player 1
  const p1=bjDraw(); bj.hands[0].push(p1);
  const p1el=bjCardEl(p1,false); await bjDealAnim(p1el, bjGetHandCards(0)||pBox);

  // dealer up
  const d1=bjDraw(); bj.dealer.push(d1);
  const d1el=bjCardEl(d1,false); await bjDealAnim(d1el, dBox);

  // player 2
  const p2=bjDraw(); bj.hands[0].push(p2);
  const p2el=bjCardEl(p2,false); await bjDealAnim(p2el, bjGetHandCards(0)||pBox);

  // dealer hole (face down)
  const d2=bjDraw(); bj.dealer.push(d2);
  const d2el=bjCardEl(d2,true); // face down
  await bjDealAnim(d2el, dBox);

  // enable actions
  bj.canDouble=true;
  bj.canSplit=bjComputeCanSplit();
  bjRender(); // ensure rows exist & labeled before interactions
  bjSetButtons();
  bjUpdateScoresUI();

  // Side bet settle: Perfect Pairs (10x) checks first 2 player cards
  let sideWin = 0;
  if(bj.sidePairs>0 && bj.hands[0].length>=2){
    if(bj.hands[0][0].r === bj.hands[0][1].r){
      sideWin += bj.sidePairs * 10;
    }
  }

  // Immediate blackjack checks
  const pBJ = bjIsBlackjack(bj.hands[0]);
  const dBJ = bjIsBlackjack(bj.dealer);

  if(pBJ || dBJ){
    // reveal dealer card
    await bjRevealHole(true);

    let mainPayout=0;
    if(pBJ && !dBJ){
      // blackjack pays 3:2, payout includes stake return: stake*2.5 total back
      mainPayout = bj.stake * 2.5;
    }else if(pBJ && dBJ){
      // push -> return stake
      mainPayout = bj.stake * 1.0;
    }else{
      // dealer BJ -> 0
      mainPayout = 0;
    }

    // Bust Out side bet only if dealer busts -> not possible on BJ
    // credit winnings
    const totalWin = clamp2(mainPayout + sideWin);
    if(pBJ && dBJ){
      // Push case: show orange push banner
      await bjCredit(totalWin);
      bjSfx("tap");
      bjShowPop({ win:false, amount: totalWin, text:"stake returned", status:"push" });
    }else if(totalWin>0){
      await bjCredit(totalWin);
      bjSfx("win");
      bjShowPop({ win:true, amount: totalWin, text:"added to balance" });
    }else{
      bjSfx("lose");
      bjShowPop({ win:false, amount: clamp2(bj.stake + bj.sidePairs + bj.sideBust), text:"lost this round" });
    }

    bj.settled=true; bj.active=false;
    bjMarkOutcome();
    bjSetButtons();
    bjSetBetBtn(true);
    return;
  }

  // if sideWin already, credit instantly (like side bet)
  if(sideWin>0){
    await bjCredit(sideWin);
    toast(`Side bet win +${to2(sideWin)}`);
    bjSfx("win");
  }

  toast("Blackjack started");
}

async function bjRevealHole(withFlipSound=false){
  bj.holeCardHidden=false;

  // flip animation for dealer second card
  const dBox=$("bjDealerCards");
  if(dBox && dBox.children && dBox.children[1]){
    const el=dBox.children[1];
    if(withFlipSound) bjSfx("flip");
    el.classList.add("flipped"); // show face
  }
  bjUpdateScoresUI();
}

async function bjHit(){
  if(!bj.active || bj.settled) return;
  bjSfx("tap");

  const pBox=bjGetHandCards(bj.activeHand) || $("bjPlayerCards");
  const card=bjDraw();
  bj.hands[bj.activeHand].push(card);

  const el=bjCardEl(card,false);
  await bjDealAnim(el, pBox);

  const total=bjHandTotals(bj.hands[bj.activeHand]).sum;
  bj.canDouble=false;
  bj.canSplit=bjComputeCanSplit();
  bjUpdateScoresUI();
  bjRender();
  bjSetButtons();

  if(total>21){
    // bust => finish this hand
    await bjStand(true);
  }
}

async function bjDouble(){
  if(!bj.active || bj.settled) return;
  const h=bj.hands[bj.activeHand]||[];
  if(h.length!==2) return;

  const extra = bj.handBets[bj.activeHand] || bj.stake;
  if(Number(meProfile.pts) < extra) return toast("Not enough points to double");

  // take extra wager now (counts wager)
  try{
    await addWagerAndPayout(extra, 0);
  }catch(e){
    if(String(e).includes("balance")) return toast("Not enough points");
    toast("Double error");
    console.error(e);
    return;
  }

  bj.handBets[bj.activeHand] = clamp2((bj.handBets[bj.activeHand]||bj.stake) + extra);
  bj.canDouble=false;
  bj.canSplit=false;

  await bjHit();
  if(!bj.settled){
    await bjStand(true); // double locks the hand; advance to next/settle
  }
}

async function bjSplit(){
  if(!bj.active || bj.settled) return;
  const h=bj.hands[bj.activeHand]||[];
  if(h.length!==2) return;
  // allow exact pairs or any two ten-valued cards
  const v1=bjCardValue(h[0].r), v2=bjCardValue(h[1].r);
  const isPair = h[0].r===h[1].r;
  const isTenCombo = v1===10 && v2===10;
  if(!(isPair || isTenCombo)) return;

  const baseBet = bj.handBets[bj.activeHand] || bj.stake;
  const extra = baseBet;
  if(Number(meProfile.pts) < extra) return toast("Not enough points to split");

  // take extra wager now
  try{
    await addWagerAndPayout(extra, 0);
  }catch(e){
    if(String(e).includes("balance")) return toast("Not enough points");
    toast("Split error");
    console.error(e);
    return;
  }

  bjSfx("tap");

  // split current hand into two hands (insert new hand after active)
  const c1=h[0], c2=h[1];
  bj.hands[bj.activeHand] = [c1];
  bj.hands.splice(bj.activeHand+1, 0, [c2]);
  bj.handBets.splice(bj.activeHand+1, 0, baseBet);

  // render rows then deal one card to each split hand into its row
  bjRender();
  const row0 = bjGetHandCards(bj.activeHand) || $("bjPlayerCards");
  const a1=bjDraw(); bj.hands[bj.activeHand].push(a1);
  await bjDealAnim(bjCardEl(a1,false), row0);
  bjRender();

  const secondIdx = bj.activeHand+1;
  const row1 = bjGetHandCards(secondIdx) || $("bjPlayerCards");
  const a2=bjDraw(); bj.hands[secondIdx].push(a2);
  await bjDealAnim(bjCardEl(a2,false), row1);

  // stay on the original (left) hand
  bj.canSplit=false;
  bj.canDouble=true; // allow double on split hand if 2 cards
  bj.canSplit=bjComputeCanSplit();
  bjSetButtons();
  bjUpdateScoresUI();
  toast("Split");
  bjRender();
}

async function bjDealerPlay(){
  await bjRevealHole(true);

  // Dealer hits to 17+
  while(true){
    const t=bjHandTotals(bj.dealer).sum;
    if(t>=17) break;
    const dBox=$("bjDealerCards");
    const c=bjDraw(); bj.dealer.push(c);
    const el=bjCardEl(c,false);
    await bjDealAnim(el, dBox);
    bjUpdateScoresUI();
  }
}

function bjOutcomeForHand(playerCards, dealerCards){
  const p = bjHandTotals(playerCards).sum;
  const d = bjHandTotals(dealerCards).sum;

  if(p>21) return "lose";
  if(d>21) return "win";
  if(p>d) return "win";
  if(p<d) return "lose";
  return "push";
}

async function bjStand(fromBust=false){
  if(!bj.active || bj.settled) return;

  // If split: advance through hands sequentially
  const p = bjHandTotals(bj.hands[bj.activeHand]).sum;
  const moreHands = bj.hands.length>1 && bj.activeHand < bj.hands.length-1;
  if(moreHands){
    bj.activeHand += 1;
    bj.canDouble=true;
    bj.canSplit=bjComputeCanSplit();
    bjSetButtons();
    bjRender();
    return;
  }

  // If split and active hand 2 -> proceed, or single hand -> proceed
  await bjDealerPlay();

  // side bet Bust Out: pays 2x if dealer busts
  let sideWin = 0;
  const dealerTotal=bjHandTotals(bj.dealer).sum;
  if(bj.sideBust>0 && dealerTotal>21){
    sideWin += bj.sideBust * 2;
  }

  // settle hands
  let totalCredit = 0;
  let totalLostShown = 0;

  for(let i=0;i<bj.hands.length;i++){
    const res=bjOutcomeForHand(bj.hands[i], bj.dealer);
    const bet = Number(bj.handBets[i]||bj.stake);

    if(res==="win"){
      // regular win pays 1:1 -> return stake + win = bet*2
      totalCredit += bet * 2;
    }else if(res==="push"){
      // return stake
      totalCredit += bet * 1;
    }else{
      // lose -> 0 returned
      totalLostShown += bet;
    }
  }

  totalCredit = clamp2(totalCredit + sideWin);

  if(totalCredit>0){
    try{
      await bjCredit(totalCredit);
    }catch(e){
      console.error(e);
      toast("Payout error");
    }
  }

  // show banner amount:
  // - credit > wager -> win
  // - credit == wager -> push
  // - else -> lose
  const totalHandsWager = (bj.handBets||[]).reduce((s,v)=>s + Number(v||0), 0);
  const totalWager = clamp2(totalHandsWager + bj.sidePairs + bj.sideBust);
  if(totalCredit > totalWager){
    bjSfx("win");
    bjShowPop({ win:true, amount: totalCredit, text:"added to balance" });
  }else if(totalCredit === totalWager){
    bjSfx("tap");
    bjShowPop({ win:false, amount: totalWager, text:"stake returned", status:"push" });
  }else{
    bjSfx("lose");
    bjShowPop({ win:false, amount: totalWager, text:"lost this round" });
  }

  bj.settled=true; bj.active=false;
  bjMarkOutcome();
  bjSetButtons();
  bjSetBetBtn(true);
  toast("Round settled");
}

function bjMarkOutcome(){
  // Add outlines per hand: green win / red lose / yellow push
  const dBox=$("bjDealerCards");
  const pBox=$("bjPlayerCards");
  if(!dBox || !pBox) return;

  const dealerTotal=bjHandTotals(bj.dealer).sum;
  const dealerEls=[...dBox.children];
  const handRows=[...pBox.querySelectorAll(".bjHandRow")];

  // clear classes
  dealerEls.forEach(el=>el.classList.remove("bjWin","bjLose","bjPush"));
  handRows.forEach(el=>el.classList.remove("bjWin","bjLose","bjPush"));

  const outcomes=[];

  bj.hands.forEach((hand, idx)=>{
    const row = bjGetHandRow(idx, false) || handRows[idx];
    const res = bjOutcomeForHand(hand, bj.dealer);
    outcomes.push(res);
    if(!row) return;
    if(res==="win") row.classList.add("bjWin");
    else if(res==="lose") row.classList.add("bjLose");
    else row.classList.add("bjPush");
  });

  // Only tint dealer if all outcomes match; mixed results leave dealer neutral
  const uniq = Array.from(new Set(outcomes.filter(Boolean)));
  if(uniq.length===1){
    const res=uniq[0];
    if(res==="win") dealerEls.forEach(el=>el.classList.add("bjLose"));
    else if(res==="lose") dealerEls.forEach(el=>el.classList.add("bjWin"));
    else dealerEls.forEach(el=>el.classList.add("bjPush"));
  }else if(uniq.length && dealerTotal>21){
    // Dealer bust with mixed outcomes: still show dealer as losing
    dealerEls.forEach(el=>el.classList.add("bjLose"));
  }
}

$("bjBetBtn") && ($("bjBetBtn").onclick = bjStart);
$("bjHitBtn") && ($("bjHitBtn").onclick = bjHit);
$("bjStandBtn") && ($("bjStandBtn").onclick = ()=>bjStand(false));
$("bjDoubleBtn") && ($("bjDoubleBtn").onclick = bjDouble);
$("bjSplitBtn") && ($("bjSplitBtn").onclick = bjSplit);
$("bjBetBtnM") && ($("bjBetBtnM").onclick = bjStart);
$("bjHitBtnM") && ($("bjHitBtnM").onclick = bjHit);
$("bjStandBtnM") && ($("bjStandBtnM").onclick = ()=>bjStand(false));
$("bjDoubleBtnM") && ($("bjDoubleBtnM").onclick = bjDouble);
$("bjSplitBtnM") && ($("bjSplitBtnM").onclick = bjSplit);
$("bjHomeBtnM") && ($("bjHomeBtnM").onclick = ()=>setView("home"));

// Keep mobile stake input in sync with desktop stake
const _stk=$("bjStake"), _stkM=$("bjStakeM");
if(_stk && _stkM){
  _stkM.value = _stk.value;
  _stkM.addEventListener("input", ()=>{ _stk.value = _stkM.value; });
  _stk.addEventListener("input", ()=>{ _stkM.value = _stk.value; });
}

// Sync side bets between desktop and mobile inputs
const _pairs=$("bjSidePairs"), _pairsM=$("bjSidePairsM");
const _bust=$("bjSideBust"), _bustM=$("bjSideBustM");
if(_pairs && _pairsM){
  _pairsM.value = _pairs.value;
  _pairsM.addEventListener("input", ()=>{ _pairs.value = _pairsM.value; });
  _pairs.addEventListener("input", ()=>{ _pairsM.value = _pairs.value; });
}
if(_bust && _bustM){
  _bustM.value = _bust.value;
  _bustM.addEventListener("input", ()=>{ _bust.value = _bustM.value; });
  _bust.addEventListener("input", ()=>{ _bustM.value = _bust.value; });
}

// Keep BJ balance updated when switching view / refreshing
function bjOnViewEnter(){
  bjEnsureShoe();
  bjUpdateBalanceUI();
  bjUpdateShoeUI();
  bjRender();
}

/* GAMES: Dice / Roulette / Mines */
["diceRollBtn","rouSpinBtn","minesStartBtn","minesCashBtn","openCaseBtn","mConfirm"].forEach(id=>{
  const el=$(id); if(el) el.addEventListener("click", ()=>sfx(520,0.05,"sine",0.03));
});

// Dice
$("diceRollBtn").onclick = async ()=>{
  if(!meProfile) return toast("Profile not loaded");
  const stake=Number($("diceStake").value);
  const pick=$("dicePick").value;
  const roll = Math.floor(Math.random()*100)+1;
  $("diceRollOut").textContent=String(roll);
  const win = (pick==="low") ? (roll<=49) : (roll>=50);
  const mult = 1.95;
  try{
    await addWagerAndPayout(stake, win ? stake*mult : 0);
    $("diceResOut").textContent = win ? `WIN +${to2(stake*mult - stake)}` : "LOSE";
    toast(win ? "Dice win" : "Dice lose");
  }catch(e){
    if(String(e).includes("balance")) toast("Not enough points");
    else toast("Dice error (DB/RLS/SQL)");
    console.error(e);
  }
};

// Roulette
$("rouSpinBtn").onclick = async ()=>{
  if(!meProfile) return toast("Profile not loaded");
  const stake=Number($("rouStake").value);
  const pick=$("rouPick").value;
  const n = Math.floor(Math.random()*37);
  let color = "green";
  if(n===0) color="green";
  else if(n>=1 && n<=18) color="red";
  else color="black";
  $("rouOut").textContent = `${n} (${color})`;
  const mult = (pick==="green") ? 14 : 1.95;
  const win = (pick===color);
  try{
    await addWagerAndPayout(stake, win ? stake*mult : 0);
    $("rouRes").textContent = win ? `WIN +${to2(stake*mult - stake)}` : "LOSE";
    toast(win ? "Roulette win" : "Roulette lose");
  }catch(e){
    if(String(e).includes("balance")) toast("Not enough points");
    else toast("Roulette error (DB/RLS/SQL)");
    console.error(e);
  }
};

// =======================
// =======================
// MINES (UPGRADED)
// - Bombs 1..24
// - True probability multipliers (with house edge)
// - Right ladder UI + animated X
// - Top old multiplier removed; show Current payout instead
// =======================

const MINES_HOUSE_EDGE = 0.01; // 1% house edge (Stake-like feel). Change to 0.04 for 4%.

let mines = {
  active: false,
  bombs: 1,
  stake: 0,
  mult: 1.0,
  bombSet: new Set(),
  revealed: new Set(),   // safe picks only
  ended: false
};

function setMinesUiState(active){
  const startBtn = $("minesStartBtn");
  const cashBtn  = $("minesCashBtn");
  if(!startBtn || !cashBtn) return;

  if(active){
    startBtn.disabled = true;
    startBtn.textContent = "Bet placed ‚úì";
    startBtn.style.opacity = "0.55";
    startBtn.style.cursor = "not-allowed";
    cashBtn.disabled = false;
  } else {
    startBtn.disabled = false;
    startBtn.textContent = "Start";
    startBtn.style.opacity = "1";
    startBtn.style.cursor = "pointer";
    cashBtn.disabled = true;
  }
}

function minesResetUI(){
  const grid = $("minesGrid");
  if(!grid) return;
  grid.innerHTML = "";

  for(let i=0;i<25;i++){
    const b=document.createElement("button");
    b.className="btn";
    b.style.height="70px";
    b.style.borderRadius="16px";
    b.style.background="rgba(0,0,0,.35)";
    // anchor for explosion effects
    b.style.position = "relative";
    b.style.overflow = "visible";
    b.textContent=" ";
    b.onclick=()=>minesPick(i,b);
    grid.appendChild(b);
  }
}

function revealAllMines(){
  const grid = $("minesGrid");
  if(!grid) return;
  const tiles = [...grid.children];
  tiles.forEach((t, idx)=>{
    if(mines.bombSet.has(idx)){
      t.innerHTML = bombRed();
      t.classList.add("minesBombTile","bombHit","bombPulse");
      t.style.position = "relative";
    }
  });
}

function endMinesRound(statusLabel){
  mines.active = false;
  mines.ended = true;
  setMinesUiState(false);
  $("minesStatus").textContent = statusLabel;
}

/* ---------- multipliers (probability-based) ----------
   Fair multiplier after k safe picks:
     1 / P(survive k picks)
   where P(survive k picks) = C(25-bombs, k) / C(25, k)

   Apply house edge:
     mult = fair * (1 - houseEdge)
----------------------------------------------------- */
function minesMultiplier(k, bombs){
  // Stake-like product formula for P(survive k picks):
  // P = Œ†_{i=0..k-1} (safe - i) / (total - i)
  const total = 25;
  const safe = total - bombs;

  if(k <= 0) return 1.00;
  if(k > safe) k = safe;

  let p = 1.0;
  for(let i=0; i<k; i++){
    p *= (safe - i) / (total - i);
  }

  const fair = 1 / Math.max(p, 1e-15);
  const edged = fair * (1 - MINES_HOUSE_EDGE);

  // round to 2 decimals for display
  return Math.max(1.00, Math.round((edged + Number.EPSILON) * 100) / 100);
}

function buildMinesLadder(bombs){
  const safe = 25 - bombs;
  const ladder = [];
  for(let k=1; k<=safe; k++){
    ladder.push({ k, x: minesMultiplier(k, bombs) });
  }
  return ladder;
}

function renderMinesLadder(){
  const bombs = mines.bombs;
  const safe = 25 - bombs;

  $("minesRightBombs").textContent = String(bombs);
  $("minesRightPicks").textContent = String(mines.revealed.size);

  const ladderEl = $("minesLadder");
  const floatEl  = $("minesXFloat");

  if(!ladderEl || !floatEl) return;

  const ladder = buildMinesLadder(bombs);
  ladderEl.innerHTML = "";

  const currentK = mines.revealed.size; // 0..safe
  const currentX = (currentK<=0) ? 1.00 : minesMultiplier(currentK, bombs);

  // floating X (animated bump)
  floatEl.classList.remove("bump");
  void floatEl.offsetWidth; // reflow for restart animation
  floatEl.classList.add("bump");
  floatEl.textContent = `x${to2(currentX)}`;

  ladder.forEach(step=>{
    const row = document.createElement("div");
    row.className = "minesStep" + (step.k === currentK ? " active" : "");
    row.innerHTML = `
      <div class="left">
        <div class="pickNo">${step.k}</div>
        <div class="mx">x${to2(step.x)}</div>
      </div>
      <div class="sub">${step.k===1 ? "1st pick" : `${step.k} picks`}</div>
    `;
    ladderEl.appendChild(row);
  });

  // keep active row in view
  const active = ladderEl.querySelector(".minesStep.active");
  if(active){
    active.scrollIntoView({ block:"nearest", behavior:"smooth" });
  }
}

function updateMinesTopPayout(){
  const stake = Number(mines.stake || $("minesStake").value || 0);
  const x = Number(mines.mult || 1);
  const payout = stake * x;
  $("minesPayoutTop").textContent = stake>0 ? to2(payout) : "‚Äî";
}

let __minesWinTimer = null;

function showMinesPop({ amount, mult=null, win=true }){
  const el = $("minesCenterPop");
  if(!el) return;

  el.classList.remove("hide");
  el.classList.toggle("lose", !win);

  $("minesPopLabel").textContent = win ? "CASHED OUT" : "BOMB";
  $("minesPopAmt").textContent = to2(amount);
  $("minesPopSub").textContent = win ? "added to balance" : "round lost";

  // ‚úÖ multiplier smaller than payout
  const mxEl = $("minesPopMx");
  if(mxEl){
    if(mult == null){
      mxEl.style.display = "none";   // hide if you don't want it
    }else{
      mxEl.style.display = "";
      mxEl.textContent = `x${to2(mult)}`;
    }
  }

  el.classList.add("show");
  clearTimeout(el._t);
  el._t = setTimeout(()=>{
    el.classList.add("hide");
    setTimeout(()=>el.classList.remove("show","hide"), 220);
  }, 2200);
}

function hideMinesPop({ immediate=false } = {}){
  const el = $("minesCenterPop");
  if(!el) return;
  
  clearTimeout(el._t);
  
  if(!el.classList.contains("show")) return;
  
  if(immediate){
    el.classList.remove("hide");
    el.classList.remove("show");
    return;
  }
  
  el.classList.add("hide");
  setTimeout(()=>{
    el.classList.remove("hide");
    el.classList.remove("show");
  }, 220);
}

function spawnSparks(btn, n=10){
  btn.style.position = "relative";
  const total = n;
  for(let i=0;i<total;i++){
    const isDot = Math.random() < 0.35;
    const el = document.createElement("div");
    el.className = isDot ? "sparkDot" : "spark";
    
    const ang = Math.random() * Math.PI * 2;
    const dist = 26 + Math.random() * 34;
    const dx = Math.cos(ang) * dist;
    const dy = Math.sin(ang) * dist;
    
    el.style.setProperty("--dx", dx.toFixed(1) + "px");
    el.style.setProperty("--dy", dy.toFixed(1) + "px");
    el.style.animationDelay = (Math.random()*0.04).toFixed(3) + "s";
    
    btn.appendChild(el);
    setTimeout(()=>el.remove(), 800);
  }
}

// spawn a centered explosion (ring + sparks) on a tile
function spawnExplosionOn(btn){
  if(!btn) return;
  const boom = document.createElement("div");
  boom.className = "boom";

  // 8 sparks around
  for(let i=0;i<8;i++){
    const s = document.createElement("div");
    s.className = "spark";
    s.style.setProperty("--a", (i*45) + "deg");
    boom.appendChild(s);
  }

  btn.appendChild(boom);
  setTimeout(()=>boom.remove(), 520);
}

async function doMinesCashout({ auto=false } = {}){
  if(!mines.active || mines.ended) return;

  const safePicks = mines.revealed.size;
  if(safePicks === 0) return toast("Pick at least 1 tile");

  const payout = mines.stake * mines.mult;

  try{
    const newPts = clamp2(Number(meProfile.pts) + payout);
    const { error } = await supabase
      .from("profiles")
      .update({ pts:newPts })
      .eq("id", session.user.id);
    if(error) throw error;

    meProfile.pts = newPts;
    updateMeUI();
    showMinesPop({ amount: payout, mult: mines.mult, win:true });

    // ‚úÖ play money sound ONCE
    sfxCashout();

    // ‚úÖ reveal bombs after cashout
    revealAllMines();

    toast(auto ? `Auto cashout +${to2(payout)}` : `Cashout +${to2(payout)}`);
    endMinesRound("CASHED");
  }catch(e){
    toast("Cashout failed (DB/RLS)");
    console.error(e);
  }
}

async function minesPick(i, btn){
  if(!mines.active) return toast("Start mines first");
  if(mines.ended) return;
  if(btn.dataset.locked === "1") return;

  btn.dataset.locked = "1";

  // BOMB clicked
  if(mines.bombSet.has(i)){
    // keep tile background normal (no red square)
    btn.style.background = "rgba(0,0,0,.35)";
    btn.style.borderColor = "rgba(255,255,255,.14)";

    // bomb icon glows (not the tile)
    btn.innerHTML = `<div class="bombIcon">üí£</div>`;
    btn.classList.add("bombHit");

    // explosion only on clicked tile
    spawnExplosionOn(btn);

    sfxBomb();

    // reveal other bombs (no explosions for them)
    revealAllMines();
    showMinesPop({ amount: 0, mult: null, win:false });

    endMinesRound("BOMB");
    toast("Boom üí£");
    return;
  }

  // SAFE clicked
  mines.revealed.add(i);
  btn.innerHTML = gemYellowMines();
  btn.style.background="rgba(34,197,94,.10)";
  btn.classList.add("gemHit");
  sfxGem();

  const safePicks = mines.revealed.size;

  // ‚úÖ real multiplier
  mines.mult = minesMultiplier(safePicks, mines.bombs);

  $("minesStatus").textContent = "LIVE";

  // ‚úÖ update right ladder + payout
  renderMinesLadder();
  updateMinesTopPayout();

  // ‚úÖ AUTO CASHOUT when only mines remain
  const totalSafe = 25 - mines.bombs;
  if(safePicks >= totalSafe){
    await doMinesCashout({ auto:true });
  }
}

function fillBombsSelect(){
  const sel = $("minesBombs");
  if(!sel) return;
  sel.innerHTML = "";
  for(let b=1; b<=24; b++){
    const o=document.createElement("option");
    o.value = String(b);
    o.textContent = `${b} bomb${b===1?"":"s"}`;
    sel.appendChild(o);
  }
  sel.value = "1";
}

$("minesStartBtn").onclick = async ()=> {
  hideMinesPop({ immediate:true });
  
  if(!meProfile) return toast("Profile not loaded");
  if(mines.active) return; // already playing

  const stake = Number($("minesStake").value);
  const bombs = Number($("minesBombs").value);

  if(!(stake>0)) return toast("Stake > 0");
  if(stake < 0.01) return toast("Min 0.01");
  if(!(bombs>=1 && bombs<=24)) return toast("Bombs must be 1-24");

  // remove stake now + count wager (your existing logic)
  try{
    await addWagerAndPayout(stake, 0);
  }catch(e){
    if(String(e).includes("balance")) return toast("Not enough points");
    toast("Mines start error (DB/RLS/SQL)");
    console.error(e);
    return;
  }

  // start round
  mines.active = true;
  mines.ended = false;
  mines.bombs = bombs;
  mines.stake = stake;
  mines.revealed = new Set();
  mines.mult = 1.0;

  mines.bombSet = new Set();
  while(mines.bombSet.size < bombs){
    mines.bombSet.add(Math.floor(Math.random()*25));
  }

  minesResetUI();
  $("minesStatus").textContent="LIVE";

  setMinesUiState(true);

  // ‚úÖ init ladder + payout
  renderMinesLadder();
  updateMinesTopPayout();

  toast("Mines started");
};

$("minesCashBtn").onclick = async ()=> {
  if(!mines.active) return toast("No active round");
  await doMinesCashout({ auto:false });
};

// init
fillBombsSelect();
setMinesUiState(false);
minesResetUI();
renderMinesLadder();
$("minesPayoutTop").textContent = "‚Äî";

/* AUTH */
$("btnSignIn").onclick=async ()=>{
  if(!supabase) return;
  const email=$("inEmail").value.trim(); const password=$("inPass").value;
  const { error } = await supabase.auth.signInWithPassword({ email, password });
  if(error) toast(error.message);
};
$("btnForgot").onclick=async ()=>{
  if(!supabase) return;
  const email=$("inEmail").value.trim(); if(!email) return toast("Enter email");
  const { error } = await supabase.auth.resetPasswordForEmail(email);
  if(error) toast(error.message); else toast("Reset email sent");
};
$("btnSignUp").onclick=async ()=>{
  if(!supabase) return;
  const display_name=$("upName").value.trim();
  const email=$("upEmail").value.trim();
  const password=$("upPass").value;
  if(!display_name) return toast("Enter username");
  const { error } = await supabase.auth.signUp({ email, password, options:{ data:{ display_name } } });
  if(error) return toast(error.message);
  toast("Account created. If email confirm is ON, confirm then sign in.");
};

/* buttons */
$("refreshBtn").onclick=async ()=>{
  if(!supabase) return;
  await maybeRollMonth();
  await ensureProfile();
  await normalizeMonthForMe();
  updateMeUI();
  await loadEvents();
  await loadMyBets();
  refreshCaseUI();
  if(isAdmin) await loadAdminEvents();
  toast("Refreshed");
};
$("signOutBtn").onclick=async ()=>{ if(!supabase) return; await supabase.auth.signOut(); };

async function showApp(){
  $("authWrap").classList.remove("show");
  $("app").classList.add("show");
  isAdmin = (session?.user?.email||"").toLowerCase() === ADMIN_EMAIL.toLowerCase();
  await maybeRollMonth();
  await ensureProfile();

  if(meProfile && isAdmin && meProfile.display_name !== ADMIN_DISPLAY_NAME){
    await supabase.from("profiles").update({ display_name: ADMIN_DISPLAY_NAME }).eq("id", session.user.id);
    meProfile.display_name = ADMIN_DISPLAY_NAME;
  }

  await normalizeMonthForMe();
  renderGames();
  updateMeUI();
  await loadEvents();
  await loadMyBets();
  refreshCaseUI();
  if(isAdmin) await loadAdminEvents();
  setView("home");
}
function showAuth(){
  $("app").classList.remove("show");
  $("authWrap").classList.add("show");
}

if(supabase){
  const { data } = await supabase.auth.getSession();
  session=data.session;
  if(session) await showApp(); else showAuth();
  supabase.auth.onAuthStateChange(async (_ev, newSession)=>{
    session=newSession;
    if(session) await showApp(); else showAuth();
  });
} else {
  showAuth();
}
</script>
</body>
</html>