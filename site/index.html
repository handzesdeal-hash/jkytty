<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>HANDZES.BET</title>
<meta name="theme-color" content="#07040f"/>
<style>
:root{
  --bg:#050508; --bg2:#070614;
  --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.62);
  --stroke:rgba(255,255,255,.10);
  --purple:#7c3aed; --purple2:#a78bfa; --red:#ef4444; --green:#22c55e; --amber:#f59e0b;
  --shadow:0 18px 60px rgba(0,0,0,.62);
  --shadow2:0 10px 40px rgba(0,0,0,.55);
  --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
  --sans:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;color:var(--text);font-family:var(--sans);
  background:
    radial-gradient(1200px 900px at 18% 12%, rgba(124,58,237,.22), transparent 60%),
    radial-gradient(1200px 900px at 82% 12%, rgba(239,68,68,.14), transparent 60%),
    linear-gradient(180deg, var(--bg), var(--bg2));
  overflow-x:hidden;
}
.glow{filter: drop-shadow(0 0 10px rgba(167,139,250,.35)) drop-shadow(0 0 22px rgba(124,58,237,.18));}
.iconSvg{width:26px;height:26px;vertical-align:-3px;margin-left:0}
.iconPoop{width:22px;height:22px;vertical-align:-5px;margin-left:6px;filter: drop-shadow(0 0 10px rgba(0,0,0,.6));}

@keyframes shake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-4px)} 40%{transform:translateX(4px)} 60%{transform:translateX(-3px)} 80%{transform:translateX(3px)} }
@keyframes pop { 0%{transform:scale(.92)} 60%{transform:scale(1.08)} 100%{transform:scale(1)} }
@keyframes sparkle { 0%{filter:brightness(1)} 50%{filter:brightness(1.6)} 100%{filter:brightness(1)} }
.bombHit{animation: shake .35s ease-in-out}
.gemHit{animation: pop .18s ease-out, sparkle .55s ease-in-out}

.authWrap{min-height:100vh;display:none;align-items:center;justify-content:center;padding:22px;}
.authWrap.show{display:flex;}
.authCard{
  width:min(520px,100%);border-radius:22px;border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.32);box-shadow: var(--shadow);backdrop-filter: blur(14px);overflow:hidden;
}
.authTop{padding:16px;border-bottom:1px solid rgba(255,255,255,.10);display:flex;align-items:center;gap:12px;}
.mark{width:44px;height:44px;border-radius:16px;background:linear-gradient(135deg, rgba(124,58,237,.95), rgba(239,68,68,.88));border:1px solid rgba(255,255,255,.18);box-shadow:0 10px 28px rgba(0,0,0,.55);}
.authTop b{letter-spacing:.22em;font-size:15px;}
.authBody{padding:16px;}
.tabs{display:flex;gap:10px;margin-bottom:12px;}
.tab{flex:1;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:rgba(255,255,255,.86);font-weight:950;cursor:pointer}
.tab.active{background:rgba(124,58,237,.20);border-color:rgba(167,139,250,.22)}
label{font-size:12px;color:var(--muted);font-weight:900;}
input,select{
  width:100%;margin-top:6px;padding:11px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.22);color: rgba(255,255,255,.92);outline:none;font-size:13px;
}
input:focus,select:focus{border-color: rgba(167,139,250,.38);box-shadow:0 0 0 4px rgba(124,58,237,.16)}
.row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
.btn{
  border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.06);color: rgba(255,255,255,.92);
  padding:11px 12px;border-radius:14px;font-weight:950;font-size:13px;cursor:pointer;user-select:none;
}
.btn:hover{background: rgba(255,255,255,.09)}
.btn:active{transform: translateY(1px)}
.btn.purple{background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(167,139,250,.72));border-color:rgba(255,255,255,.16)}
.btn.red{background: linear-gradient(135deg, rgba(239,68,68,.95), rgba(251,113,133,.82));border-color:rgba(255,255,255,.16)}
.btn.green{background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(134,239,172,.78));border-color:rgba(255,255,255,.16)}
.btn:disabled{opacity:.55;cursor:not-allowed}
.small{font-size:12px;color:var(--muted);line-height:1.35;margin-top:10px}

/* =======================
   MINES UPGRADE (right ladder)
   ======================= */

.minesWrap{
  margin-top:14px;
  display:grid;
  grid-template-columns: 520px 1fr;
  gap:14px;
  align-items:start;
}
@media(max-width:980px){
  .minesWrap{ grid-template-columns: 1fr; }
}

#minesGrid{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:10px;
  max-width:520px;
}

.minesRight{
  position:relative;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.28);
  border-radius:18px;
  padding:12px;
  overflow:hidden;
  min-height: 380px;
  box-shadow:0 16px 50px rgba(0,0,0,.45);
}
.minesRight::before{
  content:"";
  position:absolute;
  inset:-40%;
  background:
    radial-gradient(closest-side at 30% 30%, rgba(124,58,237,.22), transparent 60%),
    radial-gradient(closest-side at 70% 20%, rgba(239,68,68,.14), transparent 60%),
    conic-gradient(from 180deg, rgba(167,139,250,.12), transparent, rgba(239,68,68,.10), transparent);
  filter: blur(2px);
  pointer-events:none;
}

.minesRightHd{ position:relative; display:flex; justify-content:space-between; align-items:flex-end; gap:10px; }
.minesRightTitle{
  font-weight:1000;
  letter-spacing:.18em;
  font-size:12px;
  color: rgba(255,255,255,.92);
  text-transform:uppercase;
}
.minesRightSub{
  font-size:12px;
  color: rgba(255,255,255,.60);
  font-weight:900;
}

.minesLadder{
  position:relative;
  margin-top:10px;
  display:flex;
  flex-direction:column-reverse;
  gap:8px;
  max-height: 300px;
  overflow:auto;
  padding-right:6px;
}
.minesLadder::-webkit-scrollbar{ width:8px; }
.minesLadder::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.12); border-radius:999px; }

.minesStep{
  position:relative;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.32);
  backdrop-filter: blur(10px);
}
.minesStep .left{
  display:flex; align-items:center; gap:10px;
  min-width:0;
}
.minesStep .pickNo{
  width:30px; height:30px; border-radius:12px;
  display:flex; align-items:center; justify-content:center;
  font-weight:1000;
  font-size:12px;
  color: rgba(255,255,255,.72);
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
}
.minesStep .mx{
  font-family: var(--sans);
  font-weight:1000;
  letter-spacing:.02em;
  font-size:15px;
  color: rgba(255,255,255,.96);
  white-space:nowrap;
}
.minesStep .sub{
  font-size:11px;
  color: rgba(255,255,255,.55);
  font-weight:900;
  white-space:nowrap;
}

.minesStep.active{
  border-color: rgba(255,255,255,.22);
  background: rgba(255,255,255,.06);
  box-shadow: 0 0 0 4px rgba(255,255,255,.06), 0 18px 55px rgba(0,0,0,.55);
}
.minesStep.active .pickNo{
  color: rgba(255,255,255,.92);
  border-color: rgba(255,255,255,.18);
  background: rgba(255,255,255,.08);
}

@keyframes xJump{
  0%{ transform: translateY(8px) scale(.96); opacity:.0; }
  40%{ opacity:1; }
  100%{ transform: translateY(0) scale(1); opacity:1; }
}
.minesXFloat{
  position:absolute;
  right:14px;
  top:14px;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.55);
  backdrop-filter: blur(12px);
  font-weight:1000;
  font-size:14px;
  color: rgba(255,255,255,.96);
  animation: xJump .22s ease-out;
  box-shadow:0 18px 55px rgba(0,0,0,.55);
  z-index:2;
}
.minesXFloat.bump{ animation: xJump .22s ease-out; }

/* =======================
   MINES CENTER POPUP ‚Äî CLEAN & BALANCED
   ======================= */

.minesCenterPop{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%) scale(.92);
  width:min(280px, 80%);
  padding:14px;
  border-radius:22px;

  /* cleaner glass, less tint */
  background:
    radial-gradient(120% 120% at 30% 20%, rgba(255,255,255,.14), transparent 55%),
    rgba(12,12,18,.78);

  /* ‚úÖ black outline + inner edge */
  border:1px solid rgba(0,0,0,.85);
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,.10),
    0 26px 90px rgba(0,0,0,.75),
    0 0 28px rgba(34,197,94,.18);

  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);

  display:none;
  z-index:50;
  text-align:center;
  pointer-events:none;
}

/* softer glow ring */
.minesCenterPop::before{
  content:"";
  position:absolute;
  inset:-2px;
  border-radius:24px;
  background:
    linear-gradient(135deg,
      rgba(34,197,94,.0),
      rgba(34,197,94,.55),
      rgba(34,197,94,.0)
    );
  filter: blur(10px);
  opacity:.45;
  z-index:0;
}

/* inner panel */
.minesCenterPop .inner{
  position:relative;
  z-index:1;
  border-radius:16px;
  background: rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.14);
  padding:14px 14px 12px;
}

/* label */
.minesCenterPop .label{
  font-size:11px;
  font-weight:900;
  letter-spacing:.18em;
  text-transform:uppercase;
  color: rgba(255,255,255,.70);
  margin-bottom:8px;
}

/* ‚úÖ payout still dominant but smaller */
.minesCenterPop .amt{
  font-family: var(--mono);
  font-weight:1000;
  font-size:34px;
  line-height:1.05;
  color: rgba(255,255,255,.96);
  text-shadow: 0 0 16px rgba(34,197,94,.22);
}

/* multiplier secondary */
.minesCenterPop .mx{
  margin-top:8px;
  font-family: var(--mono);
  font-weight:900;
  font-size:16px;
  color: rgba(34,197,94,.95);
}

/* footer */
.minesCenterPop .sub{
  margin-top:10px;
  font-size:12px;
  font-weight:800;
  color: rgba(255,255,255,.65);
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
}

.minesCenterPop .dot{
  width:8px;
  height:8px;
  border-radius:999px;
  background: rgba(34,197,94,.95);
  box-shadow: 0 0 10px rgba(34,197,94,.45);
}

/* pop animation (calmer) */
@keyframes minesPopIn {
  0%   { opacity:0; transform:translate(-50%,-50%) scale(.86); }
  60%  { opacity:1; transform:translate(-50%,-50%) scale(1.03); }
  100% { opacity:1; transform:translate(-50%,-50%) scale(1); }
}
@keyframes minesPopOut {
  to { opacity:0; transform:translate(-50%,-50%) scale(.96); }
}

.minesCenterPop.show{
  display:block;
  animation: minesPopIn .22s ease-out;
}
.minesCenterPop.hide{
  animation: minesPopOut .18s ease-in forwards;
}

/* lose variant */
.minesCenterPop.lose{
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,.08),
    0 26px 90px rgba(0,0,0,.75),
    0 0 28px rgba(239,68,68,.18);
}
.minesCenterPop.lose::before{
  background:
    linear-gradient(135deg,
      rgba(239,68,68,.0),
      rgba(239,68,68,.55),
      rgba(239,68,68,.0)
    );
}
.minesCenterPop.lose .mx{
  color: rgba(239,68,68,.95);
}
.minesCenterPop.lose .dot{
  background: rgba(239,68,68,.95);
  box-shadow: 0 0 10px rgba(239,68,68,.45);
}

/* =======================
   MINES TILE ICON SIZES
   ======================= */
.minesGemSvg{
  width:34px;
  height:34px;
  filter: drop-shadow(0 0 10px rgba(253,230,138,.35)) drop-shadow(0 0 20px rgba(34,197,94,.12));
}

.minesBombSvg{
  width:34px;
  height:34px;
  filter: drop-shadow(0 0 10px rgba(239,68,68,.45)) drop-shadow(0 0 26px rgba(239,68,68,.20));
}

/* Bomb tile look */
.minesBombTile{
  background: rgba(239,68,68,.14) !important;
  border-color: rgba(239,68,68,.28) !important;
  box-shadow:
    inset 0 0 0 1px rgba(0,0,0,.55),
    0 0 0 4px rgba(239,68,68,.06),
    0 0 24px rgba(239,68,68,.18) !important;
}

/* =======================
   BOMB ICON + EXPLOSION (anchored to tile)
   ======================= */
.bombIcon{
  font-size:30px;line-height:1;display:inline-flex;align-items:center;justify-content:center;
  filter: drop-shadow(0 0 10px rgba(239,68,68,.65)) drop-shadow(0 0 22px rgba(239,68,68,.35));
  animation: bombPulse 0.85s ease-in-out infinite;
}

@keyframes bombPulse{
  0%,100%{ transform: scale(1); filter: drop-shadow(0 0 10px rgba(239,68,68,.55)) drop-shadow(0 0 22px rgba(239,68,68,.30)); }
  50%{ transform: scale(1.06); filter: drop-shadow(0 0 14px rgba(239,68,68,.75)) drop-shadow(0 0 28px rgba(239,68,68,.45)); }
}

/* explosion container anchored to tile */
.boom{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  width:10px;
  height:10px;
  pointer-events:none;
  z-index:10;
}

/* big shockwave ring */
.boom::before{
  content:"";
  position:absolute;
  inset:-52px;
  border-radius:999px;
  background:
    radial-gradient(circle,
      rgba(255,255,255,.30) 0%,
      rgba(239,68,68,.42) 18%,
      rgba(239,68,68,.18) 38%,
      rgba(239,68,68,0) 72%);
  filter: blur(1px);
  animation: boomRing .34s ease-out forwards;
}

@keyframes boomRing{
  0%{ transform:scale(.18); opacity:0; }
  18%{ opacity:1; }
  100%{ transform:scale(1.25); opacity:0; }
}

/* hot core flash */
.boom::after{
  content:"";
  position:absolute;
  inset:-20px;
  border-radius:999px;
  background: radial-gradient(circle, rgba(255,255,255,.55), rgba(239,68,68,.22), rgba(239,68,68,0) 70%);
  animation: boomFlash .22s ease-out forwards;
}
@keyframes boomFlash{
  0%{ transform:scale(.55); opacity:0; }
  30%{ opacity:1; }
  100%{ transform:scale(1.2); opacity:0; }
}

/* sparks */
.spark{
  position:absolute;
  left:50%;
  top:50%;
  width:4px;
  height:16px;
  border-radius:999px;
  transform-origin:50% 100%;
  background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,180,180,.92), rgba(239,68,68,.95), rgba(239,68,68,0));
  filter: drop-shadow(0 0 12px rgba(239,68,68,.55)) drop-shadow(0 0 22px rgba(239,68,68,.25));
  animation: sparkFly .52s ease-out forwards;
}

@keyframes sparkFly{
  0%{ transform: translate(-50%,-50%) rotate(var(--a)) translateY(0) scale(1); opacity:1; }
  100%{ transform: translate(-50%,-50%) rotate(var(--a)) translateY(-74px) scale(.55); opacity:0; }
}

@keyframes sparkDot {
  0%   { transform: translate(0,0) scale(.8); opacity: 0; }
  15%  { opacity: 1; }
  100% { transform: translate(var(--dx), var(--dy)) scale(.1); opacity: 0; }
}
.sparkDot{
  position:absolute;
  left:50%;
  top:50%;
  width:5px;
  height:5px;
  border-radius:999px;
  transform: translate(-50%,-50%);
  background: radial-gradient(circle, rgba(255,255,255,.95) 0%, rgba(239,68,68,.9) 55%, rgba(239,68,68,0) 80%);
  filter: blur(.2px);
  pointer-events:none;
  z-index:6;
  animation: sparkDot .6s ease-out forwards;
}

/* ===== Mines win popup state management ===== */
.minesWinOverlay{
  position:absolute;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:30;
  pointer-events:none;
}
.minesWinOverlay.show{
  display:flex;
  pointer-events:auto;
}

.app{display:none;grid-template-columns:280px 1fr;min-height:100vh;}
.app.show{display:grid;}
@media(max-width:980px){.app{grid-template-columns:1fr}.sidebar{position:sticky;top:0;z-index:50;height:auto}.main{padding-top:10px}}
.sidebar{
  height:100vh;overflow:auto;padding:14px 12px 16px;border-right:1px solid rgba(255,255,255,.08);
  background: rgba(0,0,0,.30);backdrop-filter: blur(14px);
}
.brand{display:flex;align-items:center;gap:10px;padding:10px 10px 12px;border-radius:16px;border:1px solid rgba(255,255,255,.10);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));box-shadow: var(--shadow2)}
.logo{width:40px;height:40px;border-radius:14px;background:linear-gradient(135deg, rgba(124,58,237,.95), rgba(239,68,68,.88));
  border:1px solid rgba(255,255,255,.18);box-shadow:0 10px 28px rgba(0,0,0,.55)}
.brand b{letter-spacing:.22em;font-weight:1000;}
.brand small{display:block;color:var(--muted);margin-top:2px;font-size:12px;}
.sideTitle{margin-top:12px;padding:10px 10px 6px;color: rgba(255,255,255,.50);font-size:11px;font-weight:950;letter-spacing:.18em;text-transform:uppercase;}
.navBtn{
  width:100%;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:11px 12px;border-radius:16px;border:1px solid transparent;
  background:transparent;color: rgba(255,255,255,.86);cursor:pointer;font-weight:950;font-size:13px;user-select:none;
}
.navBtn:hover{background: rgba(255,255,255,.06)}
.navBtn.active{background: rgba(124,58,237,.18);border-color: rgba(167,139,250,.22)}
.chip{font-family:var(--mono);font-size:11px;padding:4px 9px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.18);color: rgba(255,255,255,.78);white-space:nowrap;}
.chip.ok{border-color: rgba(34,197,94,.22);background: rgba(34,197,94,.10);}
.sideCard{margin-top:10px;border:1px solid rgba(255,255,255,.10);background: rgba(0,0,0,.22);border-radius:18px;padding:12px;box-shadow:0 16px 50px rgba(0,0,0,.45);}
.pill{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:9px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.18);color: rgba(255,255,255,.72);font-size:12px;margin-top:8px;}
.pill:first-child{margin-top:0}
.mono{font-family:var(--mono)}
.muted{color:var(--muted)}
.main{padding:14px 16px 42px;overflow:auto;}
.topbar{
  display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
  border:1px solid rgba(255,255,255,.10);background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
  border-radius:18px;padding:12px;box-shadow: var(--shadow);position:sticky;top:10px;z-index:40;
  /* remove heavy blur (causes moving seam/artifact). keep a subtle solid bg */
  backdrop-filter: none;
  -webkit-backdrop-filter: none;
  background: rgba(0,0,0,.45);
}
.centerBrand{display:flex;align-items:center;gap:12px;margin:0 auto;opacity:.98;}
.mark2{width:26px;height:26px;border-radius:10px;background:linear-gradient(135deg, rgba(124,58,237,.95), rgba(239,68,68,.85));border:1px solid rgba(255,255,255,.18);}
.title{font-weight:1000;letter-spacing:.30em;font-size:18px;}
.walletMid{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background: rgba(0,0,0,.22);font-weight:950;font-size:12.5px;}
.dot{width:8px;height:8px;border-radius:999px;background:var(--purple2);box-shadow:0 0 0 4px rgba(167,139,250,.14);}
.profileBtn{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.20);cursor:pointer;user-select:none;}
.avatar{width:26px;height:26px;border-radius:10px;background:radial-gradient(16px 16px at 30% 30%, rgba(167,139,250,.95), rgba(124,58,237,.55));border:1px solid rgba(255,255,255,.16);}
.levelWrap{margin-top:6px;width:170px}
.levelBar{height:8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.28);overflow:hidden}
.levelFill{height:100%;width:0%;background:linear-gradient(90deg, rgba(124,58,237,.9), rgba(167,139,250,.75));box-shadow:0 0 18px rgba(124,58,237,.25);}
.levelText{font-size:11px;color:var(--muted);margin-top:4px;display:flex;justify-content:space-between}

.section{margin-top:12px;border:1px solid rgba(255,255,255,.10);background: rgba(0,0,0,.16);border-radius:18px;overflow:hidden;box-shadow:0 14px 55px rgba(0,0,0,.45);}
.sectionHd{padding:14px;border-bottom:1px solid rgba(255,255,255,.07);display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap;}
.sectionHd h3{margin:0;font-size:14px;}
.sub{color:var(--muted);font-size:12px;margin-top:4px;line-height:1.35;}
.sectionBd{padding:14px;}
.grid{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;}
@media(max-width:1300px){.grid{grid-template-columns:repeat(4,1fr);}}
@media(max-width:980px){.grid{grid-template-columns:repeat(2,1fr);}}
@media(max-width:520px){.grid{grid-template-columns:1fr;}}
.tile{border:1px solid rgba(255,255,255,.10);background: rgba(0,0,0,.35);border-radius:18px;overflow:hidden;cursor:pointer;user-select:none;
  transition: transform .08s ease, border-color .15s ease, background .15s ease;box-shadow:0 18px 55px rgba(0,0,0,.50);}
.tile:hover{transform: translateY(-1px);border-color: rgba(255,255,255,.18);background: rgba(0,0,0,.44);}
.tileArt{height:120px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.tileArt::before{content:"";position:absolute;inset:-40%;
  background:
    radial-gradient(closest-side at 30% 30%, rgba(124,58,237,.55), transparent 60%),
    radial-gradient(closest-side at 70% 30%, rgba(239,68,68,.28), transparent 60%),
    conic-gradient(from 180deg, rgba(167,139,250,.24), transparent, rgba(239,68,68,.20), transparent);
  filter: blur(2px);
}
.tileArt span{position:relative;font-size:34px}
.tileBody{padding:12px;}
.tileTitle{font-weight:950;font-size:13px;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.tileDesc{color:var(--muted);font-size:11.5px;margin-top:6px;line-height:1.35;height:32px;overflow:hidden;}
.tileMeta{margin-top:10px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
.tag{display:inline-flex;align-items:center;padding:5px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.05);font-size:11.5px;font-weight:950;white-space:nowrap;}
.tag.open{background: rgba(34,197,94,.10);border-color: rgba(34,197,94,.18);}
.tag.closed{background: rgba(245,158,11,.10);border-color: rgba(245,158,11,.18);}
.tag.settled{background: rgba(239,68,68,.10);border-color: rgba(239,68,68,.18);}
.tag.pending{background: rgba(124,58,237,.12);border-color: rgba(167,139,250,.22);}
.oddsMini{font-family:var(--mono);font-size:11px;color: rgba(255,255,255,.72);}

table{width:100%;border-collapse:collapse;border-radius:16px;border:1px solid rgba(255,255,255,.10);background: rgba(0,0,0,.24);overflow:hidden;}
th,td{padding:9px;border-bottom:1px solid rgba(255,255,255,.08);font-size:12.5px;}
th{color:var(--muted);font-weight:950;letter-spacing:.2px;}
tr:last-child td{border-bottom:none;}

.overlay{position:fixed;inset:0;background: rgba(0,0,0,.62);backdrop-filter: blur(10px);display:none;z-index:999;align-items:center;justify-content:center;padding:18px;}
.overlay.show{display:flex;}
.modal{width:min(920px,100%);border-radius:20px;border:1px solid rgba(255,255,255,.12);background: rgba(5,5,8,.92);box-shadow:0 26px 90px rgba(0,0,0,.75);overflow:hidden;}
.modalHd{padding:14px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;}
.modalHd h4{margin:0;font-size:16px;}
.modalHd p{margin:6px 0 0;color:var(--muted);font-size:12px;line-height:1.35;max-width:70ch;}
.closeBtn{border:1px solid rgba(255,255,255,.14);background: rgba(255,255,255,.06);color:rgba(255,255,255,.90);width:40px;height:40px;border-radius:14px;cursor:pointer;font-weight:950;}
.closeBtn:hover{background: rgba(255,255,255,.10);}
.modalBd{padding:14px;}
.oddsGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px;}
@media(max-width:760px){.oddsGrid{grid-template-columns:1fr;}}
.oddBtn{border:1px solid rgba(255,255,255,.12);background: rgba(0,0,0,.50);border-radius:18px;padding:14px;cursor:pointer;display:flex;flex-direction:column;justify-content:space-between;min-height:86px;user-select:none;
  transition: transform .08s ease, background .15s ease, border-color .15s ease;}
.oddBtn:hover{background: rgba(0,0,0,.62);border-color: rgba(255,255,255,.18);}
.oddBtn:active{transform: translateY(1px);}
.oddBtn.selected{outline:2px solid rgba(167,139,250,.55);box-shadow:0 0 0 4px rgba(124,58,237,.18);}
.oddName{font-weight:950;font-size:15px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.oddCoef{font-family:var(--mono);font-size:20px;font-weight:950;color: var(--purple2);}
.oddBtn.g .oddCoef{color: rgba(34,197,94,.95);}
.oddBtn.r .oddCoef{color: rgba(239,68,68,.95);}
.modalRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,.08);}
.miniPill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background: rgba(0,0,0,.20);color: rgba(255,255,255,.74);font-size:12px;white-space:nowrap;}
.miniPill input{width:130px;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background: rgba(0,0,0,.26);color:rgba(255,255,255,.92);outline:none;font-size:12px;margin:0;}
.miniPill input:focus{border-color: rgba(167,139,250,.38);box-shadow:0 0 0 4px rgba(124,58,237,.16);}

/* case */
.caseBox{border:1px solid rgba(255,255,255,.10);background: rgba(0,0,0,.28);border-radius:18px;padding:12px;}
.caseStage{position:relative;height:140px;border-radius:16px;border:1px solid rgba(255,255,255,.10);background:
  radial-gradient(650px 260px at 20% 30%, rgba(124,58,237,.32), transparent 60%),
  radial-gradient(650px 260px at 80% 30%, rgba(239,68,68,.18), transparent 60%),
  rgba(0,0,0,.38);overflow:hidden;}
.caseLine{position:absolute;top:0;bottom:0;left:50%;width:2px;transform:translateX(-1px);
  background:linear-gradient(180deg, transparent, rgba(255,255,255,.7), transparent);filter:drop-shadow(0 0 14px rgba(255,255,255,.18));pointer-events:none;}
.caseTrack{position:absolute;top:50%;left:0;transform:translateY(-50%);display:flex;gap:14px;align-items:center;will-change:transform;padding:0 20px;}
.caseItem{width:120px;height:80px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background: rgba(0,0,0,.55);
  display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 18px 55px rgba(0,0,0,.55);user-select:none;}
.caseItem .amt{font-family:var(--mono);font-weight:950;}
.caseItem .lbl{font-size:11px;color:var(--muted);margin-top:2px;}
.probList{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;}
@media(max-width:760px){.probList{grid-template-columns:1fr;}}
.prob{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background: rgba(0,0,0,.22);font-size:12px;}

.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;padding:10px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.62);box-shadow: var(--shadow);backdrop-filter: blur(12px);display:none;max-width:calc(100% - 24px);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:12.5px;z-index:1000;}
.toast.show{display:block;}

/* =======================
   BLACKJACK (Shuffle-style)
   ======================= */

.bjWrap{
  position:relative;
  padding:14px;
}

.bjStage{
  position:relative;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.22);
  border-radius:22px;
  overflow:hidden;
  box-shadow:0 18px 60px rgba(0,0,0,.55);
}

.bjStage::before{
  content:"";
  position:absolute; inset:-45%;
  background:
    radial-gradient(closest-side at 25% 25%, rgba(124,58,237,.26), transparent 60%),
    radial-gradient(closest-side at 75% 18%, rgba(239,68,68,.18), transparent 60%),
    conic-gradient(from 180deg, rgba(167,139,250,.14), transparent, rgba(239,68,68,.10), transparent);
  filter: blur(3px);
  pointer-events:none;
}

.bjTopRow{
  position:relative;
  display:flex;
  justify-content:space-between;
  gap:12px;
  padding:12px;
  border-bottom:1px solid rgba(255,255,255,.08);
  background: rgba(0,0,0,.24);
  backdrop-filter: blur(10px);
}

.bjTitle{
  font-weight:1000;
  letter-spacing:.22em;
  font-size:12px;
  text-transform:uppercase;
  color: rgba(255,255,255,.92);
}
.bjSub{
  margin-top:4px;
  font-size:12px;
  color: rgba(255,255,255,.62);
  font-weight:900;
}

.bjDeckArea{
  position:relative;
  display:flex;
  align-items:flex-start;
  justify-content:flex-end;
  min-width:120px;
}

.bjDeck{
  width:70px;height:92px;
  border-radius:14px;
  position:relative;
  border:1px solid rgba(255,255,255,.16);
  background:
    radial-gradient(80px 80px at 30% 20%, rgba(255,255,255,.12), transparent 55%),
    linear-gradient(135deg, rgba(124,58,237,.85), rgba(239,68,68,.75));
  box-shadow:0 18px 55px rgba(0,0,0,.65);
  overflow:hidden;
}
.bjDeck::after{
  content:"HANDZES.BET";
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:1000;
  letter-spacing:.18em;
  font-size:9.5px;
  color: rgba(255,255,255,.92);
  text-shadow:0 6px 18px rgba(0,0,0,.65);
  transform: rotate(-10deg);
  opacity:.92;
}
.bjDeck .stack{
  position:absolute; inset:0;
}
.bjDeck .stack::before,
.bjDeck .stack::after{
  content:"";
  position:absolute;
  width:70px;height:92px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.18);
  filter: blur(.2px);
}
.bjDeck .stack::before{ transform: translate(3px,3px); opacity:.55; }
.bjDeck .stack::after{ transform: translate(6px,6px); opacity:.38; }

.bjBody{
  position:relative;
  padding:14px;
}

.bjTable{
  position:relative;
  border-radius:20px;
  border:1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(900px 300px at 50% 0%, rgba(34,197,94,.10), transparent 65%),
    radial-gradient(900px 300px at 50% 100%, rgba(124,58,237,.10), transparent 65%),
    rgba(0,0,0,.22);
  padding:14px;
  overflow:hidden;
}

.bjHands{
  display:grid;
  grid-template-columns: 1fr;
  gap:14px;
}

.bjHandBox{
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.22);
  border-radius:18px;
  padding:12px;
  position:relative;
  overflow:hidden;
}

.bjHandHd{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:10px;
}
.bjHandName{
  font-weight:1000;
  letter-spacing:.14em;
  font-size:11px;
  text-transform:uppercase;
  color: rgba(255,255,255,.86);
}
.bjPts{
  font-family: var(--mono);
  font-weight:1000;
  font-size:12.5px;
  color: rgba(255,255,255,.92);
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.30);
}

.bjCards{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
  min-height:104px;
  position:relative;
}

.bjCard{
  width:70px;
  height:92px;
  position:relative;
  transform-style: preserve-3d;
  will-change: transform;
}

.bjCardInner{
  position:absolute; inset:0;
  transform-style: preserve-3d;
  transition: transform .52s cubic-bezier(.2,.85,.15,1);
}
.bjCard.flip .bjCardInner{ transform: rotateY(180deg); }

.bjFace, .bjBack{
  position:absolute; inset:0;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.18);
  backface-visibility: hidden;
  box-shadow:0 16px 50px rgba(0,0,0,.55);
  overflow:hidden;
}

.bjBack{
  background:
    radial-gradient(90px 90px at 30% 20%, rgba(255,255,255,.14), transparent 55%),
    linear-gradient(135deg, rgba(124,58,237,.88), rgba(239,68,68,.74));
  display:flex;align-items:center;justify-content:center;
  transform: rotateY(0deg);
}
.bjBack span{
  font-weight:1000;
  letter-spacing:.18em;
  font-size:9.5px;
  color: rgba(255,255,255,.92);
  text-shadow:0 6px 18px rgba(0,0,0,.65);
  transform: rotate(-10deg);
}

.bjFace{
  transform: rotateY(180deg);
  background:
    radial-gradient(90px 90px at 30% 20%, rgba(255,255,255,.16), transparent 55%),
    linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.86));
  color:#0b0b0f;
}

.bjFace .top,
.bjFace .bot{
  position:absolute;
  font-family: var(--mono);
  font-weight:1000;
  font-size:12px;
}
.bjFace .top{ left:8px; top:8px; }
.bjFace .bot{ right:8px; bottom:8px; transform: rotate(180deg); }

.bjFace .mid{
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  font-size:30px;
  filter: drop-shadow(0 6px 10px rgba(0,0,0,.15));
}

.bjFace.red{ color:#b10f2e; }
.bjFace.red .mid{ color:#b10f2e; }
.bjFace.black{ color:#0b0b0f; }
.bjFace.black .mid{ color:#0b0b0f; }

/* deal animation: from deck to target */
@keyframes bjDealIn{
  0%{ transform: translate(var(--sx), var(--sy)) rotate(-8deg) scale(.92); opacity:0; }
  60%{ opacity:1; }
  100%{ transform: translate(0,0) rotate(0deg) scale(1); opacity:1; }
}
.bjCard.dealIn{
  animation: bjDealIn .42s cubic-bezier(.18,.9,.14,1);
}

/* wind trail */
@keyframes bjWind{
  0%{ opacity:0; transform: translate(var(--wx), var(--wy)) scale(.6); filter: blur(1px); }
  30%{ opacity:.65; }
  100%{ opacity:0; transform: translate(calc(var(--wx) * .1), calc(var(--wy) * .1)) scale(1.3); filter: blur(6px); }
}
.bjWind{
  position:absolute;
  width:56px;height:18px;
  border-radius:999px;
  background: linear-gradient(90deg, rgba(255,255,255,.0), rgba(255,255,255,.22), rgba(167,139,250,.0));
  pointer-events:none;
  animation: bjWind .35s ease-out forwards;
  mix-blend-mode: screen;
}

/* Controls */
.bjControls{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-top:12px;
  align-items:flex-end;
}

.bjBox{
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.18);
  border-radius:18px;
  padding:12px;
  width:100%;
}

.bjBoxHd{
  display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
  margin-bottom:10px;
}
.bjBoxHd .lbl{
  font-weight:1000;
  letter-spacing:.16em;
  font-size:11px;
  text-transform:uppercase;
  color: rgba(255,255,255,.80);
}
.bjBoxHd .mini{
  font-size:12px;
  font-weight:900;
  color: rgba(255,255,255,.62);
}

.bjBetGrid{
  display:grid;
  grid-template-columns: repeat(4, minmax(160px, 1fr));
  gap:10px;
}
@media(max-width:980px){
  .bjBetGrid{ grid-template-columns: repeat(2, minmax(160px, 1fr)); }
}
@media(max-width:520px){
  .bjBetGrid{ grid-template-columns: 1fr; }
}
.bjField label{ display:block; font-size:11px; color: rgba(255,255,255,.62); font-weight:900; }
.bjField input{
  width:100%;
  margin-top:6px;
  padding:11px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.22);
  color: rgba(255,255,255,.92);
  outline:none;
  font-size:13px;
}
.bjField input:focus{border-color: rgba(167,139,250,.38);box-shadow:0 0 0 4px rgba(124,58,237,.16)}

.bjSideList{
  margin-top:10px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}
.bjSidePill{
  display:flex; align-items:center; gap:10px;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.22);
  font-size:12px;
  font-weight:950;
}
.bjSidePill b{ font-family:var(--mono); }

.btn.standRed{
  background: linear-gradient(135deg, rgba(239,68,68,.95), rgba(251,113,133,.82));
  border-color: rgba(255,255,255,.16);
}

/* Reuse Mines-style popup for BJ (win/lose) */
.bjCenterPop{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%) scale(.92);
  width:min(320px, 84%);
  padding:14px;
  border-radius:22px;
  background:
    radial-gradient(120% 120% at 30% 20%, rgba(255,255,255,.14), transparent 55%),
    rgba(12,12,18,.78);
  border:1px solid rgba(0,0,0,.85);
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,.10),
    0 26px 90px rgba(0,0,0,.75),
    0 0 28px rgba(34,197,94,.18);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  display:none;
  z-index:60;
  text-align:center;
  pointer-events:none;
}

.bjCenterPop::before{
  content:"";
  position:absolute;
  inset:-2px;
  border-radius:24px;
  background:
    linear-gradient(135deg,
      rgba(34,197,94,.0),
      rgba(34,197,94,.55),
      rgba(34,197,94,.0)
    );
  filter: blur(10px);
  opacity:.45;
  z-index:0;
}

.bjCenterPop .inner{
  position:relative;
  z-index:1;
  border-radius:16px;
  background: rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.14);
  padding:14px 14px 12px;
}

.bjCenterPop .label{
  font-size:11px;
  font-weight:900;
  letter-spacing:.18em;
  text-transform:uppercase;
  color: rgba(255,255,255,.70);
  margin-bottom:8px;
}
.bjCenterPop .amt{
  font-family: var(--mono);
  font-weight:1000;
  font-size:34px;
  line-height:1.05;
  color: rgba(255,255,255,.96);
  text-shadow: 0 0 16px rgba(34,197,94,.22);
}
.bjCenterPop .mx{
  margin-top:8px;
  font-family: var(--mono);
  font-weight:900;
  font-size:14px;
  color: rgba(34,197,94,.95);
}
.bjCenterPop .sub{
  margin-top:10px;
  font-size:12px;
  font-weight:800;
  color: rgba(255,255,255,.65);
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
}
.bjCenterPop .dot{
  width:8px;height:8px;border-radius:999px;
  background: rgba(34,197,94,.95);
  box-shadow: 0 0 10px rgba(34,197,94,.45);
}
@keyframes bjPopIn {
  0%   { opacity:0; transform:translate(-50%,-50%) scale(.86); }
  60%  { opacity:1; transform:translate(-50%,-50%) scale(1.03); }
  100% { opacity:1; transform:translate(-50%,-50%) scale(1); }
}
@keyframes bjPopOut {
  to { opacity:0; transform:translate(-50%,-50%) scale(.96); }
}
.bjCenterPop.show{ display:block; animation: bjPopIn .22s ease-out; }
.bjCenterPop.hide{ animation: bjPopOut .18s ease-in forwards; }

.bjCenterPop.lose{
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,.08),
    0 26px 90px rgba(0,0,0,.75),
    0 0 28px rgba(239,68,68,.18);
}
.bjCenterPop.lose::before{
  background:
    linear-gradient(135deg,
      rgba(239,68,68,.0),
      rgba(239,68,68,.55),
      rgba(239,68,68,.0)
    );
}
.bjCenterPop.lose .mx{ color: rgba(239,68,68,.95); }
.bjCenterPop.lose .dot{
  background: rgba(239,68,68,.95);
  box-shadow: 0 0 10px rgba(239,68,68,.45);
}
</style>
</head>
<body>

<!-- SVG ICONS -->
<svg width="0" height="0" style="position:absolute">
  <defs>
    <linearGradient id="gYellow" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#fde68a"/><stop offset="1" stop-color="#f59e0b"/>
    </linearGradient>
    <linearGradient id="gBlue" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#93c5fd"/><stop offset="1" stop-color="#2563eb"/>
    </linearGradient>
    <filter id="fGlow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur stdDeviation="2.6" result="b"/>
      <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
  </defs>
</svg>

<section class="authWrap" id="authWrap">
  <div class="authCard">
    <div class="authTop">
      <div class="mark"></div>
      <div><b>HANDZES.BET</b></div>
    </div>
    <div class="authBody">
      <div class="tabs">
        <button class="tab active" id="tabSignIn">Sign in</button>
        <button class="tab" id="tabSignUp">Sign up</button>
      </div>

      <div id="signInBox">
        <label>Email</label>
        <input id="inEmail" type="email" placeholder="Email" />
        <div style="height:10px"></div>
        <label>Password</label>
        <input id="inPass" type="password" placeholder="Password" />
        <div class="row">
          <button class="btn purple" id="btnSignIn" style="flex:1;">Sign in</button>
          <button class="btn" id="btnForgot" style="flex:1;">Reset password</button>
        </div>
      </div>

      <div id="signUpBox" style="display:none;">
        <label>Username</label>
        <input id="upName" placeholder="Username" />
        <div style="height:10px"></div>
        <label>Email</label>
        <input id="upEmail" type="email" placeholder="Email" />
        <div style="height:10px"></div>
        <label>Password</label>
        <input id="upPass" type="password" placeholder="Password" />
        <div class="row">
          <button class="btn purple" id="btnSignUp" style="flex:1;">Create account</button>
        </div>
      </div>

      <div class="small" id="setupHint" style="display:none;">
        Paste your Supabase URL + anon key in the code first.
      </div>
    </div>
  </div>
</section>

<div class="app" id="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <b>HANDZES.BET</b>
        <small>games ‚Ä¢ sports ‚Ä¢ leaderboard</small>
      </div>
    </div>

    <div class="sideTitle">Menu</div>
    <button class="navBtn active" data-view="home"><span>Home</span><span class="chip" id="chipEvents">0</span></button>
    <button class="navBtn" data-view="games"><span>Games</span><span class="chip" id="chipGames">8</span></button>
    <button class="navBtn" data-view="sports"><span>Sports</span><span class="chip" id="chipSports">0</span></button>
    <button class="navBtn" data-view="leaderboard"><span>Leaderboard</span><span class="chip" id="chipLb">0</span></button>
    <button class="navBtn" data-view="bets"><span>My Bets</span><span class="chip" id="chipMyBets">0</span></button>
    <button class="navBtn" data-view="case"><span>Daily Case</span><span class="chip">üéÅ</span></button>

    <div id="adminNavWrap" style="display:none;">
      <div class="sideTitle">Admin</div>
      <button class="navBtn" data-view="admin"><span>Admin Panel</span><span class="chip ok">ADMIN</span></button>
    </div>

    <div class="sideTitle">Account</div>
    <div class="sideCard">
      <div class="pill"><span class="muted">User</span><span class="mono" id="meName">‚Äî</span></div>
      <div class="pill"><span class="muted">Balance</span><span><span class="mono" id="mePts">0.00</span> <span id="gemSmall"></span></span></div>
      <div class="pill"><span class="muted">Default stake</span>
        <span>
          <input id="defaultStake" type="number" min="0.01" step="0.01" value="0.10"
            style="width:110px;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.26);color:rgba(255,255,255,.92);" />
        </span>
      </div>
    </div>

    <div class="sideTitle">Actions</div>
    <button class="navBtn" id="signOutBtn"><span>Sign out</span><span class="chip">‚Ü©</span></button>
    <button class="navBtn" id="refreshBtn"><span>Refresh</span><span class="chip">R</span></button>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="walletMid"><span class="dot" id="adminDot"></span><span id="adminText">User</span></div>

      <div class="centerBrand">
        <div class="mark2"></div>
        <div class="title">HANDZES.BET</div>
        <div class="walletMid" title="Your balance">
          <span class="mono" id="topPts">0.00</span><span id="gemTop"></span>
        </div>
      </div>

      <div>
        <button class="profileBtn" id="profileBtn">
          <div class="avatar"></div>
          <div style="display:flex;flex-direction:column;line-height:1.1;align-items:flex-start;">
            <span style="font-weight:950;font-size:12.5px;" id="topUser">‚Äî</span>
            <span class="muted" style="font-size:11px;" id="topLevel">Level 1</span>
            <div class="levelWrap">
              <div class="levelBar"><div class="levelFill" id="lvlFill"></div></div>
              <div class="levelText"><span id="lvlProg">0.0/10.0 wager</span><span id="lvlPct">0%</span></div>
            </div>
          </div>
        </button>
      </div>
    </div>

    <section id="view-home">
      <div class="section">
        <div class="sectionHd">
          <div><h3>HANDZES.BET GAMES</h3><div class="sub">Glowing demo tiles (no stock images).</div></div>
          <div class="chip">Games</div>
        </div>
        <div class="sectionBd"><div class="grid" id="gamesGridHome"></div></div>
      </div>

      <div class="section">
        <div class="sectionHd">
          <div><h3>Sports (your events)</h3><div class="sub">Click an event to bet.</div></div>
          <div class="chip"><span class="mono" id="sportsCountHome">0</span></div>
        </div>
        <div class="sectionBd"><div class="grid" id="sportsGridHome"></div></div>
      </div>
    </section>

    <section id="view-games" style="display:none;">
      <div class="section">
        <div class="sectionHd"><div><h3>Games</h3><div class="sub">Demo gallery.</div></div><div class="chip">8</div></div>
        <div class="sectionBd"><div class="grid" id="gamesGrid"></div></div>
      </div>
    </section>

    <section id="view-dice" style="display:none;">
      <div class="section">
        <div class="sectionHd"><div><h3>Dice</h3><div class="sub">50/50 roll. Win pays 1.95√ó (house edge).</div></div><div class="chip">LIVE</div></div>
        <div class="sectionBd">
          <div class="row" style="align-items:flex-end;">
            <div style="width:220px;">
              <label>Stake</label>
              <input id="diceStake" type="number" min="0.01" step="0.01" value="0.10"/>
            </div>
            <div style="width:220px;">
              <label>Pick</label>
              <select id="dicePick">
                <option value="low">LOW (1-49)</option>
                <option value="high">HIGH (50-100)</option>
              </select>
            </div>
            <button class="btn purple" id="diceRollBtn">Roll</button>
            <div class="miniPill"><span class="muted">Roll</span><span class="mono" id="diceRollOut">‚Äî</span></div>
            <div class="miniPill"><span class="muted">Result</span><span class="mono" id="diceResOut">‚Äî</span></div>
          </div>
        </div>
      </div>
    </section>

    <section id="view-roulette" style="display:none;">
      <div class="section">
        <div class="sectionHd"><div><h3>Roulette</h3><div class="sub">Red/Black pays 1.95√ó. Green pays 14√ó.</div></div><div class="chip">LIVE</div></div>
        <div class="sectionBd">
          <div class="row" style="align-items:flex-end;">
            <div style="width:220px;">
              <label>Stake</label>
              <input id="rouStake" type="number" min="0.01" step="0.01" value="0.10"/>
            </div>
            <div style="width:220px;">
              <label>Bet</label>
              <select id="rouPick">
                <option value="red">RED (1.95√ó)</option>
                <option value="black">BLACK (1.95√ó)</option>
                <option value="green">GREEN (14√ó)</option>
              </select>
            </div>
            <button class="btn purple" id="rouSpinBtn">Spin</button>
            <div class="miniPill"><span class="muted">Spin</span><span class="mono" id="rouOut">‚Äî</span></div>
            <div class="miniPill"><span class="muted">Result</span><span class="mono" id="rouRes">‚Äî</span></div>
          </div>
          <div class="sub" style="margin-top:10px;">Wheel: 0 = green, 1-18 = red, 19-36 = black (simple).</div>
        </div>
      </div>
    </section>

    <section id="view-mines" style="display:none;">
      <div class="section">
        <div class="sectionHd">
          <div><h3>Mines</h3><div class="sub">Pick gems, avoid bombs. Cashout anytime.</div></div>
          <div class="chip">LIVE</div>
        </div>

        <div class="sectionBd">
          <div class="row" style="align-items:flex-end;">
            <div style="width:220px;">
              <label>Stake</label>
              <input id="minesStake" type="number" min="0.01" step="0.01" value="0.10"/>
            </div>

            <div style="width:220px;">
              <label>Bombs</label>
              <select id="minesBombs">
              </select>
            </div>

            <button class="btn purple" id="minesStartBtn">Start</button>
            <button class="btn" id="minesCashBtn" disabled>Cashout</button>

            <div class="miniPill">
              <span class="muted">Current payout</span>
              <span class="mono" id="minesPayoutTop">‚Äî</span>
            </div>

            <div class="miniPill"><span class="muted">Status</span><span class="mono" id="minesStatus">‚Äî</span></div>
          </div>

          <div class="minesWrap">
            <div style="position:relative; max-width:520px;">
              <div id="minesGrid"></div>
              <div class="minesCenterPop" id="minesCenterPop">
                <span class="p" style="left:22px; top:22px;"></span>
                <span class="p" style="right:26px; top:28px;"></span>
                <span class="p" style="left:28px; bottom:22px;"></span>
                <span class="p" style="right:30px; bottom:18px;"></span>

                <div class="inner">
                  <div class="label" id="minesPopLabel">CASHED OUT</div>

                  <!-- ‚úÖ payout biggest -->
                  <div class="amt" id="minesPopAmt">0.00</div>

                  <!-- ‚úÖ multiplier smaller (if you want it) -->
                  <div class="mx" id="minesPopMx">x1.00</div>

                  <div class="sub"><span class="dot"></span><span id="minesPopSub">added to balance</span></div>
                </div>
              </div>
            </div>

            <div class="minesRight">
              <div class="minesRightHd">
                <div class="minesRightTitle">MULTIPLIER</div>
                <div class="minesRightSub"><span id="minesRightBombs">‚Äî</span> bombs ‚Ä¢ <span id="minesRightPicks">0</span> picks</div>
              </div>

              <div class="minesLadder" id="minesLadder"></div>

              <div class="minesXFloat" id="minesXFloat">x1.00</div>
            </div>
          </div>

          <div class="sub" style="margin-top:10px;">25 tiles. Multipliers update every correct pick. Auto cashout when all safe tiles are found.</div>
        </div>
      </div>
    </section>

    <section id="view-blackjack" style="display:none;">
      <div class="section">
        <div class="sectionHd">
          <div>
            <h3>Blackjack</h3>
            <div class="sub">Shuffle-style: flip animation, deck dealing, wind effects, win/lose banner.</div>
          </div>
          <div class="chip">LIVE</div>
        </div>

        <div class="sectionBd bjWrap">
          <div class="bjStage">

            <div class="bjTopRow">
              <div>
                <div class="bjTitle">HANDZES.BET BLACKJACK</div>
                <div class="bjSub">
                  Dealer hits on 16 ‚Ä¢ Stands on 17 ‚Ä¢ Blackjack pays 2.5√ó (demo)
                </div>
              </div>

              <div class="bjDeckArea">
                <div class="bjDeck" id="bjDeck" title="Deck">
                  <div class="stack"></div>
                </div>
              </div>
            </div>

            <div class="bjBody">
              <div class="bjTable">

                <div class="bjHands">

                  <div class="bjHandBox">
                    <div class="bjHandHd">
                      <div class="bjHandName">Dealer</div>
                      <div class="bjPts" id="bjDealerPts">‚Äî</div>
                    </div>
                    <div class="bjCards" id="bjDealerCards"></div>
                  </div>

                  <div class="bjHandBox">
                    <div class="bjHandHd">
                      <div class="bjHandName">Player</div>
                      <div class="bjPts" id="bjPlayerPts">‚Äî</div>
                    </div>
                    <div class="bjCards" id="bjPlayerCards"></div>

                    <div class="bjSub" style="margin-top:10px;">
                      Active hand: <span class="mono" id="bjHandLabel">MAIN</span>
                      <span class="muted">‚Ä¢</span>
                      Status: <span class="mono" id="bjStatus">‚Äî</span>
                    </div>
                  </div>

                </div>

                <!-- Popup like Mines (win/lose) -->
                <div class="bjCenterPop" id="bjCenterPop">
                  <div class="inner">
                    <div class="label" id="bjPopLabel">RESULT</div>
                    <div class="amt" id="bjPopAmt">0.00</div>
                    <div class="mx" id="bjPopMx">+0.00</div>
                    <div class="sub"><span class="dot"></span><span id="bjPopSub">added to balance</span></div>
                  </div>
                </div>

              </div>

              <div class="bjControls">

                <div class="bjBox">
                  <div class="bjBoxHd">
                    <div class="lbl">Bets (standard + side bets)</div>
                    <div class="mini">Set stakes, then Deal</div>
                  </div>

                  <div class="bjBetGrid">
                    <div class="bjField">
                      <label>Main stake</label>
                      <input id="bjStake" type="number" min="0.01" step="0.01" value="0.10"/>
                    </div>

                    <div class="bjField">
                      <label>Perfect Pairs stake</label>
                      <input id="bjPPStake" type="number" min="0" step="0.01" value="0.00"/>
                    </div>

                    <div class="bjField">
                      <label>Bust Out stake</label>
                      <input id="bjBOStake" type="number" min="0" step="0.01" value="0.00"/>
                    </div>

                    <div class="bjField">
                      <label>Info</label>
                      <input id="bjInfo" value="Back of cards: HANDZES.BET" disabled />
                    </div>
                  </div>

                  <div class="bjSideList">
                    <div class="bjSidePill">1) Perfect Pairs <span class="muted">pays</span> <b>11√ó</b></div>
                    <div class="bjSidePill">2) Bust Out <span class="muted">pays</span> <b>2√ó</b></div>
                  </div>

                  <div class="row" style="margin-top:12px; justify-content:flex-end;">
                    <button class="btn purple" id="bjDealBtn">Deal</button>
                    <button class="btn" id="bjHitBtn" disabled>Hit</button>
                    <button class="btn standRed" id="bjStandBtn" disabled>Stand</button>
                    <button class="btn" id="bjDoubleBtn" disabled>Double</button>
                    <button class="btn" id="bjSplitBtn" disabled>Split</button>
                  </div>
                </div>

              </div>

            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="view-sports" style="display:none;">
      <div class="section">
        <div class="sectionHd"><div><h3>Sports</h3><div class="sub">Your created events with coefficients.</div></div><div class="chip"><span class="mono" id="chipSports2">0</span></div></div>
        <div class="sectionBd"><div class="grid" id="eventsGrid"></div></div>
      </div>
    </section>

    <section id="view-leaderboard" style="display:none;">
      <div class="section">
        <div class="sectionHd"><div><h3>Leaderboard</h3><div class="sub">Monthly wager. Top #1 gets +3 when month changes.</div></div><div class="chip"><span class="mono" id="lbMonth">‚Äî</span></div></div>
        <div class="sectionBd">
          <table>
            <thead><tr><th>#</th><th>User</th><th>Wager (this month)</th><th>Level</th></tr></thead>
            <tbody id="lbBody"><tr><td colspan="4" class="muted">Loading‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="view-bets" style="display:none;">
      <div class="section">
        <div class="sectionHd"><div><h3>My Bets</h3><div class="sub">Bets for your account.</div></div><div class="chip"><span class="mono" id="myBetsCount">0</span></div></div>
        <div class="sectionBd">
          <table>
            <thead><tr><th>Time</th><th>Event</th><th>Pick</th><th>Stake</th><th>Coef</th><th>Status</th><th>Payout</th></tr></thead>
            <tbody id="myBetsBody"><tr><td colspan="7" class="muted">No bets yet.</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="view-case" style="display:none;">
      <div class="section">
        <div class="sectionHd">
          <div><h3>Daily Case</h3><div class="sub">Open after you wager 10 (this month). Admin can test anytime.</div></div>
          <div class="chip" id="caseStatus">‚Äî</div>
        </div>
        <div class="sectionBd">
          <div class="caseBox">
            <div class="row" style="justify-content:space-between;align-items:center;margin-top:0;">
              <div class="miniPill"><span class="muted">Next case in</span><span class="mono" id="caseCountdown">‚Äî</span></div>
              <div class="miniPill"><span class="muted">Requirement</span><span class="mono" id="caseReq">0.00 / 10.00</span><span id="gemReq"></span></div>
            </div>
            <div style="height:10px"></div>
            <div class="caseStage">
              <div class="caseLine"></div>
              <div class="caseTrack" id="caseTrack"></div>
            </div>
            <div class="row" style="margin-top:12px;justify-content:space-between;">
              <button class="btn purple" id="openCaseBtn">Open case</button>
            </div>

            <div class="probList">
              <div class="prob"><span>70% ‚Üí win 0.01</span><span class="mono">0.01</span></div>
              <div class="prob"><span>10% ‚Üí win 0.03</span><span class="mono">0.03</span></div>
              <div class="prob"><span>7.5% ‚Üí win 0.05</span><span class="mono">0.05</span></div>
              <div class="prob"><span>2.5% ‚Üí win 0.10</span><span class="mono">0.10</span></div>
              <div class="prob"><span>9% ‚Üí win nothing</span><span class="mono">0.00</span></div>
              <div class="prob"><span>1% ‚Üí win 1.00</span><span class="mono">1.00</span></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="view-admin" style="display:none;">
      <div class="section">
        <div class="sectionHd"><div><h3>Admin Panel</h3><div class="sub">Only the Handzes account can see this.</div></div><div class="chip ok">ADMIN</div></div>
        <div class="sectionBd">
          <div class="section" style="margin-top:0;">
            <div class="sectionHd"><div><h3>Give points</h3><div class="sub">Select a user and set/add points (decimals supported).</div></div></div>
            <div class="sectionBd">
              <label>Registered users</label>
              <select id="userSelect"></select>
              <div class="row">
                <div style="width:180px;">
                  <label>Set points</label>
                  <input id="ptsSet" type="number" step="0.01" value="10.00"/>
                </div>
                <button class="btn purple" id="setPtsBtn">Set</button>
                <div style="width:180px;">
                  <label>Add amount</label>
                  <input id="ptsAdd" type="number" step="0.01" value="0.10"/>
                </div>
                <button class="btn" id="addBtn">Add</button>
              </div>
              <div class="small" id="adminUserHint"></div>
            </div>
          </div>

          <div class="section">
            <div class="sectionHd"><div><h3>Create sports event</h3><div class="sub">2+ options with coefficients.</div></div></div>
            <div class="sectionBd">
              <div class="row">
                <div style="flex:1;min-width:260px;">
                  <label>Event name</label>
                  <input id="evName" placeholder="Race / Match / Player A vs Player B"/>
                </div>
                <div style="width:180px;">
                  <label>Status</label>
                  <select id="evStatus">
                    <option value="open">open</option>
                    <option value="closed">closed</option>
                  </select>
                </div>
              </div>
              <div style="margin-top:10px;">
                <label>Description</label>
                <input id="evDesc" placeholder="Rules, best-of-3‚Ä¶"/>
              </div>
              <div class="row" style="margin-top:10px;align-items:center;">
                <div style="flex:1;">
                  <label>Options</label>
                  <div class="muted" style="font-size:12px;margin-top:4px;">Add 2+ options</div>
                </div>
                <button class="btn" id="addOptBtn">Add option</button>
              </div>
              <div id="optsBox" style="margin-top:10px;"></div>
              <div class="row" style="margin-top:12px;">
                <button class="btn purple" id="createEventBtn">Create</button>
              </div>
              <div id="adminEventsBox" class="small"></div>
            </div>
          </div>

          <div class="section">
            <div class="sectionHd">
              <div><h3>Manage events</h3><div class="sub">Open/Close/Finish, select winner, delete.</div></div>
              <button class="btn" id="reloadAdminEventsBtn">Reload</button>
            </div>
            <div class="sectionBd">
              <div id="adminEventsList" class="small muted">Loading‚Ä¶</div>
            </div>
          </div>

          <div class="section" style="margin-top:14px;">
            <div class="sectionHd">
              <div>
                <h3>SQL (run once)</h3>
                <div class="sub">Run this once in Supabase ‚Üí SQL Editor if you get DB/RLS errors.</div>
              </div>
            </div>
            <div class="sectionBd">
<pre style="margin:0;white-space:pre-wrap;font-family:var(--mono);font-size:12px;color:rgba(255,255,255,.82);">
create extension if not exists pgcrypto;

create table if not exists public.profiles (
  id uuid primary key references auth.users(id) on delete cascade,
  email text unique,
  display_name text,
  avatar_seed text default 'p1',
  pts numeric(14,2) default 10.00,
  lifetime_wager numeric(14,2) default 0,
  month_wager numeric(14,2) default 0,
  month_key text default to_char(now(),'YYYY-MM'),
  level int default 1,
  last_case_open date,
  created_at timestamptz default now()
);

create table if not exists public.events (
  id bigint generated by default as identity primary key,
  name text not null,
  description text default ''::text,
  status text default 'open'::text,
  created_at timestamptz default now(),
  created_by uuid references auth.users(id),
  winner_option_id bigint null
);

create table if not exists public.event_options (
  id bigint generated by default as identity primary key,
  event_id bigint not null references public.events(id) on delete cascade,
  label text not null,
  coef numeric(10,2) not null default 2.00
);

do $$
begin
  alter table public.events
    add constraint events_winner_fk foreign key (winner_option_id)
    references public.event_options(id) on delete set null;
exception when duplicate_object then null;
end $$;

create table if not exists public.bets (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users(id) on delete cascade,
  event_id bigint references public.events(id) on delete cascade,
  option_id bigint references public.event_options(id) on delete cascade,
  event_name text,
  opt_name text,
  stake numeric(14,2),
  coef numeric(10,2),
  status text default 'pending',
  payout numeric(14,2) default 0,
  created_at timestamptz default now()
);

create table if not exists public.app_state (
  id int primary key,
  current_month text,
  last_awarded_month text,
  updated_at timestamptz default now()
);
insert into public.app_state (id, current_month, last_awarded_month)
values (1, to_char(now(),'YYYY-MM'), null)
on conflict (id) do nothing;

alter table public.profiles disable row level security;
alter table public.events disable row level security;
alter table public.event_options disable row level security;
alter table public.bets disable row level security;
alter table public.app_state disable row level security;
</pre>
            </div>
          </div>

        </div>
      </div>
    </section>

  </main>
</div>

<!-- Event modal -->
<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modalHd">
      <div style="min-width:0;">
        <h4 id="mTitle">Event</h4>
        <p id="mDesc" class="muted"></p>
      </div>
      <button class="closeBtn" id="closeModal">‚úï</button>
    </div>
    <div class="modalBd">
      <div class="row" style="justify-content:space-between;gap:10px;flex-wrap:wrap;">
        <span class="tag" id="mStatus">OPEN</span>
        <span class="miniPill"><span class="muted">Your balance</span><span class="mono" id="mBal">0.00</span><span id="gemBal"></span></span>
      </div>
      <div class="oddsGrid" id="mOdds"></div>
      <div class="modalRow">
        <div class="row" style="gap:10px;">
          <div class="miniPill"><span class="muted">Stake</span><input id="mStake" type="number" min="0.01" step="0.01" value="0.10"/></div>
          <div class="miniPill"><span class="muted">Potential payout</span><span class="mono" id="mPayout">‚Äî</span></div>
        </div>
        <div class="row" style="gap:10px;justify-content:flex-end;">
          <button class="btn" id="mCancel">Cancel</button>
          <button class="btn green" id="mConfirm" disabled>Confirm bet</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Profile modal -->
<div class="overlay" id="profileOverlay">
  <div class="modal" style="width:min(760px,100%);">
    <div class="modalHd">
      <div><h4>Profile</h4><p class="muted">Edit username + picture</p></div>
      <button class="closeBtn" id="closeProfile">‚úï</button>
    </div>
    <div class="modalBd">
      <div class="row" style="gap:10px;align-items:flex-end;">
        <div style="display:flex;align-items:center;gap:12px;">
          <div class="avatar" id="pAvatar" style="width:44px;height:44px;border-radius:16px;"></div>
          <div style="display:flex;flex-direction:column;gap:6px;">
            <label>Username</label>
            <input id="pUserEdit" placeholder="Username" style="width:220px"/>
          </div>
        </div>

        <div class="miniPill"><span class="muted">Balance</span><span class="mono" id="pBal">0.00</span><span id="gemProf"></span></div>
        <div class="miniPill"><span class="muted">Level</span><span class="mono" id="pLevel">1</span></div>
      </div>

      <div style="margin-top:12px;">
        <label>Profile picture</label>
        <div class="row" style="gap:10px;margin-top:6px;">
          <button class="btn" data-ava="p1">Purple</button>
          <button class="btn" data-ava="p2">Red</button>
          <button class="btn" data-ava="p3">Blue</button>
          <button class="btn" data-ava="p4">Green</button>
          <button class="btn" data-ava="p5">Gold</button>
        </div>
        <div class="row" style="justify-content:flex-end;margin-top:10px;">
          <button class="btn purple" id="pSaveBtn">Save profile</button>
        </div>
      </div>

      <div class="section" style="margin-top:12px;">
        <div class="sectionHd"><div><h3>Stats</h3><div class="sub">Calculated from your wagers.</div></div></div>
        <div class="sectionBd">
          <div class="row" style="gap:10px;">
            <div class="miniPill"><span class="muted">Wager (this month)</span><span class="mono" id="pMonthW">0.00</span><span id="gemMW"></span></div>
            <div class="miniPill"><span class="muted">Wager (lifetime)</span><span class="mono" id="pLifeW">0.00</span><span id="gemLW"></span></div>
            <div class="miniPill"><span class="muted">Bets</span><span class="mono" id="pBets">0</span></div>
          </div>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:12px;">
        <button class="btn" id="pCloseBtn">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://jolpzszotsaglwghbyaq.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_H5RpNuvRJu3-HyTiB24RJQ_LzJRe4WA";

const ADMIN_EMAIL = "handzes.deal@gmail.com";
const ADMIN_DISPLAY_NAME = "Handzes";

const $ = (id)=>document.getElementById(id);
const esc = (s)=>String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const to2 = (n)=> (Math.round((Number(n)+Number.EPSILON)*100)/100).toFixed(2);
const clamp2 = (n)=> Math.max(0, Math.round(Number(n)*100)/100);

const toastEl = $("toast");
const toast = (msg)=>{ toastEl.textContent=msg; toastEl.classList.add("show"); clearTimeout(toastEl._t); toastEl._t=setTimeout(()=>toastEl.classList.remove("show"), 2600); };

const gemYellow = () => `<svg class="iconSvg glow" viewBox="0 0 24 24" style="filter:url(#fGlow)"><path fill="url(#gYellow)" d="M12 2 4.2 9.2 12 22l7.8-12.8z"/><path fill="rgba(255,255,255,.35)" d="M12 2 9 9.2h6z"/></svg>`;

// Bigger gem specifically for MINES grid
const gemYellowMines = () => `<svg class="minesGemSvg glow" viewBox="0 0 24 24" style="filter:url(#fGlow)"><path fill="url(#gYellow)" d="M12 2 4.2 9.2 12 22l7.8-12.8z"/><path fill="rgba(255,255,255,.35)" d="M12 2 9 9.2h6z"/></svg>`;

// Custom red glowing bomb (no emoji)
const bombRed = () => `<svg class="minesBombSvg bombPulseSvg" viewBox="0 0 64 64"><defs><radialGradient id="bombCore" cx="35%" cy="30%" r="70%"><stop offset="0" stop-color="rgba(255,255,255,.55)"/><stop offset="0.25" stop-color="rgba(251,113,133,.95)"/><stop offset="1" stop-color="rgba(239,68,68,.95)"/></radialGradient><radialGradient id="bombShadow" cx="35%" cy="35%" r="75%"><stop offset="0" stop-color="rgba(0,0,0,.0)"/><stop offset="1" stop-color="rgba(0,0,0,.65)"/></radialGradient></defs><path d="M44 14c7-6 12-4 14-2" fill="none" stroke="rgba(255,255,255,.75)" stroke-width="4" stroke-linecap="round"/><circle cx="60" cy="11" r="3.5" fill="rgba(255,255,255,.9)"/><circle cx="58.5" cy="9.5" r="2.2" fill="rgba(239,68,68,.95)"/><path d="M32 12c8 0 14 4 14 9v4H18v-4c0-5 6-9 14-9z" fill="rgba(0,0,0,.55)" stroke="rgba(255,255,255,.18)" stroke-width="2" /><circle cx="32" cy="38" r="20" fill="url(#bombCore)" stroke="rgba(0,0,0,.65)" stroke-width="2"/><circle cx="32" cy="38" r="20" fill="url(#bombShadow)" opacity=".55"/><path d="M22 28c3-5 8-8 14-8" fill="none" stroke="rgba(255,255,255,.55)" stroke-width="4" stroke-linecap="round" opacity=".55"/></svg>`;
const gemBlue = () => `<svg class="iconSvg glow" viewBox="0 0 24 24" style="filter:url(#fGlow)"><path fill="url(#gBlue)" d="M12 2 4.2 9.2 12 22l7.8-12.8z"/><path fill="rgba(255,255,255,.35)" d="M12 2 9 9.2h6z"/></svg>`;
const poop = () => `<svg class="iconPoop" viewBox="0 0 24 24"><path fill="#8b5e34" d="M10 3c0 1-1 2-2 2 0 0 1 1 1 2 0 0-2 1-2 3 0 0 2 0 2 2H7c-2 0-3 2-3 4s2 5 8 5 8-2 8-5-1-4-3-4h-2c0-2 2-2 2-2 0-2-2-3-2-3 0-1 1-2 1-2-1 0-2-1-2-2-1 1-1 2-2 2s-1-1-2-2z"/></svg>`;

const AVA = {
  p1: "radial-gradient(16px 16px at 30% 30%, rgba(167,139,250,.98), rgba(124,58,237,.55))",
  p2: "radial-gradient(16px 16px at 30% 30%, rgba(251,113,133,.95), rgba(239,68,68,.55))",
  p3: "radial-gradient(16px 16px at 30% 30%, rgba(147,197,253,.95), rgba(37,99,235,.55))",
  p4: "radial-gradient(16px 16px at 30% 30%, rgba(134,239,172,.95), rgba(34,197,94,.50))",
  p5: "radial-gradient(16px 16px at 30% 30%, rgba(253,230,138,.95), rgba(245,158,11,.55))",
};
function applyAvatar(el, seed){
  const bg = AVA[seed] || AVA.p1;
  el.style.background = bg;
  el.style.boxShadow = "0 10px 28px rgba(0,0,0,.55)";
  el.style.border = "1px solid rgba(255,255,255,.16)";
}

$("gemSmall").innerHTML = gemBlue();
$("gemTop").innerHTML = gemBlue();
$("gemReq").innerHTML = gemBlue();
$("gemBal").innerHTML = gemBlue();
$("gemProf").innerHTML = gemBlue();
$("gemMW").innerHTML = gemBlue();
$("gemLW").innerHTML = gemBlue();

const keysOk = !SUPABASE_URL.includes("PASTE_") && !SUPABASE_ANON_KEY.includes("PASTE_");
$("setupHint").style.display = keysOk ? "none" : "";

const supabase = keysOk ? createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
if(!keysOk){ $("authWrap").classList.add("show"); toast("Paste Supabase keys in index.html"); }

function setAuthTab(which){
  const isIn = which==="in";
  $("tabSignIn").classList.toggle("active", isIn);
  $("tabSignUp").classList.toggle("active", !isIn);
  $("signInBox").style.display = isIn ? "" : "none";
  $("signUpBox").style.display = isIn ? "none" : "";
}
$("tabSignIn").onclick=()=>setAuthTab("in");
$("tabSignUp").onclick=()=>setAuthTab("up");

let session=null, meProfile=null, isAdmin=false, events=[], myBets=[], usersList=[];
// ‚úÖ MP3 cashout sound
const cashoutSound = new Audio("./sounds/cashout.mp3");
cashoutSound.preload = "auto";
cashoutSound.volume = 0.85;

// Browsers require "user gesture" before sound can play.
// This unlocks audio on the first click/tap anywhere.
let __audioUnlocked = false;
function unlockAudioOnce(){
  if(__audioUnlocked) return;
  __audioUnlocked = true;
  try{
    // unlock WebAudio too (for your sfx beeps)
    const ctx = window.__sfxCtx || (window.__sfxCtx = new (window.AudioContext||window.webkitAudioContext)());
    if(ctx && ctx.state === "suspended") ctx.resume();

    // unlock HTMLAudio
    cashoutSound.muted = true;
    cashoutSound.play().then(()=>{
      cashoutSound.pause();
      cashoutSound.currentTime = 0;
      cashoutSound.muted = false;
    }).catch(()=>{
      cashoutSound.muted = false;
    });
  }catch(_){}
}
window.addEventListener("pointerdown", unlockAudioOnce, { once:true });
window.addEventListener("keydown", unlockAudioOnce, { once:true });


function sfx(freq=520, dur=0.06, type="sine", gain=0.04){
  try{
    const ctx = window.__sfxCtx || (window.__sfxCtx = new (window.AudioContext||window.webkitAudioContext)());
    const o=ctx.createOscillator(); const g=ctx.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=gain;
    o.connect(g); g.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime+dur);
  }catch(_){}
}
function sfxBomb(){
  try{
    const ctx = window.__sfxCtx || (window.__sfxCtx = new (window.AudioContext||window.webkitAudioContext)());
    const o=ctx.createOscillator(); const g=ctx.createGain();
    o.type="sawtooth";
    o.frequency.setValueAtTime(220, ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(60, ctx.currentTime+0.18);
    g.gain.setValueAtTime(0.08, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.22);
    o.connect(g); g.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime+0.23);
  }catch(_){}
}
function sfxGem(){
  sfx(880,0.06,"triangle",0.03);
  setTimeout(()=>sfx(1180,0.05,"triangle",0.025), 40);
}

/* ‚úÖ MONEY/CASHOUT SOUND (MP3) */
function sfxCashout(){
  try{
    unlockAudioOnce();            // make sure audio is unlocked
    cashoutSound.currentTime = 0; // replay instantly
    cashoutSound.play();
  }catch(_){}
}


function monthKey(d=new Date()){
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"); return `${y}-${m}`;
}
function todayISO(){
  const d=new Date(); const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), day=String(d.getDate()).padStart(2,"0"); return `${y}-${m}-${day}`;
}
function computeLevel(lifeW){ return 1 + Math.floor(Number(lifeW||0)/10); }

function updateLevelUI(){
  const life = Number(meProfile?.lifetime_wager||0);
  const lvl = computeLevel(life);
  const prog = life % 10;
  const pct = Math.max(0, Math.min(100, (prog/10)*100));
  $("topLevel").textContent = `Level ${lvl}`;
  $("lvlFill").style.width = pct.toFixed(1)+"%";
  $("lvlProg").textContent = `${prog.toFixed(1)}/10.0 wager`;
  $("lvlPct").textContent = `${pct.toFixed(0)}%`;
}

function updateMeUI(){
  $("meName").textContent = meProfile?.display_name || "‚Äî";
  $("topUser").textContent = meProfile?.display_name || "‚Äî";
  $("mePts").textContent = to2(meProfile?.pts||0);
  $("topPts").textContent = to2(meProfile?.pts||0);
  updateLevelUI();
  applyAvatar(document.querySelector(".avatar"), meProfile?.avatar_seed||"p1");
  $("adminDot").style.background = isAdmin ? "var(--green)" : "var(--purple2)";
  $("adminDot").style.boxShadow = isAdmin ? "0 0 0 4px rgba(34,197,94,.14)" : "0 0 0 4px rgba(167,139,250,.14)";
  $("adminText").textContent = isAdmin ? "Admin" : "User";
  $("adminNavWrap").style.display = isAdmin ? "" : "none";
}

function setView(v){
  document.querySelectorAll(".navBtn[data-view]").forEach(b=>b.classList.toggle("active", b.dataset.view===v));
  ["home","games","dice","roulette","mines","blackjack","sports","leaderboard","bets","case","admin"].forEach(id=>{
    const el=$("view-"+id); if(el) el.style.display=(id===v)?"":"none";
  });
  if(v==="leaderboard") refreshLeaderboard();
  if(v==="admin") { loadUsersList(); loadAdminEvents(); }
  if(v==="case") refreshCaseUI();
}
document.querySelectorAll(".navBtn[data-view]").forEach(b=>b.onclick=()=>setView(b.dataset.view));

async function ensureProfile(){
  const user=session?.user; if(!user) return;
  const email=(user.email||"").toLowerCase();
  const { data, error } = await supabase.from("profiles").select("*").eq("id", user.id).maybeSingle();
  if(error){ toast("Profile not loaded. Run SQL then Refresh."); console.error(error); return; }
  if(data){ meProfile=data; return; }
  const name = (email===ADMIN_EMAIL.toLowerCase()) ? ADMIN_DISPLAY_NAME : ((user.user_metadata?.display_name) || (email.split("@")[0]||"Player"));
  const curM=monthKey();
  const { data: ins, error: e2 } = await supabase.from("profiles").insert({
    id:user.id, email:user.email, display_name:name, pts:10.00, lifetime_wager:0, month_wager:0, month_key:curM, level:1
  }).select("*").single();
  if(e2){ toast("Profile create failed (DB/RLS)."); console.error(e2); return; }
  meProfile=ins;
}

async function normalizeMonthForMe(){
  if(!meProfile) return;
  const cur=monthKey();
  if((meProfile.month_key||cur)!==cur){
    await supabase.from("profiles").update({ month_key:cur, month_wager:0 }).eq("id", meProfile.id);
    meProfile.month_key=cur; meProfile.month_wager=0;
  }
}

async function maybeRollMonth(){
  const cur = monthKey();
  const { data: st, error } = await supabase.from("app_state").select("*").eq("id", 1).maybeSingle();
  if(error || !st) return;

  const stored = st.current_month || cur;
  if(stored === cur) return;

  const prev = stored;

  const { data: leaders, error: e2 } = await supabase
    .from("profiles")
    .select("id,pts,month_wager")
    .eq("month_key", prev)
    .order("month_wager",{ascending:false})
    .limit(1);

  if(!e2 && leaders && leaders.length){
    const w = leaders[0];
    await supabase.from("profiles").update({ pts: clamp2(Number(w.pts||0)+3) }).eq("id", w.id);
  }

  await supabase.from("profiles").update({ month_wager: 0, month_key: cur });

  await supabase.from("app_state").update({
    current_month: cur,
    last_awarded_month: prev,
    updated_at: new Date().toISOString()
  }).eq("id", 1);
}

async function loadMyBets(){
  const uid=session?.user?.id; if(!uid) return;
  const r = await supabase.from("bets")
    .select("id,created_at,event_name,opt_name,stake,coef,status,payout,event_id,option_id")
    .eq("user_id", uid)
    .order("created_at",{ascending:false})
    .limit(120);

  if(r.error){
    console.error(r.error);
    $("myBetsBody").innerHTML = `<tr><td colspan="7" class="muted">Cannot load bets (DB/RLS).</td></tr>`;
    return;
  }

  myBets = r.data || [];
  $("chipMyBets").textContent=String(myBets.length);
  $("myBetsCount").textContent=String(myBets.length);

  $("myBetsBody").innerHTML = myBets.length ? myBets.map(b=>`
    <tr>
      <td class="mono">${new Date(b.created_at).toLocaleString([], {month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit"})}</td>
      <td>${esc(b.event_name||"")}</td>
      <td>${esc(b.opt_name||"")}</td>
      <td class="mono">${to2(b.stake||0)}</td>
      <td class="mono">${to2(b.coef||0)}</td>
      <td><span class="tag ${String(b.status||"pending")==="pending"?"pending":(String(b.status)==="won"?"open":"settled")}">${String(b.status||"pending").toUpperCase()}</span></td>
      <td class="mono">${Number(b.payout||0)>0 ? to2(b.payout) : "‚Äî"}</td>
    </tr>`).join("") : `<tr><td colspan="7" class="muted">No bets yet.</td></tr>`;
}

async function loadEventOptionsFor(ids){
  if(!ids.length) return new Map();
  const { data, error } = await supabase
    .from("event_options")
    .select("id,event_id,label,coef")
    .in("event_id", ids)
    .order("id", { ascending: true });

  if(error) throw error;
  const map = new Map();
  for(const row of (data||[])){
    if(!map.has(row.event_id)) map.set(row.event_id, []);
    map.get(row.event_id).push({
      id: row.id,
      name: row.label,
      coef: Number(row.coef)
    });
  }
  return map;
}

async function loadEvents(){
  const { data, error } = await supabase
    .from("events")
    .select("id,name,description,status,created_at,created_by,winner_option_id")
    .order("created_at",{ascending:false});

  if(error){ toast("Events load failed (DB/RLS)."); console.error(error); return; }

  const base = data || [];
  const ids = base.map(e=>e.id);

  try{
    const optMap = await loadEventOptionsFor(ids);
    events = base.map(ev => ({ ...ev, options: optMap.get(ev.id) || [] }));
  }catch(e){
    console.error(e);
    events = base.map(ev => ({ ...ev, options: [] }));
  }

  $("chipEvents").textContent=String(events.length);
  $("chipSports").textContent=String(events.length);
  $("chipSports2").textContent=String(events.length);
  $("sportsCountHome").textContent=String(Math.min(6, events.length));
  renderSports();
}

async function addWagerAndPayout(stake, payout){
  if(!meProfile) throw new Error("profile");
  await normalizeMonthForMe();
  stake = Number(stake);
  payout = Number(payout);
  if(!(stake>0)) throw new Error("stake");
  if(Number(meProfile.pts) < stake) throw new Error("balance");
  const newPts = clamp2(Number(meProfile.pts) - stake + payout);
  const newLife = clamp2(Number(meProfile.lifetime_wager||0) + stake);
  const newMonth = clamp2(Number(meProfile.month_wager||0) + stake);
  const newLvl = computeLevel(newLife);
  const { error } = await supabase.from("profiles").update({
    pts:newPts, lifetime_wager:newLife, month_wager:newMonth, month_key:monthKey(), level:newLvl
  }).eq("id", session.user.id);
  if(error) throw error;
  meProfile.pts=newPts; meProfile.lifetime_wager=newLife; meProfile.month_wager=newMonth; meProfile.level=newLvl;
  updateMeUI();
  refreshCaseUI();
  return { newPts, newLvl };
}

function renderSports(){
  const mkTile = (icon, title, desc, tagCls, tagTxt, meta)=>`
    <div class="tileArt"><span>${icon}</span></div>
    <div class="tileBody">
      <p class="tileTitle">${esc(title)}</p>
      <div class="tileDesc">${desc?esc(desc):'<span class="muted">No description</span>'}</div>
      <div class="tileMeta"><span class="tag ${tagCls}">${tagTxt}</span><span class="oddsMini">${esc(meta||"")}</span></div>
    </div>`;

  const grid=$("eventsGrid"); grid.innerHTML="";
  const gridH=$("sportsGridHome"); gridH.innerHTML="";

  if(!events.length){
    grid.innerHTML='<div class="muted">No events yet (Admin creates them).</div>';
    gridH.innerHTML='<div class="muted">No events yet.</div>';
    return;
  }

  events.forEach((ev, idx)=>{
    const tagCls = ev.status==="open" ? "open" : (ev.status==="closed" ? "closed" : "settled");
    const opts = Array.isArray(ev.options)?ev.options:[];
    const mini = opts.length
      ? (opts.slice(0,2).map(o=>`${o.name} ${to2(o.coef)}`).join(" ‚Ä¢ ") + (opts.length>2?" ‚Ä¢ ‚Ä¶":""))
      : "Tap to bet";

    const el=document.createElement("div"); el.className="tile";
    el.innerHTML = mkTile("üèüÔ∏è", ev.name||"Event", ev.description||"", tagCls, String(ev.status||"open").toUpperCase(), mini);
    el.onclick=()=>openEventModal(ev);
    grid.appendChild(el);

    if(idx<6){
      const el2=document.createElement("div"); el2.className="tile";
      el2.innerHTML = mkTile("‚öîÔ∏è", ev.name||"Event", ev.description||"", tagCls, String(ev.status||"open").toUpperCase(), mini);
      el2.onclick=()=>openEventModal(ev);
      gridH.appendChild(el2);
    }
  });
}

function renderGames(){
  const G=[
    {icon:"üé≤",name:"Dice",desc:"Quick roll"},
    {icon:"üí£",name:"Mines",desc:"Pick safe tiles"},
    {icon:"ü™ô",name:"Plinko",desc:"Drop & win"},
    {icon:"üöÄ",name:"Crash",desc:"Cash out"},
    {icon:"üÉè",name:"Blackjack",desc:"Classic 21"},
    {icon:"üé∞",name:"Slots",desc:"Spin reels"},
    {icon:"üéØ",name:"Keno",desc:"Pick numbers"},
    {icon:"üé°",name:"Roulette",desc:"Red / black"},
  ];
  const mk=(g)=>{
    const el=document.createElement("div"); el.className="tile";
    el.innerHTML = `
      <div class="tileArt"><span>${g.icon}</span></div>
      <div class="tileBody">
        <p class="tileTitle">${esc(g.name)}</p>
        <div class="tileDesc">${esc(g.desc)}</div>
        <div class="tileMeta"><span class="tag">GAME</span><span class="oddsMini">Live/soon</span></div>
      </div>`;
    el.onclick=()=>{
      if(g.name==="Dice") setView("dice");
      else if(g.name==="Roulette") setView("roulette");
      else if(g.name==="Mines") setView("mines");
      else if(g.name==="Blackjack") setView("blackjack");
      else toast("Coming soon");
    };
    return el;
  };
  $("gamesGrid").innerHTML=""; $("gamesGridHome").innerHTML="";
  G.forEach(g=>{ $("gamesGrid").appendChild(mk(g)); $("gamesGridHome").appendChild(mk(g)); });
  $("chipGames").textContent=String(G.length);
}

/* EVENT MODAL + CONFIRM */
let currentEvent=null;
let selectedOpt=null;

function openEventModal(ev){
  if(!meProfile){ toast("Profile not loaded (Refresh)."); return; }
  currentEvent=ev; selectedOpt=null;
  $("mConfirm").disabled=true;
  $("mTitle").textContent=ev.name||"Event";
  $("mDesc").textContent=ev.description||"";
  const st=String(ev.status||"open");
  $("mStatus").textContent=st.toUpperCase();
  $("mStatus").className="tag " + (st==="open"?"open":(st==="closed"?"closed":"settled"));
  $("mBal").textContent=to2(meProfile.pts||0);
  $("mStake").value = to2(Number($("defaultStake").value)||0.10);
  renderOdds(ev);
  updatePotential();
  $("overlay").classList.add("show");
}
function closeEventModal(){ $("overlay").classList.remove("show"); currentEvent=null; selectedOpt=null; $("mConfirm").disabled=true; }
$("closeModal").onclick=closeEventModal;
$("mCancel").onclick=closeEventModal;
$("overlay").onclick=(e)=>{ if(e.target===$("overlay")) closeEventModal(); };

function updatePotential(){
  const stake=Number($("mStake").value);
  if(!(stake>0) || !selectedOpt){ $("mPayout").textContent="‚Äî"; $("mConfirm").disabled=true; return; }
  $("mPayout").textContent = to2(stake * Number(selectedOpt.coef));
  $("mConfirm").disabled = false;
}
$("mStake").addEventListener("input", updatePotential);

function renderOdds(ev){
  const box=$("mOdds"); box.innerHTML="";
  const opts=Array.isArray(ev.options)?ev.options:[];
  if(!opts.length){
    box.innerHTML = `<div class="muted">No options found for this event.</div>`;
    return;
  }
  const coefs = opts.map(o=>Number(o.coef));
  const minC = Math.min(...coefs);
  const maxC = Math.max(...coefs);

  opts.forEach((o)=>{
    let cls="";
    if(minC !== maxC){
      if(Number(o.coef) === maxC) cls="g";
      else if(Number(o.coef) === minC) cls="r";
    }
    const btn=document.createElement("div");
    btn.className="oddBtn "+cls;
    btn.innerHTML=`<div class="oddName">${esc(o.name)}</div><div class="oddCoef">${to2(o.coef)}</div>`;
    btn.onclick=()=>{
      selectedOpt=o;
      [...box.querySelectorAll(".oddBtn")].forEach(x=>x.classList.remove("selected"));
      btn.classList.add("selected");
      sfx(660,0.05,"triangle",0.03);
      updatePotential();
    };
    box.appendChild(btn);
  });
}

$("mConfirm").onclick = async ()=>{
  if(!currentEvent || !selectedOpt) return;
  const stake=Number($("mStake").value);
  toast(`Confirming ${to2(stake)} on ${selectedOpt.name}‚Ä¶`);
  await placeBet(currentEvent, selectedOpt);
};

async function placeBet(ev,opt){
  if(String(ev.status)!=="open") return toast("Event not open");
  if(!meProfile) return toast("Profile not loaded");
  await normalizeMonthForMe();

  const stake=Number($("mStake").value);
  if(!(stake>0)) return toast("Stake must be > 0");
  if(stake<0.01) return toast("Min 0.01");
  if(Number(meProfile.pts)<stake) return toast("Not enough points");

  const chk = await supabase.from("bets").select("id").eq("user_id", session.user.id).eq("event_id", ev.id).limit(1);
  if(!chk.error && chk.data && chk.data.length) return toast("Already bet this event");

  const newPts=clamp2(Number(meProfile.pts)-stake);
  const newLife=clamp2(Number(meProfile.lifetime_wager||0)+stake);
  const newMonth=clamp2(Number(meProfile.month_wager||0)+stake);
  const newLvl=computeLevel(newLife);

  const u1 = await supabase.from("profiles").update({
    pts:newPts, lifetime_wager:newLife, month_wager:newMonth, month_key:monthKey(), level:newLvl
  }).eq("id", session.user.id);
  if(u1.error){ toast("Bet failed (DB/RLS)."); console.error(u1.error); return; }

  const ins = await supabase.from("bets").insert({
    user_id: session.user.id,
    event_id: ev.id,
    option_id: opt.id,
    event_name: ev.name,
    opt_name: opt.name,
    stake: Number(to2(stake)),
    coef: Number(to2(opt.coef)),
    status: "pending",
    payout: 0
  });
  if(ins.error){ toast("Bet insert failed (DB/RLS)."); console.error(ins.error); return; }

  meProfile.pts=newPts; meProfile.lifetime_wager=newLife; meProfile.month_wager=newMonth; meProfile.level=newLvl;
  updateMeUI();
  await loadMyBets();
  toast("Bet placed");
  closeEventModal();
}

/* PROFILE MODAL */
function openProfile(){
  if(!meProfile) return toast("Profile not loaded");
  $("pUserEdit").value = meProfile.display_name||"";
  applyAvatar($("pAvatar"), meProfile.avatar_seed||"p1");
  window.__selectedAvatar = meProfile.avatar_seed||"p1";
  $("pBal").textContent = to2(meProfile.pts||0);
  $("pLevel").textContent = String(meProfile.level||1);
  $("pMonthW").textContent = to2(meProfile.month_wager||0);
  $("pLifeW").textContent = to2(meProfile.lifetime_wager||0);
  $("pBets").textContent = String(myBets.length);
  $("profileOverlay").classList.add("show");
}
function closeProfile(){ $("profileOverlay").classList.remove("show"); }
$("profileBtn").onclick=openProfile;
$("closeProfile").onclick=closeProfile;
$("pCloseBtn").onclick=closeProfile;

document.querySelectorAll('[data-ava]').forEach(btn=>{
  btn.onclick=()=>{
    window.__selectedAvatar = btn.getAttribute("data-ava");
    applyAvatar($("pAvatar"), window.__selectedAvatar);
    toast("Avatar selected");
  };
});
$("pSaveBtn").onclick=async ()=>{
  if(!meProfile) return toast("Profile not loaded");
  const newName = $("pUserEdit").value.trim();
  if(!newName) return toast("Username required");
  const seed = window.__selectedAvatar || (meProfile.avatar_seed||"p1");
  const { error } = await supabase.from("profiles").update({ display_name:newName, avatar_seed:seed }).eq("id", session.user.id);
  if(error){ toast("Save failed (DB/RLS)."); console.error(error); return; }
  meProfile.display_name=newName; meProfile.avatar_seed=seed;
  updateMeUI();
  toast("Profile updated");
};
$("profileOverlay").onclick=(e)=>{ if(e.target===$("profileOverlay")) closeProfile(); };

/* LEADERBOARD */
async function refreshLeaderboard(){
  const cur=monthKey();
  $("lbMonth").textContent=cur;
  const { data, error } = await supabase.from("profiles").select("display_name,month_wager,level,month_key").eq("month_key", cur).order("month_wager",{ascending:false}).limit(50);
  if(error){
    $("lbBody").innerHTML = `<tr><td colspan="4" class="muted">Leaderboard failed (DB/RLS).</td></tr>`;
    console.error(error);
    return;
  }
  const rows=data||[];
  $("chipLb").textContent=String(rows.length);
  $("lbBody").innerHTML = rows.length ? rows.map((r,i)=>`
    <tr>
      <td class="mono">${i+1}</td>
      <td>${esc(r.display_name||"Player")}</td>
      <td class="mono">${to2(r.month_wager||0)}</td>
      <td class="mono">Lv ${Number(r.level||1)}</td>
    </tr>`).join("") : `<tr><td colspan="4" class="muted">No data yet. Place some bets first.</td></tr>`;
}

/* DAILY CASE + COUNTDOWN */
const CASE_ITEMS=[
  {label:"0.01", amount:0.01, iconType:"yellow", p:70},
  {label:"0.03", amount:0.03, iconType:"yellow", p:10},
  {label:"0.05", amount:0.05, iconType:"yellow", p:7.5},
  {label:"0.10", amount:0.10, iconType:"yellow", p:2.5},
  {label:"0.00", amount:0.00, iconType:"poop", p:9},
  {label:"1.00", amount:1.00, iconType:"blue", p:1},
];
function iconFor(t){
  if(t==="yellow") return `<span class="glow">${gemYellow()}</span>`;
  if(t==="blue") return `<span class="glow">${gemBlue()}</span>`;
  return poop();
}
function weightedPick(){
  const r=Math.random()*100; let a=0;
  for(const it of CASE_ITEMS){ a+=it.p; if(r<=a) return it; }
  return CASE_ITEMS[0];
}
function caseEligible(){
  if(!meProfile) return {ok:false, reason:"Profile not loaded"};
  const cur=monthKey();
  const myMonth = ((meProfile.month_key||cur)===cur) ? Number(meProfile.month_wager||0) : 0;
  const hasReq = myMonth>=10;
  const already = String(meProfile.last_case_open||"")===todayISO();
  if(!hasReq && !isAdmin) return {ok:false, reason:"Need 10 wager", myMonth};
  if(already && !isAdmin) return {ok:false, reason:"Already opened today", myMonth};
  return {ok:true, myMonth};
}
function buildCaseStrip(target){
  const arr=[];
  const pre=120, post=50;
  for(let i=0;i<pre;i++) arr.push({ ...CASE_ITEMS[Math.floor(Math.random()*CASE_ITEMS.length)] });
  arr.push({ ...target, __win:true });
  for(let i=0;i<post;i++) arr.push({ ...CASE_ITEMS[Math.floor(Math.random()*CASE_ITEMS.length)] });
  return arr;
}

function renderCaseTrack(items){
  const track=$("caseTrack"); track.innerHTML="";
  items.forEach(it=>{
    const el=document.createElement("div"); el.className="caseItem";
    el.innerHTML = `${iconFor(it.iconType)}<div class="amt">${it.label}</div>`;
    track.appendChild(el);
  });
}

function refreshCaseUI(){
  if(!meProfile){ $("caseStatus").textContent="PROFILE NOT LOADED"; $("openCaseBtn").disabled=true; return; }
  const cur=monthKey();
  const myMonth = ((meProfile.month_key||cur)===cur) ? Number(meProfile.month_wager||0) : 0;
  $("caseReq").textContent = `${to2(myMonth)} / 10.00`;
  const e=caseEligible();
  $("caseStatus").textContent = e.ok ? "READY" : (isAdmin ? "ADMIN" : e.reason.toUpperCase());
  $("openCaseBtn").disabled = !e.ok && !isAdmin;
  $("openCaseBtn").style.opacity = (!e.ok && !isAdmin) ? "0.6" : "1";
}
function updateCaseCountdown(){
  const now = new Date();
  const next = new Date(now);
  next.setHours(24,0,0,0);
  const ms = Math.max(0, next - now);
  const h = Math.floor(ms/3600000);
  const m = Math.floor((ms%3600000)/60000);
  const s = Math.floor((ms%60000)/1000);
  $("caseCountdown").textContent = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}
setInterval(updateCaseCountdown, 1000);
updateCaseCountdown();

let caseSpinning=false;
$("openCaseBtn").onclick=async ()=>{
  if(caseSpinning) return;
  if(!meProfile) return toast("Profile not loaded");
  const elig=caseEligible();
  if(!elig.ok && !isAdmin) return toast("Daily case locked (wager 10)");
  caseSpinning=true;
  const reward=weightedPick();
  const strip=buildCaseStrip(reward);
  renderCaseTrack(strip);

  const track=$("caseTrack");
  track.style.transition="none";
  track.style.transform="translateX(0px)";
  const stage=track.parentElement;
  const itemW=120, gap=14;
  const stageW=stage.clientWidth;
  const lastCenter=20 + (strip.length-1)*(itemW+gap) + itemW/2;
  const targetX=(stageW/2)-lastCenter;

  requestAnimationFrame(()=>{
    track.style.transition="transform 3.4s cubic-bezier(.08,.75,.10,1)";
    track.style.transform=`translateX(${targetX}px)`;
  });

  let t=0; const tm=setInterval(()=>{ t++; sfx(900,0.015,"square",0.05); if(t>70) clearInterval(tm); }, 48);

  setTimeout(async ()=>{
    clearInterval(tm);
    const prize=Number(reward.amount);
    const today=todayISO();
    const newPts=clamp2(Number(meProfile.pts)+prize);
    const { error } = await supabase.from("profiles").update({ pts:newPts, last_case_open: today }).eq("id", session.user.id);
    if(error){ toast("Case payout failed (DB/RLS)."); console.error(error); caseSpinning=false; return; }
    meProfile.pts=newPts; meProfile.last_case_open=today;
    updateMeUI(); refreshCaseUI();
    toast(prize>0 ? `You won ${to2(prize)}` : "You won 0.00");
    caseSpinning=false;
  }, 3600);
};
renderCaseTrack(buildCaseStrip(CASE_ITEMS[0]));

/* ADMIN: USERS */
async function loadUsersList(){
  if(!isAdmin) return;
  const { data, error } = await supabase.from("profiles").select("id,display_name,email,pts").order("created_at",{ascending:true}).limit(200);
  if(error){
    $("adminUserHint").textContent="Cannot load users. Run SQL then Refresh. Users must sign in once to create a profile.";
    console.error(error);
    return;
  }
  usersList=data||[];
  const sel=$("userSelect");
  sel.innerHTML = usersList.length ? usersList.map(u=>`<option value="${u.id}">${esc(u.display_name||"User")} ‚Äî ${esc(u.email||"")}</option>`).join("") : `<option value="">No users</option>`;
  $("adminUserHint").textContent = usersList.length ? `${usersList.length} users loaded` : "No users yet.";
}
function getSelectedUser(){
  const id=$("userSelect").value;
  return usersList.find(u=>u.id===id) || null;
}
$("setPtsBtn").onclick=async ()=>{
  if(!isAdmin) return toast("Admin only");
  const u=getSelectedUser(); if(!u) return toast("Select user");
  const pts=Number($("ptsSet").value); if(!(pts>=0)) return toast("Invalid pts");
  const { error } = await supabase.from("profiles").update({ pts: clamp2(pts) }).eq("id", u.id);
  if(error){ toast("Set failed (DB/RLS)."); console.error(error); return; }
  toast("Points set");
  await loadUsersList();
};
$("addBtn").onclick=async ()=>{
  if(!isAdmin) return toast("Admin only");
  const u=getSelectedUser(); if(!u) return toast("Select user");
  const add=Number($("ptsAdd").value); if(!(add>0)) return toast("Invalid add");
  const newPts=clamp2(Number(u.pts||0)+add);
  const { error } = await supabase.from("profiles").update({ pts:newPts }).eq("id", u.id);
  if(error){ toast("Add failed (DB/RLS)."); console.error(error); return; }
  toast("Added");
  await loadUsersList();
};

/* ADMIN: CREATE EVENT */
let opts=[
  { tmpId: crypto.randomUUID(), name:"Player A", coef:1.80 },
  { tmpId: crypto.randomUUID(), name:"Player B", coef:2.10 }
];
function renderOptRows(){
  const box=$("optsBox"); box.innerHTML="";
  opts.forEach(o=>{
    const row=document.createElement("div"); row.className="row"; row.style.marginBottom="10px";
    row.innerHTML=`
      <div style="flex:1;min-width:220px;"><label>Option name</label><input data-on="${o.tmpId}" value="${esc(o.name)}"/></div>
      <div style="width:200px;"><label>Coef</label><input data-oc="${o.tmpId}" type="number" min="1.01" step="0.01" value="${to2(o.coef)}"/></div>
      <div style="width:160px;"><label>&nbsp;</label><button class="btn red" data-od="${o.tmpId}" style="width:100%;">Remove</button></div>
    `;
    box.appendChild(row);
  });
  box.querySelectorAll("input[data-on]").forEach(inp=>inp.oninput=(e)=>{ const id=e.target.dataset.on; opts=opts.map(o=>o.tmpId===id?({...o,name:e.target.value}):o); });
  box.querySelectorAll("input[data-oc]").forEach(inp=>inp.oninput=(e)=>{ const id=e.target.dataset.oc; const v=Number(e.target.value); if(!(v>=1.01)) return; opts=opts.map(o=>o.tmpId===id?({...o,coef:Number(to2(v))}):o); });
  box.querySelectorAll("button[data-od]").forEach(btn=>btn.onclick=(e)=>{ const id=e.target.dataset.od; opts=opts.filter(o=>o.tmpId!==id); renderOptRows(); });
}
$("addOptBtn").onclick=()=>{ if(!isAdmin) return toast("Admin only"); opts.push({ tmpId:crypto.randomUUID(), name:"", coef:2.00 }); renderOptRows(); };
renderOptRows();

$("createEventBtn").onclick = async () => {
  if (!isAdmin) return toast("Admin only");

  const name = $("evName").value.trim();
  const desc = $("evDesc").value.trim();
  const status = ($("evStatus").value.trim() || "open");

  if (!name) return toast("Event name required");
  if (opts.length < 2) return toast("Need 2+ options");
  for (const o of opts) {
    if (!String(o.name || "").trim()) return toast("Option needs name");
    if (!(Number(o.coef) >= 1.01)) return toast("Coef ‚â• 1.01");
  }

  const normalized = opts.map(o => ({ label: String(o.name).trim(), coef: Number(to2(o.coef)) }));

  try {
    const { data: ev, error: evErr } = await supabase
      .from("events")
      .insert({ name, description: desc, status, created_by: session.user.id })
      .select("id")
      .single();
    if (evErr) throw evErr;

    const rows = normalized.map(o => ({ event_id: ev.id, label: o.label, coef: o.coef }));
    const { error: optErr } = await supabase.from("event_options").insert(rows);
    if (optErr) throw optErr;

    $("evName").value = "";
    $("evDesc").value = "";
    $("evStatus").value = "open";
    opts = [
      { tmpId: crypto.randomUUID(), name: "Player A", coef: 1.80 },
      { tmpId: crypto.randomUUID(), name: "Player B", coef: 2.10 }
    ];
    renderOptRows();

    toast("Event created");
    await loadEvents();
    await loadAdminEvents();
    setView("sports");
  } catch (e) {
    toast("Create failed (DB/RLS).");
    console.error(e);
  }
};

/* ADMIN: MANAGE EVENTS (open/close/finish winner/delete + payout) */
$("reloadAdminEventsBtn").onclick = ()=>loadAdminEvents();

async function loadAdminEvents(){
  if(!isAdmin){ $("adminEventsList").textContent="Admin only."; return; }

  await loadEvents();

  const { data: allBets, error: eB } = await supabase
    .from("bets")
    .select("event_id,status")
    .limit(5000);
  const counts = new Map();
  if(!eB && allBets){
    for(const b of allBets){
      const k=b.event_id;
      if(!counts.has(k)) counts.set(k,{total:0,pending:0,won:0,lost:0});
      const c=counts.get(k);
      c.total++;
      const st=String(b.status||"pending");
      if(st==="pending") c.pending++;
      else if(st==="won") c.won++;
      else if(st==="lost") c.lost++;
    }
  }

  const list = $("adminEventsList");
  if(!events.length){
    list.innerHTML = `<div class="muted">No events.</div>`;
    return;
  }

  list.innerHTML = events.map(ev=>{
    const c = counts.get(ev.id) || {total:0,pending:0,won:0,lost:0};
    const opts = ev.options || [];
    const winnerSel = `
      <select data-win="${ev.id}" style="margin-top:6px;">
        <option value="">‚Äî select winner ‚Äî</option>
        ${opts.map(o=>`<option value="${o.id}" ${Number(ev.winner_option_id||0)===Number(o.id)?"selected":""}>${esc(o.name)} (${to2(o.coef)})</option>`).join("")}
      </select>
    `;
    return `
      <div style="border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);border-radius:16px;padding:12px;margin-bottom:10px;">
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start;">
          <div style="min-width:0;">
            <div style="font-weight:950;">${esc(ev.name)} <span class="chip">${esc(ev.status||"open")}</span></div>
            <div class="muted" style="font-size:12px;margin-top:4px;">${esc(ev.description||"")}</div>
            <div class="muted" style="font-size:12px;margin-top:6px;">
              Bets: <span class="mono">${c.total}</span> (pending <span class="mono">${c.pending}</span>, won <span class="mono">${c.won}</span>, lost <span class="mono">${c.lost}</span>)
            </div>
            <div style="margin-top:8px;">
              <label>Winner</label>
              ${winnerSel}
            </div>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;">
            <button class="btn" data-open="${ev.id}">Set OPEN</button>
            <button class="btn" data-close="${ev.id}">Set CLOSED</button>
            <button class="btn purple" data-finish="${ev.id}">Finish + Payout</button>
            <button class="btn red" data-del="${ev.id}">Delete</button>
          </div>
        </div>
      </div>
    `;
  }).join("");

  list.querySelectorAll("button[data-open]").forEach(b=>b.onclick=async ()=>{
    const id=Number(b.dataset.open);
    const r=await supabase.from("events").update({ status:"open" }).eq("id", id);
    if(r.error){ toast("Failed"); console.error(r.error); return; }
    toast("Event OPEN");
    await loadEvents(); await loadAdminEvents();
  });

  list.querySelectorAll("button[data-close]").forEach(b=>b.onclick=async ()=>{
    const id=Number(b.dataset.close);
    const r=await supabase.from("events").update({ status:"closed" }).eq("id", id);
    if(r.error){ toast("Failed"); console.error(r.error); return; }
    toast("Event CLOSED");
    await loadEvents(); await loadAdminEvents();
  });

  list.querySelectorAll("button[data-del]").forEach(b=>b.onclick=async ()=>{
    const id=Number(b.dataset.del);
    if(!confirm("Delete event? This will also delete its options and bets (because of FK).")) return;
    const r=await supabase.from("events").delete().eq("id", id);
    if(r.error){ toast("Delete failed"); console.error(r.error); return; }
    toast("Deleted");
    await loadEvents(); await loadAdminEvents();
  });

  list.querySelectorAll("button[data-finish]").forEach(b=>b.onclick=async ()=>{
    const evId=Number(b.dataset.finish);
    const winSel = list.querySelector(`select[data-win="${evId}"]`);
    const winnerId = Number(winSel?.value || 0);
    if(!winnerId) return toast("Select a winner first");

    const u = await supabase.from("events").update({ status:"settled", winner_option_id:winnerId }).eq("id", evId);
    if(u.error){ toast("Finish failed"); console.error(u.error); return; }

    const betsR = await supabase.from("bets")
      .select("id,user_id,stake,coef,option_id,status")
      .eq("event_id", evId)
      .eq("status", "pending")
      .limit(5000);
    if(betsR.error){ toast("Cannot load bets"); console.error(betsR.error); return; }
    const bets = betsR.data || [];

    const winners = bets.filter(x=>Number(x.option_id)===winnerId);
    const losers  = bets.filter(x=>Number(x.option_id)!==winnerId);

    if(winners.length){
      for(const w of winners){
        const payout = Number(to2(Number(w.stake)*Number(w.coef)));
        const ub = await supabase.from("bets").update({ status:"won", payout }).eq("id", w.id);
        if(ub.error){ console.error(ub.error); }
        const pr = await supabase.from("profiles").select("pts").eq("id", w.user_id).maybeSingle();
        if(!pr.error && pr.data){
          const newPts = clamp2(Number(pr.data.pts||0) + payout);
          const up = await supabase.from("profiles").update({ pts:newPts }).eq("id", w.user_id);
          if(up.error) console.error(up.error);
        }
      }
    }
    if(losers.length){
      for(const l of losers){
        const ub = await supabase.from("bets").update({ status:"lost", payout:0 }).eq("id", l.id);
        if(ub.error){ console.error(ub.error); }
      }
    }

    toast(`Finished. Paid ${winners.length} winners.`);
    await loadEvents();
    await loadAdminEvents();
    await ensureProfile();
    await loadMyBets();
    updateMeUI();
  });
}

// =======================
// BLACKJACK (Shuffle-style)
// - flip anim, deck dealing, wind trail
// - split, double, stand red
// - standard + side bets (Perfect Pairs, Bust Out)
// - win/lose popup like Mines
// =======================

const BJ = {
  active:false,
  phase:"idle", // idle | player | dealer | settled
  deck:[],
  dealer:[],
  playerHands:[[]], // hand0, hand1 (split)
  activeHand:0,
  stake:0,
  stakePP:0,
  stakeBO:0,
  didDouble:[false,false],
  side:{ ppWin:false, boWin:false, ppPaid:false, boPaid:false },
  settled:false
};

const bjEls = {
  deck: $("bjDeck"),
  dealerCards: $("bjDealerCards"),
  playerCards: $("bjPlayerCards"),
  dealerPts: $("bjDealerPts"),
  playerPts: $("bjPlayerPts"),
  status: $("bjStatus"),
  handLabel: $("bjHandLabel"),
  stake: $("bjStake"),
  pp: $("bjPPStake"),
  bo: $("bjBOStake"),
  deal: $("bjDealBtn"),
  hit: $("bjHitBtn"),
  stand: $("bjStandBtn"),
  dbl: $("bjDoubleBtn"),
  split: $("bjSplitBtn"),
  pop: $("bjCenterPop"),
  popLabel: $("bjPopLabel"),
  popAmt: $("bjPopAmt"),
  popMx: $("bjPopMx"),
  popSub: $("bjPopSub"),
};

function bjToastSafe(msg){
  try{ toast(msg); }catch(_){}
}

// --- SFX (more "casino") ---
function sfxClick(){ sfx(520,0.05,"sine",0.03); }
function sfxDeal(){
  // short "whoosh + click"
  try{
    const ctx = window.__sfxCtx || (window.__sfxCtx = new (window.AudioContext||window.webkitAudioContext)());
    const o=ctx.createOscillator(); const g=ctx.createGain();
    o.type="triangle";
    o.frequency.setValueAtTime(520, ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(220, ctx.currentTime+0.08);
    g.gain.setValueAtTime(0.06, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.10);
    o.connect(g); g.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime+0.11);
  }catch(_){}
}
function sfxFlip(){
  // "snap"
  try{
    const ctx = window.__sfxCtx || (window.__sfxCtx = new (window.AudioContext||window.webkitAudioContext)());
    const o=ctx.createOscillator(); const g=ctx.createGain();
    o.type="square";
    o.frequency.setValueAtTime(980, ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(440, ctx.currentTime+0.06);
    g.gain.setValueAtTime(0.05, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.07);
    o.connect(g); g.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime+0.08);
  }catch(_){}
}
function sfxWin(){
  sfx(880,0.06,"triangle",0.035);
  setTimeout(()=>sfx(1180,0.07,"triangle",0.032), 60);
  setTimeout(()=>sfx(1480,0.08,"triangle",0.030), 120);
}
function sfxLose(){
  try{
    const ctx = window.__sfxCtx || (window.__sfxCtx = new (window.AudioContext||window.webkitAudioContext)());
    const o=ctx.createOscillator(); const g=ctx.createGain();
    o.type="sawtooth";
    o.frequency.setValueAtTime(220, ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(70, ctx.currentTime+0.18);
    g.gain.setValueAtTime(0.07, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.22);
    o.connect(g); g.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime+0.23);
  }catch(_){}
}

// --- Cards ---
const BJ_SUITS = ["‚ô†","‚ô•","‚ô¶","‚ô£"];
function bjBuildDeck(){
  const deck=[];
  for(const s of BJ_SUITS){
    for(let r=1;r<=13;r++){
      deck.push({ r, s });
    }
  }
  // shuffle
  for(let i=deck.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [deck[i],deck[j]]=[deck[j],deck[i]];
  }
  return deck;
}
function bjRankStr(r){
  if(r===1) return "A";
  if(r===11) return "J";
  if(r===12) return "Q";
  if(r===13) return "K";
  return String(r);
}
function bjValueFor(r){
  if(r===1) return 11;        // Ace default 11
  if(r>=10) return 10;
  return r;
}
function bjHandTotal(cards){
  let total=0, aces=0;
  for(const c of cards){
    total += bjValueFor(c.r);
    if(c.r===1) aces++;
  }
  while(total>21 && aces>0){
    total -= 10; // convert Ace 11 -> 1
    aces--;
  }
  return total;
}
function bjIsBlackjack(cards){
  return cards.length===2 && bjHandTotal(cards)===21;
}
function bjCanSplit(hand){
  return hand.length===2 && hand[0].r===hand[1].r;
}

// --- DOM card node (starts face down, flip later) ---
function bjCreateCardNode({ card, faceUp=false }){
  const wrap = document.createElement("div");
  wrap.className = "bjCard" + (faceUp ? " flip" : "");
  const inner = document.createElement("div");
  inner.className="bjCardInner";

  const back=document.createElement("div");
  back.className="bjBack";
  back.innerHTML = `<span>HANDZES.BET</span>`;

  const face=document.createElement("div");
  const red = (card.s==="‚ô•" || card.s==="‚ô¶");
  face.className="bjFace " + (red ? "red":"black");
  const rStr=bjRankStr(card.r);
  face.innerHTML = `
    <div class="top">${rStr}${card.s}</div>
    <div class="mid">${card.s}</div>
    <div class="bot">${rStr}${card.s}</div>
  `;

  inner.appendChild(back);
  inner.appendChild(face);
  wrap.appendChild(inner);
  return wrap;
}

function bjSpawnWind(targetEl, fromDeckEl){
  if(!targetEl || !fromDeckEl) return;
  const tRect = targetEl.getBoundingClientRect();
  const dRect = fromDeckEl.getBoundingClientRect();
  const wx = (dRect.left - tRect.left) * 0.25;
  const wy = (dRect.top - tRect.top) * 0.25;

  const w = document.createElement("div");
  w.className="bjWind";
  w.style.setProperty("--wx", wx.toFixed(1)+"px");
  w.style.setProperty("--wy", wy.toFixed(1)+"px");
  w.style.left = "12px";
  w.style.top  = "18px";
  targetEl.appendChild(w);
  setTimeout(()=>w.remove(), 420);
}

// Deal animation: set CSS vars for "from deck"
function bjAnimateFromDeck(cardEl, containerEl){
  if(!cardEl || !containerEl || !bjEls.deck) return;
  const cRect = containerEl.getBoundingClientRect();
  const dRect = bjEls.deck.getBoundingClientRect();

  const sx = (dRect.left - cRect.left);
  const sy = (dRect.top - cRect.top);

  cardEl.style.setProperty("--sx", sx.toFixed(1)+"px");
  cardEl.style.setProperty("--sy", sy.toFixed(1)+"px");
  cardEl.classList.add("dealIn");

  // wind trail
  bjSpawnWind(containerEl, bjEls.deck);

  setTimeout(()=>cardEl.classList.remove("dealIn"), 500);
}

function bjSetButtons(){
  const canAct = BJ.active && BJ.phase==="player";
  const hand = BJ.playerHands[BJ.activeHand] || [];
  const canSplitNow = canAct && BJ.playerHands.length===1 && bjCanSplit(hand) && !BJ.didDouble[BJ.activeHand];
  const canDoubleNow = canAct && hand.length===2 && !BJ.didDouble[BJ.activeHand];

  bjEls.hit.disabled   = !canAct;
  bjEls.stand.disabled = !canAct;
  bjEls.dbl.disabled   = !canDoubleNow;
  bjEls.split.disabled = !canSplitNow;

  // deal only when idle/settled
  bjEls.deal.disabled = BJ.active;
}

function bjUpdateTotalsUI(){
  const dealerShown = BJ.dealer.map((c,idx)=>{
    // if first dealer card hidden while player phase:
    if(BJ.phase==="player" && idx===0) return null;
    return c;
  }).filter(Boolean);

  const dealerTotal = (BJ.phase==="player")
    ? (dealerShown.length ? bjHandTotal(dealerShown) : 0)
    : bjHandTotal(BJ.dealer);

  const playerTotal = bjHandTotal(BJ.playerHands[BJ.activeHand] || []);

  bjEls.dealerPts.textContent = BJ.dealer.length ? (BJ.phase==="player" ? (dealerShown.length ? String(dealerTotal) : "‚Äî") : String(dealerTotal)) : "‚Äî";
  bjEls.playerPts.textContent = BJ.playerHands[0].length ? String(playerTotal) : "‚Äî";
  bjEls.handLabel.textContent = BJ.playerHands.length>1 ? (BJ.activeHand===0 ? "MAIN" : "SPLIT") : "MAIN";
  bjEls.status.textContent = BJ.active ? (BJ.phase.toUpperCase()) : "‚Äî";
}

function bjClearTable(){
  bjEls.dealerCards.innerHTML="";
  bjEls.playerCards.innerHTML="";
  bjEls.dealerPts.textContent="‚Äî";
  bjEls.playerPts.textContent="‚Äî";
  bjEls.status.textContent="‚Äî";
  bjEls.handLabel.textContent="MAIN";
}

function bjShowPop({ label, amount, deltaText, win=true, sub }){
  const el = bjEls.pop;
  if(!el) return;

  el.classList.remove("hide");
  el.classList.toggle("lose", !win);

  bjEls.popLabel.textContent = label;
  bjEls.popAmt.textContent   = to2(amount);
  bjEls.popMx.textContent    = deltaText || "";
  bjEls.popSub.textContent   = sub || (win ? "added to balance" : "removed from balance");

  el.classList.add("show");
  clearTimeout(el._t);
  el._t = setTimeout(()=>{
    el.classList.add("hide");
    setTimeout(()=>el.classList.remove("show","hide"), 220);
  }, 2200);
}

function bjHidePopImmediate(){
  const el = bjEls.pop;
  if(!el) return;
  clearTimeout(el._t);
  el.classList.remove("hide");
  el.classList.remove("show");
}

async function bjDebitTotalStake(){
  // main stake + side stakes
  const main = Number(bjEls.stake.value || 0);
  const pp   = Number(bjEls.pp.value || 0);
  const bo   = Number(bjEls.bo.value || 0);
  const total = main + pp + bo;

  if(!(main>0)) throw new Error("main_stake");
  if(main < 0.01) throw new Error("min_main");
  if(pp<0 || bo<0) throw new Error("side_invalid");
  if(total <= 0) throw new Error("total_stake");
  if(Number(meProfile?.pts||0) < total) throw new Error("balance");

  // We reuse your wallet/wager function: subtract stake now, payout later.
  await addWagerAndPayout(total, 0);

  BJ.stake = main;
  BJ.stakePP = pp;
  BJ.stakeBO = bo;
}

function bjSideResolvePerfectPairs(){
  // Perfect Pairs: if player's first 2 cards same rank => win (11x stake) (demo)
  if(BJ.side.ppPaid) return 0;
  BJ.side.ppPaid = true;
  const hand = BJ.playerHands[0] || [];
  if(hand.length>=2 && hand[0].r===hand[1].r && BJ.stakePP>0){
    BJ.side.ppWin = true;
    return BJ.stakePP * 11;
  }
  return 0;
}
function bjSideResolveBustOut(dealerBusted){
  // Bust Out: if dealer busts => pays 2x stake (demo)
  if(BJ.side.boPaid) return 0;
  BJ.side.boPaid = true;
  if(dealerBusted && BJ.stakeBO>0){
    BJ.side.boWin = true;
    return BJ.stakeBO * 2;
  }
  return 0;
}

// render player cards (supports split display)
function bjRenderPlayer(){
  bjEls.playerCards.innerHTML="";
  // show both hands if split (stacked)
  if(BJ.playerHands.length===1){
    BJ.playerHands[0].forEach((c, idx)=>{
      const node = bjCreateCardNode({ card:c, faceUp:true });
      bjEls.playerCards.appendChild(node);
    });
  }else{
    // two mini rows inside
    const wrap = document.createElement("div");
    wrap.style.display="grid";
    wrap.style.gridTemplateColumns="1fr";
    wrap.style.gap="10px";
    BJ.playerHands.forEach((hand, hi)=>{
      const row = document.createElement("div");
      row.style.display="flex";
      row.style.flexWrap="wrap";
      row.style.gap="10px";
      row.style.alignItems="center";
      row.style.padding="10px";
      row.style.borderRadius="14px";
      row.style.border="1px solid rgba(255,255,255,.10)";
      row.style.background = hi===BJ.activeHand ? "rgba(255,255,255,.05)" : "rgba(0,0,0,.18)";
      row.innerHTML = `<div class="chip" style="margin-right:10px;">${hi===0?"MAIN":"SPLIT"}</div>`;
      hand.forEach(c=>{
        const node = bjCreateCardNode({ card:c, faceUp:true });
        row.appendChild(node);
      });
      wrap.appendChild(row);
    });
    bjEls.playerCards.appendChild(wrap);
  }
}

function bjRenderDealer({ reveal=false } = {}){
  bjEls.dealerCards.innerHTML="";
  BJ.dealer.forEach((c, idx)=>{
    const faceUp = reveal ? true : !(idx===0); // first card hidden while playing
    const node = bjCreateCardNode({ card:c, faceUp });
    bjEls.dealerCards.appendChild(node);
  });
}

async function bjDealCard(to="player", { faceUp=true } = {}){
  const card = BJ.deck.pop();
  if(!card) BJ.deck = bjBuildDeck();

  const target = (to==="dealer") ? BJ.dealer : BJ.playerHands[BJ.activeHand];
  target.push(card);

  // Create node face down then flip if needed
  const node = bjCreateCardNode({ card, faceUp:false });

  const container = (to==="dealer") ? bjEls.dealerCards : bjEls.playerCards;

  // if player and split layout, render via bjRenderPlayer after push
  if(to==="player" && BJ.playerHands.length>1){
    bjRenderPlayer();
    bjUpdateTotalsUI();
    sfxDeal();
    return;
  }

  container.appendChild(node);
  bjAnimateFromDeck(node, container);
  sfxDeal();

  // flip if faceUp
  if(faceUp){
    setTimeout(()=>{
      node.classList.add("flip");
      sfxFlip();
    }, 140);
  }

  bjUpdateTotalsUI();
}

function bjResetRoundState(){
  BJ.active=false;
  BJ.phase="idle";
  BJ.deck = bjBuildDeck();
  BJ.dealer=[];
  BJ.playerHands=[[]];
  BJ.activeHand=0;
  BJ.didDouble=[false,false];
  BJ.side={ ppWin:false, boWin:false, ppPaid:false, boPaid:false };
  BJ.settled=false;
  BJ.stake=0; BJ.stakePP=0; BJ.stakeBO=0;
}

async function bjStartRound(){
  bjHidePopImmediate();

  if(!meProfile) return bjToastSafe("Profile not loaded");
  if(BJ.active) return;

  try{
    await bjDebitTotalStake();
  }catch(e){
    const msg = String(e);
    if(msg.includes("balance")) return bjToastSafe("Not enough points");
    if(msg.includes("main_stake")) return bjToastSafe("Main stake must be > 0");
    return bjToastSafe("Blackjack: stake error");
  }

  BJ.active=true;
  BJ.phase="player";
  BJ.dealer=[];
  BJ.playerHands=[[]];
  BJ.activeHand=0;
  BJ.didDouble=[false,false];
  BJ.side={ ppWin:false, boWin:false, ppPaid:false, boPaid:false };
  BJ.settled=false;

  bjClearTable();
  bjSetButtons();

  // Initial deal: P D P D (dealer first hidden)
  await bjDealCard("player", { faceUp:true });
  await new Promise(r=>setTimeout(r, 160));
  await bjDealCard("dealer", { faceUp:false });
  await new Promise(r=>setTimeout(r, 160));
  await bjDealCard("player", { faceUp:true });
  await new Promise(r=>setTimeout(r, 160));
  await bjDealCard("dealer", { faceUp:true });

  // Side bet: Perfect Pairs resolves immediately after player has 2 cards
  const sidePP = bjSideResolvePerfectPairs();
  if(sidePP>0){
    // pay side bet instantly (demo feel)
    try{
      const newPts = clamp2(Number(meProfile.pts) + sidePP);
      const { error } = await supabase.from("profiles").update({ pts:newPts }).eq("id", session.user.id);
      if(!error){
        meProfile.pts=newPts; updateMeUI();
        bjShowPop({ label:"PERFECT PAIRS", amount: sidePP, deltaText:`+${to2(sidePP)}`, win:true, sub:"side bet paid" });
        sfxWin();
      }
    }catch(_){}
  }

  // Check blackjack
  const p0 = BJ.playerHands[0];
  const d0 = BJ.dealer;
  const pBJ = bjIsBlackjack(p0);
  const dBJ = bjIsBlackjack(d0);

  if(pBJ || dBJ){
    // Reveal dealer and settle
    BJ.phase="dealer";
    bjRenderDealer({ reveal:true });
    await new Promise(r=>setTimeout(r, 220));
    await bjSettleRound();
    return;
  }

  bjUpdateTotalsUI();
  bjSetButtons();
  bjToastSafe("Blackjack started");
}

function bjCurrentHand(){
  return BJ.playerHands[BJ.activeHand] || [];
}

async function bjHit(){
  if(!BJ.active || BJ.phase!=="player") return;
  await bjDealCard("player", { faceUp:true });

  const total = bjHandTotal(bjCurrentHand());
  if(total>21){
    // bust current hand
    if(BJ.playerHands.length>1 && BJ.activeHand===0){
      BJ.activeHand=1;
      bjRenderPlayer();
      bjUpdateTotalsUI();
      bjSetButtons();
      bjToastSafe("Main hand busted ‚Äî playing split hand");
      return;
    }
    // if split and second bust too -> settle
    await bjSettleRound();
    return;
  }
  bjSetButtons();
}

async function bjStand(){
  if(!BJ.active || BJ.phase!=="player") return;

  // If split and standing on first hand -> switch to second
  if(BJ.playerHands.length>1 && BJ.activeHand===0){
    BJ.activeHand=1;
    bjRenderPlayer();
    bjUpdateTotalsUI();
    bjSetButtons();
    bjToastSafe("Now playing split hand");
    return;
  }

  // go dealer
  BJ.phase="dealer";
  bjRenderDealer({ reveal:true });
  bjUpdateTotalsUI();
  bjSetButtons();
  await new Promise(r=>setTimeout(r, 240));
  await bjDealerPlay();
  await bjSettleRound();
}

async function bjDouble(){
  if(!BJ.active || BJ.phase!=="player") return;
  const hand = bjCurrentHand();
  if(hand.length!==2) return;

  const extra = BJ.stake; // same as main stake
  if(Number(meProfile?.pts||0) < extra) return bjToastSafe("Not enough points to double");

  // debit extra stake immediately, count as wager too
  try{
    await addWagerAndPayout(extra, 0);
  }catch(_){
    return bjToastSafe("Double failed");
  }

  BJ.didDouble[BJ.activeHand]=true;

  // one hit then auto stand (for that hand)
  await bjDealCard("player", { faceUp:true });

  const total = bjHandTotal(bjCurrentHand());
  if(total>21){
    // bust
    if(BJ.playerHands.length>1 && BJ.activeHand===0){
      BJ.activeHand=1;
      bjRenderPlayer();
      bjUpdateTotalsUI();
      bjSetButtons();
      return;
    }
    await bjSettleRound();
    return;
  }

  // act as stand
  await bjStand();
}

async function bjSplit(){
  if(!BJ.active || BJ.phase!=="player") return;
  if(BJ.playerHands.length!==1) return;

  const hand = BJ.playerHands[0];
  if(!bjCanSplit(hand)) return;

  // need another main stake to split
  if(Number(meProfile?.pts||0) < BJ.stake) return bjToastSafe("Not enough points to split");

  try{
    await addWagerAndPayout(BJ.stake, 0);
  }catch(_){
    return bjToastSafe("Split failed");
  }

  // split into two hands
  const c1 = hand[0];
  const c2 = hand[1];
  BJ.playerHands = [[c1],[c2]];
  BJ.activeHand = 0;
  BJ.didDouble=[false,false];

  bjRenderPlayer();
  bjUpdateTotalsUI();

  // deal one card to each hand
  await new Promise(r=>setTimeout(r, 150));
  await bjDealCard("player", { faceUp:true });
  // move to second hand temporarily to deal
  BJ.activeHand=1;
  await new Promise(r=>setTimeout(r, 150));
  await bjDealCard("player", { faceUp:true });
  // back to first hand for play
  BJ.activeHand=0;

  bjRenderPlayer();
  bjUpdateTotalsUI();
  bjSetButtons();
  bjToastSafe("Split activated");
}

async function bjDealerPlay(){
  // dealer hits <=16, stands >=17
  while(true){
    const t = bjHandTotal(BJ.dealer);
    if(t>=17) break;
    await new Promise(r=>setTimeout(r, 260));
    await bjDealCard("dealer", { faceUp:true });
  }
}

function bjHandOutcome(playerCards, dealerCards){
  const p = bjHandTotal(playerCards);
  const d = bjHandTotal(dealerCards);

  if(p>21) return "lose";
  if(d>21) return "win";
  if(p>d) return "win";
  if(p<d) return "lose";
  return "push";
}

async function bjSettleRound(){
  if(!BJ.active || BJ.settled) return;
  BJ.settled=true;
  BJ.phase="settled";
  bjSetButtons();

  // reveal dealer
  bjRenderDealer({ reveal:true });
  bjUpdateTotalsUI();

  const dealerTotal = bjHandTotal(BJ.dealer);
  const dealerBust = dealerTotal>21;

  // Side bet: Bust Out resolves after dealer play
  const sideBO = bjSideResolveBustOut(dealerBust);

  // Main payouts
  let payoutTotal = 0;
  let profitTotal = 0;

  // In split mode, each hand uses main stake (plus double if used)
  for(let hi=0; hi<BJ.playerHands.length; hi++){
    const hand = BJ.playerHands[hi];
    const didD = !!BJ.didDouble[hi];
    const stakeHand = BJ.stake * (didD ? 2 : 1);

    const pBJ = bjIsBlackjack(hand);
    const dBJ = bjIsBlackjack(BJ.dealer);

    let payout = 0;

    if(pBJ && !dBJ){
      // blackjack pays 2.5√ó (demo)
      payout = stakeHand * 2.5;
    }else if(dBJ && !pBJ){
      payout = 0;
    }else{
      const out = bjHandOutcome(hand, BJ.dealer);
      if(out==="win") payout = stakeHand * 2;
      else if(out==="push") payout = stakeHand * 1;
      else payout = 0;
    }

    payoutTotal += payout;
    profitTotal += (payout - stakeHand);
  }

  // add side bet payouts (if any)
  payoutTotal += sideBO;

  // credit payoutTotal to balance
  try{
    const newPts = clamp2(Number(meProfile.pts) + payoutTotal);
    const { error } = await supabase.from("profiles").update({ pts:newPts }).eq("id", session.user.id);
    if(!error){
      meProfile.pts=newPts;
      updateMeUI();
    }
  }catch(e){
    console.error(e);
  }

  // popup: show WON or LOST
  const totalDebited = (BJ.stake + BJ.stakePP + BJ.stakeBO) + (BJ.playerHands.length>1 ? BJ.stake : 0) + (BJ.didDouble[0]?BJ.stake:0) + (BJ.didDouble[1]?BJ.stake:0);
  // NOTE: totalDebited is "approx display"; real debits were done live (deal/split/double).
  const net = (payoutTotal - 0); // payout only; we display net as +/- vs what was risked in main hands
  const label = (payoutTotal>0) ? "YOU WON" : "YOU LOST";

  if(payoutTotal>0){
    bjShowPop({
      label,
      amount: payoutTotal,
      deltaText: `+${to2(payoutTotal)}`,
      win:true,
      sub: (BJ.side.ppWin || BJ.side.boWin) ? "includes side bets" : "added to balance"
    });
    sfxWin();
    // you already have mp3 cashout sound ‚Äì reuse it for "big win"
    try{ sfxCashout(); }catch(_){}
  }else{
    bjShowPop({
      label,
      amount: (BJ.stake||0), // show main stake as "lost" headline
      deltaText: `-${to2(BJ.stake||0)}`,
      win:false,
      sub: "round lost"
    });
    sfxLose();
  }

  BJ.active=false;
  bjSetButtons();
  bjToastSafe("Round settled");
}

// Wire buttons
if(bjEls.deal){
  bjEls.deal.onclick = async ()=>{ sfxClick(); await bjStartRound(); };
  bjEls.hit.onclick  = async ()=>{ sfxClick(); await bjHit(); };
  bjEls.stand.onclick= async ()=>{ sfxClick(); await bjStand(); };
  bjEls.dbl.onclick  = async ()=>{ sfxClick(); await bjDouble(); };
  bjEls.split.onclick= async ()=>{ sfxClick(); await bjSplit(); };

  // init deck once
  BJ.deck = bjBuildDeck();
  bjSetButtons();
  bjClearTable();
}

/* GAMES: Dice / Roulette / Mines */
["diceRollBtn","rouSpinBtn","minesStartBtn","minesCashBtn","openCaseBtn","mConfirm"].forEach(id=>{
  const el=$(id); if(el) el.addEventListener("click", ()=>sfx(520,0.05,"sine",0.03));
});

// Dice
$("diceRollBtn").onclick = async ()=>{
  if(!meProfile) return toast("Profile not loaded");
  const stake=Number($("diceStake").value);
  const pick=$("dicePick").value;
  const roll = Math.floor(Math.random()*100)+1;
  $("diceRollOut").textContent=String(roll);
  const win = (pick==="low") ? (roll<=49) : (roll>=50);
  const mult = 1.95;
  try{
    await addWagerAndPayout(stake, win ? stake*mult : 0);
    $("diceResOut").textContent = win ? `WIN +${to2(stake*mult - stake)}` : "LOSE";
    toast(win ? "Dice win" : "Dice lose");
  }catch(e){
    if(String(e).includes("balance")) toast("Not enough points");
    else toast("Dice error (DB/RLS/SQL)");
    console.error(e);
  }
};

// Roulette
$("rouSpinBtn").onclick = async ()=>{
  if(!meProfile) return toast("Profile not loaded");
  const stake=Number($("rouStake").value);
  const pick=$("rouPick").value;
  const n = Math.floor(Math.random()*37);
  let color = "green";
  if(n===0) color="green";
  else if(n>=1 && n<=18) color="red";
  else color="black";
  $("rouOut").textContent = `${n} (${color})`;
  const mult = (pick==="green") ? 14 : 1.95;
  const win = (pick===color);
  try{
    await addWagerAndPayout(stake, win ? stake*mult : 0);
    $("rouRes").textContent = win ? `WIN +${to2(stake*mult - stake)}` : "LOSE";
    toast(win ? "Roulette win" : "Roulette lose");
  }catch(e){
    if(String(e).includes("balance")) toast("Not enough points");
    else toast("Roulette error (DB/RLS/SQL)");
    console.error(e);
  }
};

// =======================
// =======================
// MINES (UPGRADED)
// - Bombs 1..24
// - True probability multipliers (with house edge)
// - Right ladder UI + animated X
// - Top old multiplier removed; show Current payout instead
// =======================

const MINES_HOUSE_EDGE = 0.01; // 1% house edge (Stake-like feel). Change to 0.04 for 4%.

let mines = {
  active: false,
  bombs: 1,
  stake: 0,
  mult: 1.0,
  bombSet: new Set(),
  revealed: new Set(),   // safe picks only
  ended: false
};

function setMinesUiState(active){
  const startBtn = $("minesStartBtn");
  const cashBtn  = $("minesCashBtn");
  if(!startBtn || !cashBtn) return;

  if(active){
    startBtn.disabled = true;
    startBtn.textContent = "Bet placed ‚úì";
    startBtn.style.opacity = "0.55";
    startBtn.style.cursor = "not-allowed";
    cashBtn.disabled = false;
  } else {
    startBtn.disabled = false;
    startBtn.textContent = "Start";
    startBtn.style.opacity = "1";
    startBtn.style.cursor = "pointer";
    cashBtn.disabled = true;
  }
}

function minesResetUI(){
  const grid = $("minesGrid");
  if(!grid) return;
  grid.innerHTML = "";

  for(let i=0;i<25;i++){
    const b=document.createElement("button");
    b.className="btn";
    b.style.height="70px";
    b.style.borderRadius="16px";
    b.style.background="rgba(0,0,0,.35)";
    // anchor for explosion effects
    b.style.position = "relative";
    b.style.overflow = "visible";
    b.textContent=" ";
    b.onclick=()=>minesPick(i,b);
    grid.appendChild(b);
  }
}

function revealAllMines(){
  const grid = $("minesGrid");
  if(!grid) return;
  const tiles = [...grid.children];
  tiles.forEach((t, idx)=>{
    if(mines.bombSet.has(idx)){
      t.innerHTML = bombRed();
      t.classList.add("minesBombTile","bombHit","bombPulse");
      t.style.position = "relative";
    }
  });
}

function endMinesRound(statusLabel){
  mines.active = false;
  mines.ended = true;
  setMinesUiState(false);
  $("minesStatus").textContent = statusLabel;
}

/* ---------- multipliers (probability-based) ----------
   Fair multiplier after k safe picks:
     1 / P(survive k picks)
   where P(survive k picks) = C(25-bombs, k) / C(25, k)

   Apply house edge:
     mult = fair * (1 - houseEdge)
----------------------------------------------------- */
function minesMultiplier(k, bombs){
  // Stake-like product formula for P(survive k picks):
  // P = Œ†_{i=0..k-1} (safe - i) / (total - i)
  const total = 25;
  const safe = total - bombs;

  if(k <= 0) return 1.00;
  if(k > safe) k = safe;

  let p = 1.0;
  for(let i=0; i<k; i++){
    p *= (safe - i) / (total - i);
  }

  const fair = 1 / Math.max(p, 1e-15);
  const edged = fair * (1 - MINES_HOUSE_EDGE);

  // round to 2 decimals for display
  return Math.max(1.00, Math.round((edged + Number.EPSILON) * 100) / 100);
}

function buildMinesLadder(bombs){
  const safe = 25 - bombs;
  const ladder = [];
  for(let k=1; k<=safe; k++){
    ladder.push({ k, x: minesMultiplier(k, bombs) });
  }
  return ladder;
}

function renderMinesLadder(){
  const bombs = mines.bombs;
  const safe = 25 - bombs;

  $("minesRightBombs").textContent = String(bombs);
  $("minesRightPicks").textContent = String(mines.revealed.size);

  const ladderEl = $("minesLadder");
  const floatEl  = $("minesXFloat");

  if(!ladderEl || !floatEl) return;

  const ladder = buildMinesLadder(bombs);
  ladderEl.innerHTML = "";

  const currentK = mines.revealed.size; // 0..safe
  const currentX = (currentK<=0) ? 1.00 : minesMultiplier(currentK, bombs);

  // floating X (animated bump)
  floatEl.classList.remove("bump");
  void floatEl.offsetWidth; // reflow for restart animation
  floatEl.classList.add("bump");
  floatEl.textContent = `x${to2(currentX)}`;

  ladder.forEach(step=>{
    const row = document.createElement("div");
    row.className = "minesStep" + (step.k === currentK ? " active" : "");
    row.innerHTML = `
      <div class="left">
        <div class="pickNo">${step.k}</div>
        <div class="mx">x${to2(step.x)}</div>
      </div>
      <div class="sub">${step.k===1 ? "1st pick" : `${step.k} picks`}</div>
    `;
    ladderEl.appendChild(row);
  });

  // keep active row in view
  const active = ladderEl.querySelector(".minesStep.active");
  if(active){
    active.scrollIntoView({ block:"nearest", behavior:"smooth" });
  }
}

function updateMinesTopPayout(){
  const stake = Number(mines.stake || $("minesStake").value || 0);
  const x = Number(mines.mult || 1);
  const payout = stake * x;
  $("minesPayoutTop").textContent = stake>0 ? to2(payout) : "‚Äî";
}

let __minesWinTimer = null;

function showMinesPop({ amount, mult=null, win=true }){
  const el = $("minesCenterPop");
  if(!el) return;

  el.classList.remove("hide");
  el.classList.toggle("lose", !win);

  $("minesPopLabel").textContent = win ? "CASHED OUT" : "BOMB";
  $("minesPopAmt").textContent = to2(amount);
  $("minesPopSub").textContent = win ? "added to balance" : "round lost";

  // ‚úÖ multiplier smaller than payout
  const mxEl = $("minesPopMx");
  if(mxEl){
    if(mult == null){
      mxEl.style.display = "none";   // hide if you don't want it
    }else{
      mxEl.style.display = "";
      mxEl.textContent = `x${to2(mult)}`;
    }
  }

  el.classList.add("show");
  clearTimeout(el._t);
  el._t = setTimeout(()=>{
    el.classList.add("hide");
    setTimeout(()=>el.classList.remove("show","hide"), 220);
  }, 2200);
}

function hideMinesPop({ immediate=false } = {}){
  const el = $("minesCenterPop");
  if(!el) return;
  
  clearTimeout(el._t);
  
  if(!el.classList.contains("show")) return;
  
  if(immediate){
    el.classList.remove("hide");
    el.classList.remove("show");
    return;
  }
  
  el.classList.add("hide");
  setTimeout(()=>{
    el.classList.remove("hide");
    el.classList.remove("show");
  }, 220);
}

function spawnSparks(btn, n=10){
  btn.style.position = "relative";
  const total = n;
  for(let i=0;i<total;i++){
    const isDot = Math.random() < 0.35;
    const el = document.createElement("div");
    el.className = isDot ? "sparkDot" : "spark";
    
    const ang = Math.random() * Math.PI * 2;
    const dist = 26 + Math.random() * 34;
    const dx = Math.cos(ang) * dist;
    const dy = Math.sin(ang) * dist;
    
    el.style.setProperty("--dx", dx.toFixed(1) + "px");
    el.style.setProperty("--dy", dy.toFixed(1) + "px");
    el.style.animationDelay = (Math.random()*0.04).toFixed(3) + "s";
    
    btn.appendChild(el);
    setTimeout(()=>el.remove(), 800);
  }
}

// spawn a centered explosion (ring + sparks) on a tile
function spawnExplosionOn(btn){
  if(!btn) return;
  const boom = document.createElement("div");
  boom.className = "boom";

  // 8 sparks around
  for(let i=0;i<8;i++){
    const s = document.createElement("div");
    s.className = "spark";
    s.style.setProperty("--a", (i*45) + "deg");
    boom.appendChild(s);
  }

  btn.appendChild(boom);
  setTimeout(()=>boom.remove(), 520);
}

async function doMinesCashout({ auto=false } = {}){
  if(!mines.active || mines.ended) return;

  const safePicks = mines.revealed.size;
  if(safePicks === 0) return toast("Pick at least 1 tile");

  const payout = mines.stake * mines.mult;

  try{
    const newPts = clamp2(Number(meProfile.pts) + payout);
    const { error } = await supabase
      .from("profiles")
      .update({ pts:newPts })
      .eq("id", session.user.id);
    if(error) throw error;

    meProfile.pts = newPts;
    updateMeUI();
    showMinesPop({ amount: payout, mult: mines.mult, win:true });

    // ‚úÖ play money sound ONCE
    sfxCashout();

    // ‚úÖ reveal bombs after cashout
    revealAllMines();

    toast(auto ? `Auto cashout +${to2(payout)}` : `Cashout +${to2(payout)}`);
    endMinesRound("CASHED");
  }catch(e){
    toast("Cashout failed (DB/RLS)");
    console.error(e);
  }
}

async function minesPick(i, btn){
  if(!mines.active) return toast("Start mines first");
  if(mines.ended) return;
  if(btn.dataset.locked === "1") return;

  btn.dataset.locked = "1";

  // BOMB clicked
  if(mines.bombSet.has(i)){
    // keep tile background normal (no red square)
    btn.style.background = "rgba(0,0,0,.35)";
    btn.style.borderColor = "rgba(255,255,255,.14)";

    // bomb icon glows (not the tile)
    btn.innerHTML = `<div class="bombIcon">üí£</div>`;
    btn.classList.add("bombHit");

    // explosion only on clicked tile
    spawnExplosionOn(btn);

    sfxBomb();

    // reveal other bombs (no explosions for them)
    revealAllMines();
    showMinesPop({ amount: 0, mult: null, win:false });

    endMinesRound("BOMB");
    toast("Boom üí£");
    return;
  }

  // SAFE clicked
  mines.revealed.add(i);
  btn.innerHTML = gemYellowMines();
  btn.style.background="rgba(34,197,94,.10)";
  btn.classList.add("gemHit");
  sfxGem();

  const safePicks = mines.revealed.size;

  // ‚úÖ real multiplier
  mines.mult = minesMultiplier(safePicks, mines.bombs);

  $("minesStatus").textContent = "LIVE";

  // ‚úÖ update right ladder + payout
  renderMinesLadder();
  updateMinesTopPayout();

  // ‚úÖ AUTO CASHOUT when only mines remain
  const totalSafe = 25 - mines.bombs;
  if(safePicks >= totalSafe){
    await doMinesCashout({ auto:true });
  }
}

function fillBombsSelect(){
  const sel = $("minesBombs");
  if(!sel) return;
  sel.innerHTML = "";
  for(let b=1; b<=24; b++){
    const o=document.createElement("option");
    o.value = String(b);
    o.textContent = `${b} bomb${b===1?"":"s"}`;
    sel.appendChild(o);
  }
  sel.value = "1";
}

$("minesStartBtn").onclick = async ()=> {
  hideMinesPop({ immediate:true });
  
  if(!meProfile) return toast("Profile not loaded");
  if(mines.active) return; // already playing

  const stake = Number($("minesStake").value);
  const bombs = Number($("minesBombs").value);

  if(!(stake>0)) return toast("Stake > 0");
  if(stake < 0.01) return toast("Min 0.01");
  if(!(bombs>=1 && bombs<=24)) return toast("Bombs must be 1-24");

  // remove stake now + count wager (your existing logic)
  try{
    await addWagerAndPayout(stake, 0);
  }catch(e){
    if(String(e).includes("balance")) return toast("Not enough points");
    toast("Mines start error (DB/RLS/SQL)");
    console.error(e);
    return;
  }

  // start round
  mines.active = true;
  mines.ended = false;
  mines.bombs = bombs;
  mines.stake = stake;
  mines.revealed = new Set();
  mines.mult = 1.0;

  mines.bombSet = new Set();
  while(mines.bombSet.size < bombs){
    mines.bombSet.add(Math.floor(Math.random()*25));
  }

  minesResetUI();
  $("minesStatus").textContent="LIVE";

  setMinesUiState(true);

  // ‚úÖ init ladder + payout
  renderMinesLadder();
  updateMinesTopPayout();

  toast("Mines started");
};

$("minesCashBtn").onclick = async ()=> {
  if(!mines.active) return toast("No active round");
  await doMinesCashout({ auto:false });
};

// init
fillBombsSelect();
setMinesUiState(false);
minesResetUI();
renderMinesLadder();
$("minesPayoutTop").textContent = "‚Äî";

/* AUTH */
$("btnSignIn").onclick=async ()=>{
  if(!supabase) return;
  const email=$("inEmail").value.trim(); const password=$("inPass").value;
  const { error } = await supabase.auth.signInWithPassword({ email, password });
  if(error) toast(error.message);
};
$("btnForgot").onclick=async ()=>{
  if(!supabase) return;
  const email=$("inEmail").value.trim(); if(!email) return toast("Enter email");
  const { error } = await supabase.auth.resetPasswordForEmail(email);
  if(error) toast(error.message); else toast("Reset email sent");
};
$("btnSignUp").onclick=async ()=>{
  if(!supabase) return;
  const display_name=$("upName").value.trim();
  const email=$("upEmail").value.trim();
  const password=$("upPass").value;
  if(!display_name) return toast("Enter username");
  const { error } = await supabase.auth.signUp({ email, password, options:{ data:{ display_name } } });
  if(error) return toast(error.message);
  toast("Account created. If email confirm is ON, confirm then sign in.");
};

/* buttons */
$("refreshBtn").onclick=async ()=>{
  if(!supabase) return;
  await maybeRollMonth();
  await ensureProfile();
  await normalizeMonthForMe();
  updateMeUI();
  await loadEvents();
  await loadMyBets();
  refreshCaseUI();
  if(isAdmin) await loadAdminEvents();
  toast("Refreshed");
};
$("signOutBtn").onclick=async ()=>{ if(!supabase) return; await supabase.auth.signOut(); };

async function showApp(){
  $("authWrap").classList.remove("show");
  $("app").classList.add("show");
  isAdmin = (session?.user?.email||"").toLowerCase() === ADMIN_EMAIL.toLowerCase();
  await maybeRollMonth();
  await ensureProfile();

  if(meProfile && isAdmin && meProfile.display_name !== ADMIN_DISPLAY_NAME){
    await supabase.from("profiles").update({ display_name: ADMIN_DISPLAY_NAME }).eq("id", session.user.id);
    meProfile.display_name = ADMIN_DISPLAY_NAME;
  }

  await normalizeMonthForMe();
  renderGames();
  updateMeUI();
  await loadEvents();
  await loadMyBets();
  refreshCaseUI();
  if(isAdmin) await loadAdminEvents();
  setView("home");
}
function showAuth(){
  $("app").classList.remove("show");
  $("authWrap").classList.add("show");
}

if(supabase){
  const { data } = await supabase.auth.getSession();
  session=data.session;
  if(session) await showApp(); else showAuth();
  supabase.auth.onAuthStateChange(async (_ev, newSession)=>{
    session=newSession;
    if(session) await showApp(); else showAuth();
  });
} else {
  showAuth();
}
</script>
</body>
</html>